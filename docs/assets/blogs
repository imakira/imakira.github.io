[{"blog/orgx":false,"blog/tags":[],"blog/title":"Watching Files with java.nio.file.WatchService and Clojure","blog/show-toc?":true,"blog/file-path":"/home/void/Projects/imakira.github.io/blogs/watching-files-with-java.nio.file.WatchService-and-clojure.org","blog/author":null,"blog/email":null,"blog/description":"Recently I want to have a utility in Clojure that can notify me when there is a change happened in some specified directory. Fortunately Java seems to nati...","blog/id":"watching-files-with-java-nio-file-watchservice-and-clojure","blog/category":"Coding","blog/language":"en_US","blog/published-date":"2025-12-13T22:18:29+08:00","blog/content":"<p>\nRecently I want to have a utility in Clojure that can notify me when there is a change happened in some specified directory. Fortunately Java seems to natively support it by providing a <code>java.nio.file.WatchService</code>. It seems trivial so I want to use it directly in Clojure instead of adding another dependency to my project. It turns out to be sightly more complicated than I expected. Let me explain.\n</p>\n<div id=\"outline-container-the-problem\" class=\"outline-2\">\n<a href=\"#the-problem\"><h2 id=\"the-problem\" class=\"cr-self-reference \">The Problem</h2></a>\n<div class=\"outline-text-2\" id=\"text-the-problem\">\n<p>\nThe challenge mainly lies in the fact that, Java doesn't natively support recursively watching a directory. If we want this behavoir, we have to implement it ourselves.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">def</span> ^<span class=\"hljs-symbol\">:dynamic</span> <span class=\"hljs-title\">*chan-size*</span> <span class=\"hljs-number\">512</span>)\n\n(<span class=\"hljs-keyword\">defn</span> <span class=\"hljs-title\">register</span> [^Path path ^WatchService watch-service]\n  (<span class=\"hljs-name\">.register</span> path\n             watch-service\n             (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> WatchEvent$Kind\n                         [StandardWatchEventKinds/ENTRY_CREATE\n                          StandardWatchEventKinds/ENTRY_DELETE\n                          StandardWatchEventKinds/ENTRY_MODIFY\n                          StandardWatchEventKinds/OVERFLOW])))\n\n(<span class=\"hljs-keyword\">defn</span> <span class=\"hljs-title\">watch</span> [&amp; paths]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [resp-chan (<span class=\"hljs-name\">a/chan</span> *chan-size*)\n        cancel-chan (<span class=\"hljs-name\">a/chan</span> <span class=\"hljs-number\">1</span>)\n        stopped? (<span class=\"hljs-name\"><span class=\"hljs-built_in\">atom</span></span> <span class=\"hljs-literal\">false</span>)\n\n        worker\n        (<span class=\"hljs-name\"><span class=\"hljs-built_in\">future</span></span>\n          (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [paths (<span class=\"hljs-name\"><span class=\"hljs-built_in\">map</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">fn</span></span> [p]\n                             (<span class=\"hljs-name\">Path/of</span> p (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> String [])))\n                           paths)\n                watch-service (<span class=\"hljs-name\"><span class=\"hljs-built_in\">-&gt;</span></span> (<span class=\"hljs-name\">java.nio.file.FileSystems/getDefault</span>)\n                                  (<span class=\"hljs-name\">.newWatchService</span>))]\n            (<span class=\"hljs-name\"><span class=\"hljs-built_in\">doseq</span></span> [path paths]\n              (<span class=\"hljs-name\"><span class=\"hljs-built_in\">doseq</span></span> [^File subpath-file (<span class=\"hljs-name\">file-seq</span> (<span class=\"hljs-name\">.toFile</span> path))]\n                (<span class=\"hljs-name\"><span class=\"hljs-built_in\">when</span></span> (<span class=\"hljs-name\">.isDirectory</span> subpath-file)\n                  (<span class=\"hljs-name\">register</span> (<span class=\"hljs-name\">.toPath</span> subpath-file)\n                            watch-service))))\n            (<span class=\"hljs-name\"><span class=\"hljs-built_in\">try</span></span>\n              (<span class=\"hljs-name\"><span class=\"hljs-built_in\">while</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">not</span></span> @stopped?)\n                (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [watch-key (<span class=\"hljs-name\">.take</span> watch-service)\n                      events (<span class=\"hljs-name\">.pollEvents</span> watch-key)\n                      ^Path parent-dir (<span class=\"hljs-name\">.watchable</span> watch-key)]\n                  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">doseq</span></span> [^WatchEvent event events]\n                    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [^WatchEvent$Kind kind (<span class=\"hljs-name\">.kind</span> event)\n                          ^Path event-path (<span class=\"hljs-name\">.context</span> event)\n                          ^Path resolved-path (<span class=\"hljs-name\">.resolve</span> parent-dir event-path)]\n                      (<span class=\"hljs-name\">a/&gt;!!</span> resp-chan\n                             {<span class=\"hljs-symbol\">:kind</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">case</span></span> (<span class=\"hljs-name\">.name</span> kind)\n                                      <span class=\"hljs-string\">&quot;ENTRY_CREATE&quot;</span> <span class=\"hljs-symbol\">:entry-create</span>\n                                      <span class=\"hljs-string\">&quot;ENTRY_MODIFY&quot;</span> <span class=\"hljs-symbol\">:entry-modify</span>\n                                      <span class=\"hljs-string\">&quot;ENTRY_DELETE&quot;</span> <span class=\"hljs-symbol\">:entry-delete</span>\n                                      <span class=\"hljs-string\">&quot;OVERFLOW&quot;</span> <span class=\"hljs-symbol\">:overflow</span>)\n                              <span class=\"hljs-symbol\">:path</span> resolved-path})\n\n                      <span class=\"hljs-comment\">;; If the newly created object is a directory,</span>\n                      <span class=\"hljs-comment\">;;   we recursively register files in it.</span>\n                          (<span class=\"hljs-name\"><span class=\"hljs-built_in\">when</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">and</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">=</span></span> kind StandardWatchEventKinds/ENTRY_CREATE)\n                                 (<span class=\"hljs-name\">.isDirectory</span> (<span class=\"hljs-name\">.toFile</span> resolved-path)))\n                        (<span class=\"hljs-name\"><span class=\"hljs-built_in\">doseq</span></span> [^File subpath-file (<span class=\"hljs-name\">file-seq</span> (<span class=\"hljs-name\">.toFile</span> resolved-path))]\n                          (<span class=\"hljs-name\"><span class=\"hljs-built_in\">when</span></span> (<span class=\"hljs-name\">.isDirectory</span> subpath-file)\n                            (<span class=\"hljs-name\">register</span> (<span class=\"hljs-name\">.toPath</span> subpath-file)\n                                      watch-service))))\n                      (<span class=\"hljs-name\">.reset</span> watch-key)))))\n              (<span class=\"hljs-name\">catch</span> InterruptedException _)\n              (<span class=\"hljs-name\">finally</span>\n                (<span class=\"hljs-name\">.close</span> watch-service)))))\n\n        sentinel (<span class=\"hljs-name\"><span class=\"hljs-built_in\">future</span></span>\n                   (<span class=\"hljs-name\"><span class=\"hljs-built_in\">while</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">not</span></span> (<span class=\"hljs-name\">a/&lt;!!</span> cancel-chan)))\n                   (<span class=\"hljs-name\"><span class=\"hljs-built_in\">reset!</span></span> stopped? <span class=\"hljs-literal\">true</span>)\n                   (<span class=\"hljs-name\">future-cancel</span> worker)\n                   (<span class=\"hljs-name\">a/close!</span> resp-chan)\n                   (<span class=\"hljs-name\">a/close!</span> cancel-chan))]\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">with-meta</span></span> [resp-chan cancel-chan]\n      {<span class=\"hljs-symbol\">:debug</span> {<span class=\"hljs-symbol\">:worker</span> worker\n               <span class=\"hljs-symbol\">:sentinel</span> sentinel\n               <span class=\"hljs-symbol\">:stopped?</span> stopped?}})))\n</body></html></code></pre>\n</div>\n\n<p>\nThe initial implementation looks like this, which is fairly straightforward. We start by recursively registering files in the directories provided by <code>paths</code> argument, and if there is a newly created directory, we also recursively register its contents. Clojure provides a <code>file-seq</code> function that makes this task much easier. For an example usage of this code, check the end of this post.\n</p>\n\n<p>\nHowever, there is only one issue: If a file is created in a subdirectory before the subdirectory got registered, the event won't be fired.\n</p>\n\n<pre class=\"example\" id=\"orgaf41e92\">+---------------+\n| worker thread |\n+-------+-------+\n        +                 +---------------+\n        +-----------------| create subdir |\n        |                 +---------------+\n+-------+---------------+\n| event: subdir created |\n+-------+---------------+    \n        |                 +------------------------+\n        +-----------------+ new file in the subdir |\n        |                 +------------------------+\n+-------+-----------+\n| subdir registered |\n+-------------------+\n</pre>\n</div>\n</div>\n<div id=\"outline-container-the-workaround\" class=\"outline-2\">\n<a href=\"#the-workaround\"><h2 id=\"the-workaround\" class=\"cr-self-reference \">The Workaround</h2></a>\n<div class=\"outline-text-2\" id=\"text-the-workaround\">\n<p>\nWe can have a workaround of this by emitting an event of each file in the newly created directory, like this:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-name\"><span class=\"hljs-built_in\">when</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">and</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">=</span></span> kind StandardWatchEventKinds/ENTRY_CREATE)\n           (<span class=\"hljs-name\">.isDirectory</span> (<span class=\"hljs-name\">.toFile</span> resolved-path)))\n\n  (<span class=\"hljs-name\">register</span> resolved-path\n            watch-service)\n\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">doseq</span></span> [^File subpath-file (<span class=\"hljs-name\"><span class=\"hljs-built_in\">rest</span></span> (<span class=\"hljs-name\">file-seq</span> (<span class=\"hljs-name\">.toFile</span> resolved-path)))]\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">when</span></span> (<span class=\"hljs-name\">.isDirectory</span> subpath-file)\n      (<span class=\"hljs-name\">register</span> (<span class=\"hljs-name\">.toPath</span> subpath-file)\n                watch-service))\n    (<span class=\"hljs-name\">a/&gt;!!</span> resp-chan\n           {<span class=\"hljs-symbol\">:kind</span> <span class=\"hljs-symbol\">:entry-create</span>\n            <span class=\"hljs-symbol\">:path</span> (<span class=\"hljs-name\">.toPath</span> subpath-file)})))\n</body></html></code></pre>\n</div>\n\n<p>\nHowever, it introduces a new problem. If a file is created in a subdirectory after be subdirectory is regsitered, but before the subdirectories scanning is finished. The event of the file may be emitted twice.\n</p>\n\n<pre class=\"example\" id=\"org5153e66\">  +---------------+\n  | worker thread |\n  +-------+-------+\n          +                +----------------+\n          +----------------+ subdir created |\n          |                +----------------+\n          |\n +--------+----------+\n | subdir registered |\n +--------+----------+\n          |              +-------------------------+\n          |--------------+ file1 created in subdir |\n          |              +-------------------------+\n +--------+---------+\n | scan: find file1 |\n +--------+---------+  \n          |               \n          |               \n+---------+------------+ \n| event: file1 created |\n+----------------------+      \n</pre>\n\n<p>\nWe have three choices here, we can:\n</p>\n\n<ul class=\"org-ul\">\n<li>ignore this issue, treat it as something acceptable.</li>\n<li>discard the workaround all together, let the user scan if there is any new file in the newly created directory.</li>\n<li>memorize all the files detected, check if the event has already been fired if a new file is detected.</li>\n</ul>\n\n<p>\nIn my case, the first option is good enough, however, it got me curious about how this issue is handled by other projects.\n</p>\n</div>\n</div>\n<div id=\"outline-container-how-is-it-handled-by-other-projects?\" class=\"outline-2\">\n<a href=\"#how-is-it-handled-by-other-projects?\"><h2 id=\"how-is-it-handled-by-other-projects?\" class=\"cr-self-reference \">How is it Handled by Other Projects?</h2></a>\n<div class=\"outline-text-2\" id=\"text-how-is-it-handled-by-other-projects?\">\n</div>\n<div id=\"outline-container-chokidar\" class=\"outline-3\">\n<a href=\"#chokidar\"><h3 id=\"chokidar\" class=\"cr-self-reference \">chokidar</h3></a>\n<div class=\"outline-text-3\" id=\"text-chokidar\">\n<p>\n<a href=\"https://github.com/paulmillr/chokidar\">chokidar</a> is a famous file watching library in JavaScript. It seems to have chosen the third option:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-typescript\"><html><head></head><body><span class=\"hljs-comment\">// handler.ts</span>\n<span class=\"hljs-comment\">// line starting from 575</span>\n\n<span class=\"hljs-comment\">// Files that present in current directory snapshot</span>\n<span class=\"hljs-comment\">// but absent in previous are added to watch list and</span>\n<span class=\"hljs-comment\">// emit `add` event.</span>\n<span class=\"hljs-keyword\">if</span> (item === target || (!target &amp;&amp; !previous.<span class=\"hljs-title function_\">has</span>(item))) {\n  <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">fsw</span>.<span class=\"hljs-title function_\">_incrReadyCount</span>();\n\n  <span class=\"hljs-comment\">// ensure relativeness of path is preserved in case of watcher reuse</span>\n  path = sp.<span class=\"hljs-title function_\">join</span>(dir, sp.<span class=\"hljs-title function_\">relative</span>(dir, path));\n\n  <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">_addToNodeFs</span>(path, initialAdd, wh, depth + <span class=\"hljs-number\">1</span>);\n}\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-inotify-tools\" class=\"outline-3\">\n<a href=\"#inotify-tools\"><h3 id=\"inotify-tools\" class=\"cr-self-reference \">inotify-tools</h3></a>\n<div class=\"outline-text-3\" id=\"text-inotify-tools\">\n<p>\n<a href=\"https://github.com/inotify-tools/inotify-tools\">inotify-tools</a> is a set of cli tools providing interface to <code>inotify</code>. It was written in C++ and newer version is rewritten in Rust.\n</p>\n\n<p>\nBy default, <code>inotify-wait</code> quits after it detected a change. Therefore the problem described in the previous section is naturally up to the user to solve.\n</p>\n\n<p>\nIt also provides an <code>--monitor</code> option to continuously monitoring the changes happened in a directory. With <code>--monitor</code> on, it seems to choose the second option described in the previous section.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-bash\"><html><head></head><body>&gt; inotifywait -mr -e create .\n\nSetting up watches.  Beware: since -r was given, this may take a <span class=\"hljs-keyword\">while</span>!\nWatches established.\n\n<span class=\"hljs-comment\"># executing `mkdir -p s1/s2/s3/s4` in another shell session</span>\n\n./ CREATE,ISDIR s1\nWatching new directory ./s1/\n</body></html></code></pre>\n</div>\n\n<p>\nIf we create the directories one by one, all the directories will be notified. However, by using <code>-p</code> option to create multiple level of directories at once. Only the first one will be notified.\n</p>\n\n<p>\nWe can further confirm it by reading the source code:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-cpp\"><html><head></head><body><span class=\"hljs-comment\">// inotifywait.cpp</span>\n<span class=\"hljs-comment\">// L391, main function</span>\n\n<span class=\"hljs-keyword\">do</span> {\n  event = <span class=\"hljs-built_in\">inotifytools_next_event</span>(timeout);\n\n  <span class=\"hljs-comment\">/*\n   * ......\n   */</span>\n\n  <span class=\"hljs-keyword\">if</span> (monitor &amp;&amp; recursive) {\n    <span class=\"hljs-keyword\">if</span> ((event-&gt;mask &amp; IN_CREATE) ||\n        (!moved_from &amp;&amp; (event-&gt;mask &amp; IN_MOVED_TO))) {\n      <span class=\"hljs-comment\">// New file - if it is a directory, watch it</span>\n      <span class=\"hljs-type\">char</span> *new_file = <span class=\"hljs-built_in\">inotifytools_dirpath_from_event</span>(event);\n      <span class=\"hljs-keyword\">if</span> (new_file &amp;&amp; *new_file &amp;&amp; <span class=\"hljs-built_in\">isdir</span>(new_file)) {\n        <span class=\"hljs-keyword\">if</span> (!quiet) {\n          <span class=\"hljs-built_in\">output_error</span>(sysl, <span class=\"hljs-string\">&quot;Watching new directory %s\\n&quot;</span>, new_file);\n        }\n        <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-built_in\">inotifytools_watch_recursively</span>(new_file, events)) {\n          <span class=\"hljs-built_in\">output_error</span>(sysl, <span class=\"hljs-string\">&quot;Couldn't watch new directory %s: %s\\n&quot;</span>, new_file,\n                       <span class=\"hljs-built_in\">strerror</span>(<span class=\"hljs-built_in\">inotifytools_error</span>()));\n        }\n      }\n      <span class=\"hljs-built_in\">free</span>(new_file);\n    } \n\n    <span class=\"hljs-comment\">/*\n     * ......\n     */</span>\n  }\n  <span class=\"hljs-built_in\">fflush</span>(<span class=\"hljs-literal\">NULL</span>);\n} <span class=\"hljs-keyword\">while</span> (monitor)\n</body></html></code></pre>\n</div>\n\n<p>\nThe program constantly polls and prints new events in the main function. If the newly created object is a directory and <code>--recursive</code> option is on, it recursively watch the newly created directory. However, it won't print files in the new directory if we check the <code>inotifytools_watch_recursively</code> function.\n</p>\n</div>\n</div>\n</div>\n<div id=\"outline-container-conclusion\" class=\"outline-2\">\n<a href=\"#conclusion\"><h2 id=\"conclusion\" class=\"cr-self-reference \">Conclusion</h2></a>\n<div class=\"outline-text-2\" id=\"text-conclusion\">\n<p>\nThere doesn't seem to a definitive solution to this issue. The workaround described in <a href=\"#the-workaround\">section 2</a> seems to be good enough in my case. I will conclude this post by posing a simple example usage of the code with the workaround applied.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-name\">deftest</span> wach_service_example\n  (<span class=\"hljs-name\">testing</span> <span class=\"hljs-string\">&quot;&quot;</span>\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [test-dir (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> *test-dir* <span class=\"hljs-string\">&quot;/example&quot;</span>)]\n      (<span class=\"hljs-name\">.mkdirs</span> (<span class=\"hljs-name\">io/file</span> test-dir))\n      (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [[resp cancel] (<span class=\"hljs-name\">subject/watch</span> test-dir)\n            worker (<span class=\"hljs-name\"><span class=\"hljs-built_in\">future</span></span>\n                     (<span class=\"hljs-name\"><span class=\"hljs-built_in\">loop</span></span> [event (<span class=\"hljs-name\">a/&lt;!!</span> resp)\n                            result (<span class=\"hljs-name\"><span class=\"hljs-built_in\">transient</span></span> [])]\n                       (<span class=\"hljs-name\"><span class=\"hljs-built_in\">if</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">not</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">nil?</span></span> event))\n                         (<span class=\"hljs-name\"><span class=\"hljs-built_in\">recur</span></span> (<span class=\"hljs-name\">a/&lt;!!</span> resp)\n                                (<span class=\"hljs-name\"><span class=\"hljs-built_in\">conj!</span></span> result\n                                       {<span class=\"hljs-symbol\">:kind</span> (<span class=\"hljs-symbol\">:kind</span> event)\n                                        <span class=\"hljs-symbol\">:path</span> (<span class=\"hljs-name\">.toString</span> (<span class=\"hljs-symbol\">:path</span> event))}))\n                         (<span class=\"hljs-name\"><span class=\"hljs-built_in\">persistent!</span></span> result))))]\n        (<span class=\"hljs-name\">.sleep</span> java.util.concurrent.TimeUnit/MILLISECONDS <span class=\"hljs-number\">200</span>)\n        (<span class=\"hljs-name\">.mkdirs</span> (<span class=\"hljs-name\">io/file</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> test-dir <span class=\"hljs-string\">&quot;/s1/s2&quot;</span>)))\n        (<span class=\"hljs-name\">.createNewFile</span> (<span class=\"hljs-name\">io/file</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> test-dir <span class=\"hljs-string\">&quot;/s1/s2/file&quot;</span>)))\n        <span class=\"hljs-comment\">;; We can't delete the files too quickly after they are created,</span>\n        <span class=\"hljs-comment\">;;    otherwise we will receive no event.</span>\n        (<span class=\"hljs-name\">.sleep</span> java.util.concurrent.TimeUnit/MILLISECONDS <span class=\"hljs-number\">200</span>)\n        (<span class=\"hljs-name\"><span class=\"hljs-built_in\">doseq</span></span> [f (<span class=\"hljs-name\"><span class=\"hljs-built_in\">reverse</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">rest</span></span> (<span class=\"hljs-name\">file-seq</span> (<span class=\"hljs-name\">io/file</span> test-dir))))]\n          (<span class=\"hljs-name\">.delete</span> f))\n        (<span class=\"hljs-name\">.sleep</span> java.util.concurrent.TimeUnit/MILLISECONDS <span class=\"hljs-number\">200</span>)\n        <span class=\"hljs-comment\">;; shutdown the watch service</span>\n        (<span class=\"hljs-name\">a/&gt;!!</span> cancel <span class=\"hljs-literal\">true</span>)\n\n        <span class=\"hljs-comment\">;; verify the result</span>\n        (<span class=\"hljs-name\">is</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">=</span></span> [{<span class=\"hljs-symbol\">:kind</span> <span class=\"hljs-symbol\">:entry-create</span><span class=\"hljs-punctuation\">,</span>\t\t  \n                         <span class=\"hljs-symbol\">:path</span> <span class=\"hljs-string\">&quot;test/resource/watch_service_test/example/s1&quot;</span>}\n                        {<span class=\"hljs-symbol\">:kind</span> <span class=\"hljs-symbol\">:entry-create</span><span class=\"hljs-punctuation\">,</span>\n                         <span class=\"hljs-symbol\">:path</span> <span class=\"hljs-string\">&quot;test/resource/watch_service_test/example/s1/s2&quot;</span>}\n                        {<span class=\"hljs-symbol\">:kind</span> <span class=\"hljs-symbol\">:entry-create</span><span class=\"hljs-punctuation\">,</span>\n                         <span class=\"hljs-symbol\">:path</span> <span class=\"hljs-string\">&quot;test/resource/watch_service_test/example/s1/s2/file&quot;</span>}\n                        {<span class=\"hljs-symbol\">:kind</span> <span class=\"hljs-symbol\">:entry-delete</span><span class=\"hljs-punctuation\">,</span>\n                         <span class=\"hljs-symbol\">:path</span> <span class=\"hljs-string\">&quot;test/resource/watch_service_test/example/s1/s2/file&quot;</span>}\n                        {<span class=\"hljs-symbol\">:kind</span> <span class=\"hljs-symbol\">:entry-delete</span><span class=\"hljs-punctuation\">,</span>\n                         <span class=\"hljs-symbol\">:path</span> <span class=\"hljs-string\">&quot;test/resource/watch_service_test/example/s1/s2&quot;</span>}\n                        {<span class=\"hljs-symbol\">:kind</span> <span class=\"hljs-symbol\">:entry-delete</span><span class=\"hljs-punctuation\">,</span>\n                         <span class=\"hljs-symbol\">:path</span> <span class=\"hljs-string\">&quot;test/resource/watch_service_test/example/s1&quot;</span>}]\n               @worker))))))\n</body></html></code></pre>\n</div>\n\n<p>\nYou can also find the source code and some unit tests <a href=\"https://gist.github.com/imakira/4b537a13ecd8c1816427068d10777565\">here</a>.\n</p>\n</div>\n</div>\n","blog/orgx-require":null,"blog/modified-date":"2025-12-13T22:18:29+08:00"},{"blog/orgx":false,"blog/tags":[],"blog/title":"My Experience with lsp-bridge","blog/show-toc?":true,"blog/file-path":"/home/void/Projects/imakira.github.io/blogs/my-experiment-with-lsp-bridge.org","blog/author":null,"blog/email":null,"blog/description":"The experience of using  lsp-mode  or  elgot  depends heavily on the lsp server you are using and the project you are working on. With the newly added JSON...","blog/id":"my-experience-with-lsp-bridge","blog/category":"Coding","blog/language":"en_US","blog/published-date":"2025-11-22T23:33:09+08:00","blog/content":"<p>\nThe experience of using <code>lsp-mode</code> or <code>elgot</code> depends heavily on the lsp server you are using and the project you are working on. With the newly added JSON parser in Emacs 30 and the garbage collecting improvements in the <a href=\"https://github.com/emacs-mirror/emacs/blob/feature/igc/README-IGC\">igc branch</a>, the experience of <code>lsp-mode</code> or <code>eglot</code> can be more than good enough. Still, if you are using the more demanding lsp server (like some language servers for frontend development) or working on a larger-size project, the experience could still be unsatisfying or even super frustrating. If you have ever experienced Emacs freezing after checkout to another git branch or big gc lag when using <code>gcmh-mode</code>, you could still consider giving <code>lsp-bridge</code> a try.\n</p>\n\n<p>\nIn exchange for speed and fluency, <code>lsp-bridge</code> replaces every builtin and well known tools that aren't suitable for async operations, including but not limited to <code>completion-at-point</code>, <code>xref</code>, <code>eldoc</code>. This prevents a lot of users from ever trying it, and that's reasonable. However, the async nature of <code>lsp-bridge</code> also brings its own advantages.\n</p>\n\n<p>\nFor a small example, consider that even the <code>go-to-definition</code> operation in <code>lsp-bridge</code> is asynchronous. With other lsp clients, Emacs is stuck between the time you call <code>xref-find-definitions</code> and the lsp server returns a response. With <code>lsp-bridge</code>, even if you are waiting for a response, Emacs is free to do other things in the meantime, such as doing a garbage collection, or executing a callback registered by <code>run-with-idle-timer</code>.\n</p>\n\n<p>\nFinally, you certainly can use lsp-bridge only for some modes and keep using <code>completion-at-point</code> for other modes. That's also what I'm doing.\n</p>\n<div id=\"outline-container-basic-setup\" class=\"outline-2\">\n<a href=\"#basic-setup\"><h2 id=\"basic-setup\" class=\"cr-self-reference \">Basic Setup</h2></a>\n<div class=\"outline-text-2\" id=\"text-basic-setup\">\n<p>\nTo use <code>lsp-bridge</code>, you first need to install some external dependencies.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-bash\"><html><head></head><body>pip3 install epc orjson sexpdata six setuptools paramiko rapidfuzz watchdog packaging\n</body></html></code></pre>\n</div>\n\n<p>\nIf you are using Nix, you need to add a python package with dependencies to your Nix config files.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-nix\"><html><head></head><body>(python3.withPackages (\n      <span class=\"hljs-params\">ps:</span> <span class=\"hljs-keyword\">with</span> ps; [\n        <span class=\"hljs-comment\"># ...</span>\n        epc\n        orjson\n        packaging\n        paramiko\n        rapidfuzz\n        setuptools\n        sexpdata\n        six\n        watchdog\n      ]\n    ))\n</body></html></code></pre>\n</div>\n\n<p>\nWith external dependencies installed, now we can install the <code>lsp-bridge</code> package. Here's how I have done it with <code>straight</code> and <code>use-package</code>.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-emacs-lisp\"><html><head></head><body>(<span class=\"hljs-name\">use-package</span> lsp-bridge\n  <span class=\"hljs-symbol\">:hook</span>\n  (<span class=\"hljs-name\">clojure-mode</span> . lsp-bridge-mode)\n  (<span class=\"hljs-name\">clojure-ts-mode</span> . lsp-bridge-mode)\n  (<span class=\"hljs-name\">typescript-ts-mode</span> . lsp-bridge-mode)\n  (<span class=\"hljs-name\">js-ts-mode</span> . lsp-bridge-mode)\n  (<span class=\"hljs-name\">java-ts-mode</span> . lsp-bridge-mode)\n  <span class=\"hljs-symbol\">:straight</span> '(lsp-bridge <span class=\"hljs-symbol\">:type</span> git <span class=\"hljs-symbol\">:host</span> github <span class=\"hljs-symbol\">:repo</span> <span class=\"hljs-string\">&quot;manateelazycat/lsp-bridge&quot;</span>\n                         <span class=\"hljs-symbol\">:files</span> (:defaults <span class=\"hljs-string\">&quot;*.el&quot;</span> <span class=\"hljs-string\">&quot;*.py&quot;</span> <span class=\"hljs-string\">&quot;acm&quot;</span> <span class=\"hljs-string\">&quot;core&quot;</span> <span class=\"hljs-string\">&quot;langserver&quot;</span> <span class=\"hljs-string\">&quot;multiserver&quot;</span> <span class=\"hljs-string\">&quot;resources&quot;</span>)\n                         <span class=\"hljs-symbol\">:build</span> (:not compile))\n\n  <span class=\"hljs-symbol\">:init</span>\n  (<span class=\"hljs-name\">defun</span> me/lsp-bridge-corfu-hook ()\n    (<span class=\"hljs-name\">when</span> (<span class=\"hljs-name\">and</span> lsp-bridge-mode\n               (<span class=\"hljs-name\">boundp</span> 'corfu-mode)\n               corfu-mode)\n      (<span class=\"hljs-name\">corfu-mode</span> <span class=\"hljs-number\">-1</span>)))\n  (<span class=\"hljs-name\">add-hook</span> 'corfu-mode-hook #'me/lsp-bridge-corfu-hook))\n</body></html></code></pre>\n</div>\n\n<p>\nHere I only enabled <code>lsp-bridge-mode</code> for modes in the <code>:hook</code> part, and I disabled <code>corfu</code> in <code>lsp-bridge-mode-hook</code> (I'm still using it for other programming or writing tasks).\n</p>\n\n<p>\nUnlike <code>lsp-mode</code>, lsp-bridge doesn't provide a lsp server installation function. Check <a href=\"https://github.com/manateelazycat/lsp-bridge?tab=readme-ov-file#supported-language-servers\">Supported language servers</a> and their corresponding pages for installation methods.\n</p>\n\n<p>\nIf the server is installed and <code>lsp-bridge-mode</code> is enabled, it should just work without any other configurations. If it doesn't, set <code>lsp-bridge-enable-debug</code> to true and check <code>*lsp-bridge*</code> for error messages.\n</p>\n</div>\n</div>\n<div id=\"outline-container-configuration\" class=\"outline-2\">\n<a href=\"#configuration\"><h2 id=\"configuration\" class=\"cr-self-reference \">Configuration</h2></a>\n<div class=\"outline-text-2\" id=\"text-configuration\">\n</div>\n<div id=\"outline-container-keymapping\" class=\"outline-3\">\n<a href=\"#keymapping\"><h3 id=\"keymapping\" class=\"cr-self-reference \">Keymapping</h3></a>\n<div class=\"outline-text-3\" id=\"text-keymapping\">\n<p>\nlsp-bridge provides its xef and eldoc equivalents, but it's up to us to mapping them. Here is what I do just for a reference.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-emacs-lisp\"><html><head></head><body>(<span class=\"hljs-name\">general-evil-define-key</span> '(normal) '(lsp-bridge-mode-map)\n  <span class=\"hljs-string\">&quot;s S&quot;</span> #'lsp-bridge-workspace-list-symbols\n  <span class=\"hljs-string\">&quot;s D&quot;</span> #'lsp-bridge-diagnostic-list\n  <span class=\"hljs-string\">&quot;s R&quot;</span> #'lsp-bridge-rename\n  <span class=\"hljs-string\">&quot;g d&quot;</span> #'lsp-bridge-find-def\n  <span class=\"hljs-string\">&quot;g r&quot;</span> #'lsp-bridge-find-references\n  <span class=\"hljs-string\">&quot;g D&quot;</span> #'lsp-bridge-find-impl\n  <span class=\"hljs-string\">&quot;C-RET&quot;</span> #'lsp-bridge-code-action\n  <span class=\"hljs-string\">&quot;C-&lt;return&gt;&quot;</span> #'lsp-bridge-code-action)\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-a-little-hack-(minimum-popup-width)\" class=\"outline-3\">\n<a href=\"#a-little-hack-(minimum-popup-width)\"><h3 id=\"a-little-hack-(minimum-popup-width)\" class=\"cr-self-reference \">a Little Hack (minimum popup width)</h3></a>\n<div class=\"outline-text-3\" id=\"text-a-little-hack-(minimum-popup-width)\">\n<p>\nIn corfu you can set minimum popup width with <code>corfu-min-width</code>. <code>lsp-bridge~/~acm</code> currently doesn't provide a way to do so. However it is relatively easy to hack one.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-emacs-lisp\"><html><head></head><body>(<span class=\"hljs-name\">setq</span> me/acm-minimum-width <span class=\"hljs-number\">1000</span>)\n\n(<span class=\"hljs-name\">defun</span> me/acm-minimum-width-function (<span class=\"hljs-name\">oldfun</span> <span class=\"hljs-symbol\">&amp;rest</span> r)\n  (<span class=\"hljs-name\">let</span> ((<span class=\"hljs-name\">result</span> (<span class=\"hljs-name\">apply</span> oldfun r)))\n    (<span class=\"hljs-name\">max</span> me/acm-minimum-width result)))\n\n(<span class=\"hljs-name\">advice-add</span> 'acm-menu-max-length <span class=\"hljs-symbol\">:around</span> #'me/acm-minimum-width-function)\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-flymake\" class=\"outline-3\">\n<a href=\"#flymake\"><h3 id=\"flymake\" class=\"cr-self-reference \">flymake</h3></a>\n<div class=\"outline-text-3\" id=\"text-flymake\">\n<p>\nThere is actually a third-party lsp-bridge integration for flymake. Check <a href=\"https://github.com/eki3z/flymake-bridge\">eki3z/flymake-bridge</a>.\n</p>\n</div>\n</div>\n</div>\n<div id=\"outline-container-workspace-management\" class=\"outline-2\">\n<a href=\"#workspace-management\"><h2 id=\"workspace-management\" class=\"cr-self-reference \">Workspace Management</h2></a>\n<div class=\"outline-text-2\" id=\"text-workspace-management\">\n<p>\nlsp-bridge's workspace detection depends entirely on <code>git</code>. It simply use the nearest directory contains <code>.git</code> as the workspace root. This may not be enough for some use cases. However, it provides a <code>lsp-bridge-get-project-path-by-filepath</code> for us to customize. We can implement something similar to what lsp-mode provides fairly easily.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-emacs-lisp\"><html><head></head><body>(<span class=\"hljs-name\">require</span> 'f)\n\n<span class=\"hljs-comment\">;; assume savehist-mode is enabled</span>\n(<span class=\"hljs-name\">defvar</span> me/lsp-bridge-workspaces (<span class=\"hljs-name\">list</span>))\n(<span class=\"hljs-name\">add-to-list</span> 'savehist-additional-variables 'me/lsp-bridge-workspaces)\n\n(<span class=\"hljs-name\">defun</span> me/lsp-bridge-workspace-add (<span class=\"hljs-name\">project-root</span>)\n  (<span class=\"hljs-name\">interactive</span>\n   (<span class=\"hljs-name\">list</span> (<span class=\"hljs-name\">read-directory-name</span> <span class=\"hljs-string\">&quot;Select folder:&quot;</span>)))\n  (<span class=\"hljs-name\">add-to-list</span> 'me/lsp-bridge-workspaces project-root))\n\n(<span class=\"hljs-name\">defun</span> me/lsp-bridge-workspace-remove (<span class=\"hljs-name\">project-root</span>)\n  (<span class=\"hljs-name\">interactive</span> (<span class=\"hljs-name\">list</span> (<span class=\"hljs-name\">completing-read</span> <span class=\"hljs-string\">&quot;Select folder to remove: &quot;</span>\n                                      me/lsp-bridge-workspaces)))\n  (<span class=\"hljs-name\">setq</span> me/lsp-bridge-workspaces (<span class=\"hljs-name\">cl-remove</span> project-root me/lsp-bridge-workspaces <span class=\"hljs-symbol\">:test</span> #'equal)))\n\n(<span class=\"hljs-name\">defun</span> me/lsp-bridge-get-workspace (<span class=\"hljs-name\">path</span>)\n  (<span class=\"hljs-name\">cl-first</span> (<span class=\"hljs-name\">cl-mapcar</span> #'f-expand\n                       (<span class=\"hljs-name\">cl-remove-if-not</span> (<span class=\"hljs-name\">lambda</span> (<span class=\"hljs-name\">workspace</span>)\n                                           (<span class=\"hljs-name\">if</span> (<span class=\"hljs-name\">f-ancestor-of</span>? (<span class=\"hljs-name\">f-expand</span> workspace) path)\n                                                   workspace                                  \n                                             <span class=\"hljs-literal\">nil</span>))\n                                         me/lsp-bridge-workspaces))))\n\n(<span class=\"hljs-name\">setq</span> lsp-bridge-get-project-path-by-filepath #'me/lsp-bridge-get-workspace)\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-working-with-java\" class=\"outline-2\">\n<a href=\"#working-with-java\"><h2 id=\"working-with-java\" class=\"cr-self-reference \">Working with Java</h2></a>\n<div class=\"outline-text-2\" id=\"text-working-with-java\">\n<p>\nWe need a few more lines of configuration to make it works with Java.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-emacs-lisp\"><html><head></head><body>(<span class=\"hljs-name\">use-package</span> lsp-bridge\n  <span class=\"hljs-comment\">;; ...</span>\n  <span class=\"hljs-symbol\">:init</span>\n  (<span class=\"hljs-name\">require</span> 'lsp-bridge-jdtls)\n  (<span class=\"hljs-name\">setq</span> lsp-bridge-enable-auto-import <span class=\"hljs-literal\">t</span>)\n  <span class=\"hljs-comment\">;; ... other configurations</span>\n  )\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-working-with-clojure-and-cider\" class=\"outline-2\">\n<a href=\"#working-with-clojure-and-cider\"><h2 id=\"working-with-clojure-and-cider\" class=\"cr-self-reference \">Working with Clojure and Cider</h2></a>\n<div class=\"outline-text-2\" id=\"text-working-with-clojure-and-cider\">\n<p>\nWhen writing Clojure, I would like to use <code>cider</code> for completion and let lsp handling everything else. With <code>lsp-mode</code> we can just locally set <code>lsp-enable-completion-at-point</code> to false. With <code>lsp-bridge</code>, well, we can disable <code>lsp-bridge</code>'s automatic popup and continue to use corfu.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-emacs-lisp\"><html><head></head><body>(<span class=\"hljs-name\">use-package</span> lsp-bridge\n  <span class=\"hljs-comment\">;; ...</span>\n  <span class=\"hljs-comment\">;; add a new variable</span>\n  (<span class=\"hljs-name\">defvar</span> me/force-corfu <span class=\"hljs-literal\">nil</span>)\n\n  <span class=\"hljs-comment\">;; change the previous hook to this</span>\n  (<span class=\"hljs-name\">defun</span> me/lsp-bridge-corfu-hook ()\n    (<span class=\"hljs-name\">when</span> (<span class=\"hljs-name\">and</span> lsp-bridge-mode\n               (<span class=\"hljs-name\">boundp</span> 'corfu-mode)\n               corfu-mode\n               (<span class=\"hljs-name\">not</span> me/force-corfu))\n      (<span class=\"hljs-name\">corfu-mode</span> <span class=\"hljs-number\">-1</span>))))\n\n(<span class=\"hljs-name\">use-package</span> cider\n  <span class=\"hljs-symbol\">:after</span> lsp-bridge\n  <span class=\"hljs-symbol\">:config</span>\n  (<span class=\"hljs-name\">defun</span> me/lsp-bridge-cider-hook ()\n    (<span class=\"hljs-name\">when</span> cider-mode\n      (<span class=\"hljs-name\">setq-local</span> me/force-corfu <span class=\"hljs-literal\">t</span>)\n      (<span class=\"hljs-name\">setq-local</span> lsp-bridge-complete-manually <span class=\"hljs-literal\">t</span>)\n      (<span class=\"hljs-name\">corfu-mode</span> <span class=\"hljs-number\">1</span>)))\n  (<span class=\"hljs-name\">add-hook</span> 'cider-mode-hook #'me/lsp-bridge-cider-hook <span class=\"hljs-number\">80</span>))\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-conclusion\" class=\"outline-2\">\n<a href=\"#conclusion\"><h2 id=\"conclusion\" class=\"cr-self-reference \">Conclusion</h2></a>\n<div class=\"outline-text-2\" id=\"text-conclusion\">\n<p>\nOverall I would say I'm satisfied with what lsp-bridge provides and amazed at its fluency. I can now load and browse through <a href=\"https://github.com/oracle/graaljs.git\">graaljs</a>'s source code with no stutter, no random freeze I need to <code>C-g</code>, that may or may not work, no nothing. The strategy of off-loading computation to an external process and async everything seems to put very light weight on the Emacs side and work really well.\n</p>\n</div>\n</div>\n","blog/orgx-require":null,"blog/modified-date":"2025-11-25T16:23:27+08:00"},{"blog/orgx":false,"blog/tags":[],"blog/title":"Experiment with GraalVM, Clojure, and JavaScript","blog/show-toc?":true,"blog/file-path":"/home/void/Projects/imakira.github.io/blogs/experiment-with-graalvm-clojure-and-javascript.org","blog/author":null,"blog/email":null,"blog/description":"A common challenge when making a fullstack website using Clojure/ClojureScript is that, we are often required to use a JavaScript library on the server sid...","blog/id":"experiment-with-graalvm--clojure--and-javascript","blog/category":"Coding","blog/language":"en_US","blog/published-date":"2025-11-18T15:03:31+08:00","blog/content":"<p>\nA common challenge when making a fullstack website using Clojure/ClojureScript is that, we are often required to use a JavaScript library on the server side when doing Server Side Rendering (SSR). GraalVM/GraalJS provides a solution to run JavaScript code on the JVM. If only we could harness that powerâ€¦\n</p>\n\n<p>\nThis blog describes the basic usage of GraalJS and what I managed to achieve with GraalJS and Clojure.\n</p>\n<div id=\"outline-container-basic-setup-and-a-hello-world-program\" class=\"outline-2\">\n<a href=\"#basic-setup-and-a-hello-world-program\"><h2 id=\"basic-setup-and-a-hello-world-program\" class=\"cr-self-reference \">Basic Setup and a Hello World Program</h2></a>\n<div class=\"outline-text-2\" id=\"text-basic-setup-and-a-hello-world-program\">\n<p>\nWe add the following dependencies to our <code>deps.edn</code>\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-bash\"><html><head></head><body>:deps {org.clojure/clojure {:mvn/version <span class=\"hljs-string\">&quot;1.11.1&quot;</span>}\n       org.graalvm.polyglot/polyglot {:mvn/version <span class=\"hljs-string\">&quot;25.0.1&quot;</span>}\n       org.graalvm.js/js-language {:mvn/version <span class=\"hljs-string\">&quot;25.0.1&quot;</span>}\n       org.graalvm.truffle/truffle-runtime {:mvn/version <span class=\"hljs-string\">&quot;25.0.1&quot;</span>}}\n</body></html></code></pre>\n</div>\n\n<p>\nWith the dependencies installed, we can write a Hello World program.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-name\"><span class=\"hljs-built_in\">ns</span></span> your-namespace\n  (<span class=\"hljs-symbol\">:import</span>\n   [org.graalvm.polyglot Context]))\n\n\n(<span class=\"hljs-keyword\">defonce</span> ^<span class=\"hljs-symbol\">:dynamic</span> <span class=\"hljs-title\">*context*</span>\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">-&gt;</span></span> (<span class=\"hljs-name\">Context/newBuilder</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> String [<span class=\"hljs-string\">&quot;js&quot;</span>]))\n      (<span class=\"hljs-name\">.build</span>)))\n\n(<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">hello-fn</span> (<span class=\"hljs-name\">.eval</span> *context*\n                     <span class=\"hljs-string\">&quot;js&quot;</span>\n                     <span class=\"hljs-string\">&quot;(function (name) {console.log('hello '+name)})&quot;</span>))\n\n(<span class=\"hljs-name\">.executeVoid</span> hello-fn (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> String [<span class=\"hljs-string\">&quot;world!&quot;</span>])) <span class=\"hljs-comment\">;; output: hello world!</span>\n</body></html></code></pre>\n</div>\n\n<p>\nAll kinds of JavaScript values are represented as <code>org.graalvm.polyglot.Value</code> objects by GraalJS. In the above example the <code>(.eval ...)</code> calling returns a executable <code>polyglot.Value</code>.\n</p>\n\n<p>\nWe can check if it is an executable by calling the <code>.canExecute()</code> method.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-name\">.canExecute</span> hello-fn) <span class=\"hljs-comment\">;; true</span>\n</body></html></code></pre>\n</div>\n\n<p>\nWe can invoke the executable by calling the <code>.execute()</code> method or the <code>.executeVoid()</code> method. Their difference is that latter one doesn't have a return value.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-name\">.executeVoid</span> hello-fn (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> Object [<span class=\"hljs-string\">&quot;world&quot;</span>])) <span class=\"hljs-comment\">;; output: hello world</span>\n\n(<span class=\"hljs-name\">.executeVoid</span> hello-fn (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> Object [<span class=\"hljs-string\">&quot;graaljs&quot;</span>])) <span class=\"hljs-comment\">;; output: hello graaljs</span>\n</body></html></code></pre>\n</div>\n\n<p>\nYou can check if a <code>polyglot.Value</code> object is of a certain type by using methods starting with <code>.is</code>, and convert the <code>Value</code> object to native Java value with methods starting with <code>.as</code>. For example:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">integer-one</span> (<span class=\"hljs-name\">.eval</span> *context* <span class=\"hljs-string\">&quot;js&quot;</span> <span class=\"hljs-string\">&quot;1&quot;</span>)) <span class=\"hljs-comment\">;; #object[org.graalvm.polyglot.Value 0x3583d830 &quot;1&quot;]</span>\n(<span class=\"hljs-name\">.isNumber</span> integer-one) <span class=\"hljs-comment\">;; true</span>\n(<span class=\"hljs-name\">.asLong</span> integer-one) <span class=\"hljs-comment\">;; 1</span>\n(<span class=\"hljs-name\">.isString</span> integer-one) <span class=\"hljs-comment\">;; false</span>\n(<span class=\"hljs-name\">.asString</span> integer-one) <span class=\"hljs-comment\">;; ERROR: Unhandled java.lang.ClassCastException</span>\n</body></html></code></pre>\n</div>\n\n<p>\nTo handle JavaScript objects, we have <code>.newInstance()</code> for instantiating an Object, <code>.invokeMember()</code> for calling a method, <code>.getMemberKeys()</code>, <code>.getMember()</code> and <code>.putMember()</code> for accessing properties of an object.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body><span class=\"hljs-comment\">;; We can access top-level JavaScript variables using the (.getBindings *context* &quot;js&quot;).</span>\n<span class=\"hljs-comment\">;; It returns a polyglot.Value object from which we can retrieve builtin</span>\n<span class=\"hljs-comment\">;;   JavaScript functions and objects.</span>\n(<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">Array</span> (<span class=\"hljs-name\">.getMember</span> (<span class=\"hljs-name\">.getBindings</span> *context* <span class=\"hljs-string\">&quot;js&quot;</span>) <span class=\"hljs-string\">&quot;Array&quot;</span>))\n\n<span class=\"hljs-comment\">;; create an Array</span>\n(<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">arr</span> (<span class=\"hljs-name\">.newInstance</span> Array (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> Object [<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">2</span> <span class=\"hljs-number\">3</span>])))\n\n(<span class=\"hljs-name\">print</span> arr) <span class=\"hljs-comment\">;; #object[org.graalvm.polyglot.Value 0x2dd585ca &quot;(3)[1, 2, 3]&quot;]</span>\n\n<span class=\"hljs-comment\">;; pop a value and cast it to Long</span>\n(<span class=\"hljs-name\">.asLong</span> (<span class=\"hljs-name\">.invokeMember</span> arr <span class=\"hljs-string\">&quot;pop&quot;</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> Object []))) <span class=\"hljs-comment\">;; 3</span>\n\n(<span class=\"hljs-name\">print</span> arr) <span class=\"hljs-comment\">;; #object[org.graalvm.polyglot.Value 0x27e1e162 (2)[1, 2]]</span>\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-working-with-javascript-libraries\" class=\"outline-2\">\n<a href=\"#working-with-javascript-libraries\"><h2 id=\"working-with-javascript-libraries\" class=\"cr-self-reference \">Working With JavaScript Libraries</h2></a>\n<div class=\"outline-text-2\" id=\"text-working-with-javascript-libraries\">\n<p>\nGraalJS has an option to provide a <code>require</code> function, with which we can import CommonJS JavaScript modules. The option isn't enabled by default. To enable it, we need to change the definition of <code>*context*</code> to the following:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">defonce</span> ^<span class=\"hljs-symbol\">:dynamic</span> <span class=\"hljs-title\">*context*</span>\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">-&gt;</span></span> (<span class=\"hljs-name\">Context/newBuilder</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> String ))\n      (<span class=\"hljs-name\">.allowExperimentalOptions</span> <span class=\"hljs-literal\">true</span>)\n      (<span class=\"hljs-name\">.options</span> (<span class=\"hljs-name\">HashMap.</span>\n                 {<span class=\"hljs-string\">&quot;js.commonjs-require&quot;</span> <span class=\"hljs-string\">&quot;true&quot;</span>\n                  <span class=\"hljs-string\">&quot;js.commonjs-require-cwd&quot;</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> (<span class=\"hljs-name\">System/getProperty</span> <span class=\"hljs-string\">&quot;user.dir&quot;</span>)\n                                                 <span class=\"hljs-string\">&quot;/node_modules&quot;</span>)}))\n      (<span class=\"hljs-name\">.allowIO</span> <span class=\"hljs-literal\">true</span>)\n      (<span class=\"hljs-name\">.build</span>)))\n</body></html></code></pre>\n</div>\n\n<p>\nHere we use as <code>commonjs-require-cwd</code>'s value. It tells GraalJS to find JavaScript modules under the <code>node_modules</code> folder in the project root.\n</p>\n\n<p>\nWe can then install JavaScript libraries using npm under the project root. Here I use &quot;luxon&quot; as an example.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-bash\"><html><head></head><body>npm init\nnpm install luxon\n</body></html></code></pre>\n</div>\n\n<p>\nWe can then import the module by using <code>require</code> function.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">luxon</span> (<span class=\"hljs-name\">.eval</span> *context* <span class=\"hljs-string\">&quot;js&quot;</span> <span class=\"hljs-string\">&quot;require('luxon')&quot;</span>))\n</body></html></code></pre>\n</div>\n\n<p>\nWe can access the resulting module with the <code>.getMember()</code> method.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">DateTime</span> (<span class=\"hljs-name\">.getMember</span> luxon <span class=\"hljs-string\">&quot;DateTime&quot;</span>))\n</body></html></code></pre>\n</div>\n\n<p>\nNow we have the <code>DateTime</code> class from the <code>luxon</code> library, let's try to turn it into something useful:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">defn</span> <span class=\"hljs-title\">now</span> []\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">-&gt;</span></span> DateTime\n      <span class=\"hljs-comment\">;; DateTime.now() returns a DateTime object</span>\n      (<span class=\"hljs-name\">.invokeMember</span> <span class=\"hljs-string\">&quot;now&quot;</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> Object []))\n      <span class=\"hljs-comment\">;; We call the .toString method to convert the object</span>\n      <span class=\"hljs-comment\">;;    into a JavaScript String</span>\n          (<span class=\"hljs-name\">.invokeMember</span> <span class=\"hljs-string\">&quot;toString&quot;</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> Object []))\n      <span class=\"hljs-comment\">;; then we convert the result into a Java String</span>\n          (<span class=\"hljs-name\">.asString</span>)))\n\n<span class=\"hljs-comment\">;; Let's try to call the function</span>\n\n(<span class=\"hljs-name\">now</span>) <span class=\"hljs-comment\">;; &quot;2025-11-15T16:56:49.798+08:00&quot;</span>\n(<span class=\"hljs-name\">now</span>) <span class=\"hljs-comment\">;; &quot;2025-11-15T16:57:01.961+08:00&quot;</span>\n\n</body></html></code></pre>\n</div>\n\n<p>\nWe wrapped the details of interop between Clojure and JavaScript in a Clojure function <code>now</code>. Now if we want to get the current time string from the <code>luxon</code> library, we can just call the <code>now</code> function. The interop is still something quite cumbersome to do, however. In this blog I will show you how to turn it into something way more concise using the macros and other facilities provided by Clojure. Here is a glimpse of it:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-name\">js..</span> lux/DateTime now toString) <span class=\"hljs-comment\">;; &quot;2025-11-15T17:04:38.574+08:00&quot;</span>\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-ease-things-with-helper-functions,-macros-and-more\" class=\"outline-2\">\n<a href=\"#ease-things-with-helper-functions,-macros-and-more\"><h2 id=\"ease-things-with-helper-functions,-macros-and-more\" class=\"cr-self-reference \">Ease Things With Helper Functions, Macros and More</h2></a>\n<div class=\"outline-text-2\" id=\"text-ease-things-with-helper-functions,-macros-and-more\">\n<p>\nYou must have noticed the definition of the <code>now</code> function in the previous example is quite clumsy. In ClojureScript we have the following things that can facilitate the interop between ClojureScript and JavaScript\n</p>\n<ul class=\"org-ul\">\n<li>We can require a js module just like a clojure namespace</li>\n<li>A ClojureScript function is just a JavaScript function, we can call JavaScript functions from the ClojureScript side, or we can pass ClojureScript functions to the JavaScript side.</li>\n<li>We have dot macros ( <code>.</code>, <code>..</code> and <code>.-</code> ) and <code>set!</code> to easily access properites or methods of JavaScript objects.</li>\n</ul>\n\n<p>\nTo build something on the same level is probably very hard, however, to build a demonstration of something very similar is indeed very achievable.\n</p>\n</div>\n<div id=\"outline-container-mapping-between-clojure-and-polyglot-values\" class=\"outline-3\">\n<a href=\"#mapping-between-clojure-and-polyglot-values\"><h3 id=\"mapping-between-clojure-and-polyglot-values\" class=\"cr-self-reference \">Mapping between Clojure and Polyglot Values</h3></a>\n<div class=\"outline-text-3\" id=\"text-mapping-between-clojure-and-polyglot-values\">\n<p>\nWe probably don't want to manually convert the result each time we get a value from the JavaScript side as we did in the previous examples. So we would like to put the actual JavaScript functions invoking logics into a wrapper and let the wrapper automatically convert the parameters and the return value for us. To make something like this, and since GraalJS represents each JavaScript value as a Polyglot Value, we first need to establish a mapping between Clojure types and Polyglot Types.\n</p>\n</div>\n<div id=\"outline-container-primitive-types\" class=\"outline-4\">\n<a href=\"#primitive-types\"><h4 id=\"primitive-types\" class=\"cr-self-reference \">Primitive Types</h4></a>\n<div class=\"outline-text-4\" id=\"text-primitive-types\">\n<p>\nEach time we call the <code>.execute()</code> or <code>.invokeMember()</code> method of the <code>polyglot.Value</code> class, GraalJS will convert the arguments using <code>.asValue()</code> method of <code>Context</code> class. However, we are going to wrap Clojure functions as Polyglot functions in the next section. As of now, we write a Clojure -&gt; Polyglot mapping function only calling the <code>.asValue()</code> method.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">defn</span> <span class=\"hljs-title\">polyglotalize-clojure</span> [value]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">cond</span></span>\n    <span class=\"hljs-comment\">;; https://www.graalvm.org/sdk/javadoc/org/graalvm/polyglot/Context.html#asValue(java.lang.Object)</span>\n    <span class=\"hljs-symbol\">:else</span>\n    (<span class=\"hljs-name\">.asValue</span> *context* value)))\n</body></html></code></pre>\n</div>\n\n<p>\nAs for the mapping from <code>polyglot.Value</code> to Clojure values, we use the various checking and converting methods described before.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">defn</span> <span class=\"hljs-title\">clojurify-value</span> [^org.graalvm.polyglot.Value value]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">cond</span></span> (<span class=\"hljs-name\">.isHostObject</span> value)\n        (<span class=\"hljs-name\">.asHostObject</span> value)\n\n        (<span class=\"hljs-name\">.isBoolean</span> value)\n        (<span class=\"hljs-name\">.asBoolean</span> value)\n\n        (<span class=\"hljs-name\">.isNull</span> value)\n        <span class=\"hljs-literal\">nil</span>\n\n        (<span class=\"hljs-name\">.isString</span> value)\n        (<span class=\"hljs-name\">.asString</span> value)\n\n        (<span class=\"hljs-name\">.isNumber</span> value)\n        (<span class=\"hljs-name\"><span class=\"hljs-built_in\">cond</span></span> (<span class=\"hljs-name\">.fitsInLong</span> value)\n              (<span class=\"hljs-name\">.asLong</span> value)\n\n              (<span class=\"hljs-name\">.fitsInDouble</span> value)\n              (<span class=\"hljs-name\">.asDouble</span> value))\n\n        <span class=\"hljs-symbol\">:else</span>\n        value))\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-functions\" class=\"outline-4\">\n<a href=\"#functions\"><h4 id=\"functions\" class=\"cr-self-reference \">Functions</h4></a>\n<div class=\"outline-text-4\" id=\"text-functions\">\n<p>\nGraalVM provides various <code>Proxy</code> objects that we can use to make Clojure objects accessible in the JavaScript environment. To wrap a function, we need to use <code>ProxyExecutable</code>.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">defn</span> <span class=\"hljs-title\">wrap-clojure-fn</span> [f]\n  (<span class=\"hljs-name\">.asValue</span> *context*\n            (<span class=\"hljs-name\"><span class=\"hljs-built_in\">with-meta</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">reify</span></span> org.graalvm.polyglot.proxy.ProxyExecutable\n                         #_{<span class=\"hljs-symbol\">:clj-kondo/ignore</span> [<span class=\"hljs-symbol\">:unused-binding</span>]}\n                         <span class=\"hljs-comment\">;; we ignore `this` for now</span>\n                         (<span class=\"hljs-name\">execute</span> [this ^<span class=\"hljs-string\">&quot;[Lorg.graalvm.polyglot.Value;&quot;</span> values]\n                           (<span class=\"hljs-name\">polyglotalize-clojure</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">apply</span></span> f (<span class=\"hljs-name\"><span class=\"hljs-built_in\">map</span></span> clojurify-value values)))))\n              {<span class=\"hljs-symbol\">::raw-fn</span> f})))\n</body></html></code></pre>\n</div>\n\n<p>\nThe function takes a Clojure function as an argument, returns a Polyglot executable that we can pass to the JavaScript environment.\n</p>\n\n<p>\nIn the function body, we use <code>reify</code> to instantiate an object implementing the <code>ProxyExecutable</code> interface. We implement the <code>.execute()</code> method by applying the clojurified arguments to the original Clojure function, and convert the return value back to a Polyglot value using the two functions we wrote in the <a href=\"#primitive-types\">previous section</a>.\n</p>\n\n<p>\nIn case we want to turn the proxy object back into a clojure function (like when a JavaScript function returns the proxy object as is), we save the original Clojure function into the <a href=\"https://clojure.org/reference/metadata\">metadata</a> of the proxy object using <code>with-meta</code>. In the final step, we turn it into a Polyglot Value using <code>.asValue</code> method from <code>Context</code>.\n</p>\n\n<p>\nWrapping functions from JavaScript follows a similar logic.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">defn</span> <span class=\"hljs-title\">wrap-polyglot-executable</span> [^org.graalvm.polyglot.Value obj]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">with-meta</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">fn</span></span> [&amp; args]\n               (<span class=\"hljs-name\">clojurify-value</span> (<span class=\"hljs-name\">.execute</span> obj (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> Object (<span class=\"hljs-name\"><span class=\"hljs-built_in\">map</span></span> polyglotalize-clojure args)))))\n    {<span class=\"hljs-symbol\">::raw-value</span> obj}))\n</body></html></code></pre>\n</div>\n\n<p>\nHere, we also save a reference to the original JavaScript function in the metadata. However, it serves a much more important role: In JavaScript, a function is like any object, it can have all kinds of properties. Therefore, after wrapping a JavaScript function as a Clojure function, we may still need to access its other properties. To do this, we save the original function in the metadata and retrieve it if necessary.\n</p>\n\n<p>\nWith these two functions defined, we can then augmented our two mapping functions.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">defn</span> <span class=\"hljs-title\">polyglotalize-clojure</span> [value]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">cond</span></span> (<span class=\"hljs-symbol\">::raw-value</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">meta</span></span> value))\n        (<span class=\"hljs-symbol\">::raw-value</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">meta</span></span> value))\n\n        (<span class=\"hljs-name\"><span class=\"hljs-built_in\">fn?</span></span> value)\n        (<span class=\"hljs-name\">wrap-clojure-fn</span> value)\n\n        <span class=\"hljs-symbol\">:else</span>\n        <span class=\"hljs-comment\">;; https://www.graalvm.org/sdk/javadoc/org/graalvm/polyglot/Context.html#asValue(java.lang.Object)</span>\n        (<span class=\"hljs-name\">.asValue</span> *context* value)))\n</body></html></code></pre>\n</div>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">defn</span> <span class=\"hljs-title\">clojurify-value</span> [^org.graalvm.polyglot.Value value]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">cond</span></span>\n\n    (<span class=\"hljs-name\">.isProxyObject</span> value)\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [prox-obj (<span class=\"hljs-name\">.asProxyObject</span> value)]\n      (<span class=\"hljs-name\"><span class=\"hljs-built_in\">if</span></span> (<span class=\"hljs-symbol\">::raw-fn</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">meta</span></span> prox-obj))\n        (<span class=\"hljs-symbol\">::raw-fn</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">meta</span></span> prox-obj))\n        prox-obj))\n\n    <span class=\"hljs-comment\">;;</span>\n    <span class=\"hljs-comment\">;; ... omitted</span>\n    <span class=\"hljs-comment\">;;</span>\n\n    (<span class=\"hljs-name\">.canExecute</span> value) \n    (<span class=\"hljs-name\">wrap-polyglot-executable</span> value)\n\n    <span class=\"hljs-symbol\">:else</span>\n    value))\n</body></html></code></pre>\n</div>\n\n<p>\nWith these two facilities created, we already achieve something very interesting.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">hello</span> (<span class=\"hljs-name\">clojurify-value</span> (<span class=\"hljs-name\">.eval</span> *context* <span class=\"hljs-string\">&quot;js&quot;</span> <span class=\"hljs-string\">&quot;(function (name){console.log(`hello ${name}`)})&quot;</span>)))\n\n(<span class=\"hljs-name\">hello</span> <span class=\"hljs-string\">&quot;world&quot;</span>) <span class=\"hljs-comment\">;; output: hello world</span>\n(<span class=\"hljs-name\">hello</span> <span class=\"hljs-string\">&quot;graaljs&quot;</span>) <span class=\"hljs-comment\">;; output: hello graaljs</span>\n\n(<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">to-array</span> (<span class=\"hljs-name\">clojurify-value</span>\n               (<span class=\"hljs-name\">.eval</span> *context* <span class=\"hljs-string\">&quot;js&quot;</span> <span class=\"hljs-string\">&quot;(function (...args){return Array.from(args);})&quot;</span>)))\n\n(<span class=\"hljs-name\"><span class=\"hljs-built_in\">to-array</span></span> <span class=\"hljs-number\">1</span> <span class=\"hljs-number\">2</span> <span class=\"hljs-number\">3</span> <span class=\"hljs-number\">4</span>) <span class=\"hljs-comment\">;; #object[org.graalvm.polyglot.Value 0x26e3da6b &quot;(4)[1, 2, 3, 4]&quot;]</span>\n\n(<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">join</span> (<span class=\"hljs-name\">clojurify-value</span>\n           (<span class=\"hljs-name\">.eval</span> *context* <span class=\"hljs-string\">&quot;js&quot;</span> <span class=\"hljs-string\">&quot;(function (s, ...args){return args.join(s);})&quot;</span>)))\n\n(<span class=\"hljs-name\">join</span> <span class=\"hljs-string\">&quot;,&quot;</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-number\">2</span> <span class=\"hljs-number\">3</span> <span class=\"hljs-number\">4</span>) <span class=\"hljs-comment\">;; &quot;1,2,3,4&quot;</span>\n</body></html></code></pre>\n</div>\n\n<p>\nAs you have seen, we can now call a JavaScript function just like a Clojure function. Return values of primitive types will also be automatically converted back to Clojure values.\n</p>\n\n<p>\nWe can also pass Clojure functions to the JavaScript side:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">sum-term</span>\n  (<span class=\"hljs-name\">clojurify-value</span>\n   (<span class=\"hljs-name\">.eval</span> *context* <span class=\"hljs-string\">&quot;js&quot;</span> <span class=\"hljs-string\">&quot;let sum = (term, a, b) =&gt; (a&gt;b)? 0 : term(a) + sum(term, a+1,b); sum&quot;</span>)))\n\n<span class=\"hljs-comment\">;; (sum-integers a b) calculate the sum of integers from `a` to `b` (inclusive)</span>\n(<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">sum-integers</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">partial</span></span> sum-term identity))\n(<span class=\"hljs-name\">sum-integers</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">10</span>) <span class=\"hljs-comment\">;; 55</span>\n\n<span class=\"hljs-comment\">;; (sum-cubes a b) calculates the sum of cubes of integers from `a` to `b` (inclusive)</span>\n(<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">sum-cubes</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">partial</span></span> sum-term (<span class=\"hljs-name\"><span class=\"hljs-built_in\">fn</span></span> [x] (<span class=\"hljs-name\"><span class=\"hljs-built_in\">*</span></span> x x x))))\n(<span class=\"hljs-name\">sum-cubes</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">10</span>) <span class=\"hljs-comment\">;; 3025</span>\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-mapping_objects\" class=\"outline-4\">\n<a href=\"#mapping_objects\"><h4 id=\"mapping_objects\" class=\"cr-self-reference \">Objects</h4></a>\n<div class=\"outline-text-4\" id=\"text-mapping_objects\">\n<p>\nRougly similar to ClojureScript, We don't do mapping for objects other than those of primitives types and functions. However, in the <code>clojurify-value</code> function, we wrap all JavaScript functions into Clojure functions and save the reference in the metadata, and as I have explained there, a JavaScript function may have other properties we want to access. Thus, in each place where a Clojure function wrapping a JavaScript function can be taken as arguments, we cannot use methods from <code>polyglot.Value</code>. Instead, we define helper functions that will wrap the arguments if necessary and then call the target method.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">defn</span> <span class=\"hljs-title\">polyglot-value</span> [obj]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">or</span></span> (<span class=\"hljs-symbol\">::raw-value</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">meta</span></span> obj))\n      (<span class=\"hljs-name\"><span class=\"hljs-built_in\">and</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">instance?</span></span> org.graalvm.polyglot.Value obj)\n           obj)))\n\n(<span class=\"hljs-keyword\">defn-</span> <span class=\"hljs-title\">to-camel-style</span> [s]\n  (<span class=\"hljs-name\">string/replace</span> s <span class=\"hljs-regex\">#&quot;-([a-z])&quot;</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">fn</span></span> [g]\n                                  (<span class=\"hljs-name\">.toUpperCase</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">second</span></span> g)))))\n\n(<span class=\"hljs-keyword\">defmacro</span> <span class=\"hljs-title\">define-unwrap-executable-alias</span>\n  {<span class=\"hljs-symbol\">:clj-kondo/lint-as</span> 'clojure.core/declare}\n  [name &amp; args]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [docstring? (<span class=\"hljs-name\"><span class=\"hljs-built_in\">string?</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">first</span></span> args))\n        docstring (<span class=\"hljs-name\"><span class=\"hljs-built_in\">when</span></span> docstring? (<span class=\"hljs-name\"><span class=\"hljs-built_in\">first</span></span> args))\n        args (<span class=\"hljs-name\"><span class=\"hljs-built_in\">if</span></span> docstring? (<span class=\"hljs-name\"><span class=\"hljs-built_in\">second</span></span> args) (<span class=\"hljs-name\"><span class=\"hljs-built_in\">first</span></span> args))\n        obj 'obj\n        [arglist [_ vararg]] (<span class=\"hljs-name\"><span class=\"hljs-built_in\">split-with</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">fn</span></span> [x] (<span class=\"hljs-name\"><span class=\"hljs-built_in\">not</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">=</span></span> x '&amp;))) args)] \n    `(<span class=\"hljs-keyword\">defn</span> ~<span class=\"hljs-title\">name</span> {<span class=\"hljs-symbol\">:doc</span> ~docstring} [~obj ~@arglist ~@(<span class=\"hljs-name\"><span class=\"hljs-built_in\">if</span></span> vararg `[&amp; ~vararg] [])]\n       (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [~obj (<span class=\"hljs-name\"><span class=\"hljs-built_in\">or</span></span> (<span class=\"hljs-name\">polyglot-value</span> ~obj)\n                      ~obj)]\n         (~(<span class=\"hljs-name\"><span class=\"hljs-built_in\">symbol</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> <span class=\"hljs-string\">&quot;.&quot;</span> (<span class=\"hljs-name\">to-camel-style</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> name))))\n          ~obj \n          ~@arglist\n          ~@(<span class=\"hljs-name\"><span class=\"hljs-built_in\">if</span></span> vararg\n              [`(<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> Object ~vararg)]\n              []))))))\n\n(<span class=\"hljs-name\">define-unwrap-executable-alias</span> get-meta-object)\n(<span class=\"hljs-name\">define-unwrap-executable-alias</span> is-meta-object)\n(<span class=\"hljs-name\">define-unwrap-executable-alias</span> get-meta-qualified-name)\n(<span class=\"hljs-name\">define-unwrap-executable-alias</span> has-meta-parents)\n(<span class=\"hljs-name\">define-unwrap-executable-alias</span> has-array-elements)\n(<span class=\"hljs-name\">define-unwrap-executable-alias</span> get-meta-parents)\n(<span class=\"hljs-name\">define-unwrap-executable-alias</span> get-member [^String identifier])\n(<span class=\"hljs-name\">define-unwrap-executable-alias</span> put-member [^String identifier ^Object value])\n(<span class=\"hljs-name\">define-unwrap-executable-alias</span> get-member-keys)\n(<span class=\"hljs-name\">define-unwrap-executable-alias</span> new-instance [&amp; args])\n(<span class=\"hljs-name\">define-unwrap-executable-alias</span> can-invoke-member [^String s])\n(<span class=\"hljs-name\">define-unwrap-executable-alias</span> invoke-member [^String method &amp; args])\n(<span class=\"hljs-name\">define-unwrap-executable-alias</span> can-instantiate)\n(<span class=\"hljs-name\">define-unwrap-executable-alias</span> canExecute)\n(<span class=\"hljs-name\">define-unwrap-executable-alias</span> execute [&amp; args])\n(<span class=\"hljs-name\">define-unwrap-executable-alias</span> executeVoid [&amp; args])\n</body></html></code></pre>\n</div>\n\n<p>\nWe wrote a macro for this purpose. The macro takes a function name and a parameter list as arguments and defines a function with the name and parameters.\nThe function defined by the macro retrieves the reference from the metadata if necessary, then calls a method by the name converted from the function name and with arguments from the parameter list.\n</p>\n\n<p>\nOne nice bonus is that the generated functions assembles all the variadic arguments into an <code>Object[]</code>, saving us from calling <code>(into-arry Object)</code> manually if we need to call a method with variadic arguments.\n</p>\n\n<p>\nPreviously we need to do this:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-name\">.newInstance</span> (<span class=\"hljs-name\">.eval</span> *context* <span class=\"hljs-string\">&quot;js&quot;</span> <span class=\"hljs-string\">&quot;Array&quot;</span>) (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> Object [<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">2</span> <span class=\"hljs-number\">3</span>]))\n<span class=\"hljs-comment\">;; #object[org.graalvm.polyglot.Value 0x65b337ef &quot;(3)[1, 2, 3]&quot;]</span>\n</body></html></code></pre>\n</div>\n\n<p>\nNow we just need to do this:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-name\">new-instance</span> (<span class=\"hljs-name\">.eval</span> *context* <span class=\"hljs-string\">&quot;js&quot;</span> <span class=\"hljs-string\">&quot;Array&quot;</span>) <span class=\"hljs-number\">1</span> <span class=\"hljs-number\">2</span> <span class=\"hljs-number\">3</span>)\n<span class=\"hljs-comment\">;; #object[org.graalvm.polyglot.Value 0xfdabe76 &quot;(3)[1, 2, 3]&quot;]</span>\n</body></html></code></pre>\n</div>\n</div>\n</div>\n</div>\n<div id=\"outline-container-dot-macros-and-~set!~\" class=\"outline-3\">\n<a href=\"#dot-macros-and-~set!~\"><h3 id=\"dot-macros-and-~set!~\" class=\"cr-self-reference \">Dot Macros and <code>set!</code></h3></a>\n<div class=\"outline-text-3\" id=\"text-dot-macros-and-~set!~\">\n<p>\nIn ClojureScript we have dots special forms or macros like <code>.</code>,  <code>.-</code> and <code>..</code> for accessing properties or calling methods of JavaScript objects.\n</p>\n\n<p>\nWe can relatively easily implement them using macros.\n</p>\n\n<blockquote>\n<p>\nThere are also <code>(.method obj)</code> <code>(.-property obj)</code> as shorthands for <code>(. obj method)</code> and <code>(.- obj property)</code> in ClojureScript. However, implementing them would be really difficult if not impossible.\n</p>\n</blockquote>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">defmacro</span> <span class=\"hljs-title\">js.</span>\n  {<span class=\"hljs-symbol\">:clj-kondo/ignore</span> [<span class=\"hljs-symbol\">:unresolved-symbol</span> <span class=\"hljs-symbol\">:type-mismatch</span>]}\n  [obj method &amp; args]\n  `(<span class=\"hljs-name\">clojurify-value</span>\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">apply</span></span> invoke-member ~obj ~(<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> method)\n           <span class=\"hljs-comment\">;; evaluate args before passing them to polyglotalize-clojure</span>\n           (<span class=\"hljs-name\"><span class=\"hljs-built_in\">map</span></span> polyglotalize-clojure (<span class=\"hljs-name\"><span class=\"hljs-built_in\">list</span></span> ~@args)))))\n\n\n(<span class=\"hljs-keyword\">defmacro</span> <span class=\"hljs-title\">js.-</span>\n  {<span class=\"hljs-symbol\">:clj-kondo/ignore</span> [<span class=\"hljs-symbol\">:unresolved-symbol</span> <span class=\"hljs-symbol\">:type-mismatch</span>]}\n  [obj field]\n  `(<span class=\"hljs-name\">#'clojurify-value</span> (<span class=\"hljs-name\">get-member</span> ~obj ~(<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> field))))\n</body></html></code></pre>\n</div>\n\n<p>\nThe <code>invoke-member</code> and <code>get-member</code> helper functions are defined in the <a href=\"#mapping_objects\">previous section</a>.\n</p>\n\n<p>\nWith these two defined, we can write the more complicated macro <code>js..</code> based on them.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">defmacro</span> <span class=\"hljs-title\">js..</span>\n  {<span class=\"hljs-symbol\">:clj-kondo/ignore</span> [<span class=\"hljs-symbol\">:unresolved-symbol</span> <span class=\"hljs-symbol\">:type-mismatch</span>]}\n  [obj &amp; args]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">if</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">empty?</span></span> args)\n    obj\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [curr# (<span class=\"hljs-name\"><span class=\"hljs-built_in\">first</span></span> args)\n          rest# (<span class=\"hljs-name\"><span class=\"hljs-built_in\">rest</span></span> args)]\n      `(<span class=\"hljs-name\">js..</span> ~(<span class=\"hljs-name\"><span class=\"hljs-built_in\">cond</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">seq?</span></span> curr#)\n                    `(<span class=\"hljs-name\">js.</span> ~obj ~(<span class=\"hljs-name\"><span class=\"hljs-built_in\">first</span></span> curr#) ~@(<span class=\"hljs-name\"><span class=\"hljs-built_in\">rest</span></span> curr#))\n\n                    (<span class=\"hljs-name\">.startsWith</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> curr#)\n                                 <span class=\"hljs-string\">&quot;-&quot;</span>)\n                    `(<span class=\"hljs-name\">js.-</span> ~obj ~(<span class=\"hljs-name\">subs</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> curr#) <span class=\"hljs-number\">1</span>))\n\n                    <span class=\"hljs-symbol\">:else</span>\n                    `(<span class=\"hljs-name\">js.</span> ~obj ~curr#))\n         ~@rest#))))\n</body></html></code></pre>\n</div>\n\n<p>\nFinally, we will implement the <code>set!</code> macro.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">defmacro</span> <span class=\"hljs-title\">js-set!</span> [dot-form value]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">assert</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">seq?</span></span> dot-form) <span class=\"hljs-string\">&quot;First argument must be in the form of `(js.. obj -field)` or (js.- obj field)&quot;</span>)\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [[op &amp; args] dot-form]\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">assert</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">or</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">=</span></span> op 'js..)\n                (<span class=\"hljs-name\"><span class=\"hljs-built_in\">=</span></span> op 'js.-))\n            <span class=\"hljs-string\">&quot;First argument to js-set! must start with either `js..` or `js.-`&quot;</span>)\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [remove-hyphen (<span class=\"hljs-name\"><span class=\"hljs-built_in\">=</span></span> op 'js..)\n          lst (<span class=\"hljs-name\"><span class=\"hljs-built_in\">last</span></span> args)\n          last-removed (<span class=\"hljs-name\"><span class=\"hljs-built_in\">drop-last</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into</span></span> [op] args))]\n      `(<span class=\"hljs-name\">put-member</span> ~(<span class=\"hljs-name\"><span class=\"hljs-built_in\">if</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">=</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">count</span></span> last-removed) <span class=\"hljs-number\">2</span>)\n                      (<span class=\"hljs-name\"><span class=\"hljs-built_in\">second</span></span> last-removed)\n                      last-removed)\n                   ~(<span class=\"hljs-name\"><span class=\"hljs-built_in\">if</span></span> remove-hyphen\n                      (<span class=\"hljs-name\">subs</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> lst) <span class=\"hljs-number\">1</span>)\n                      (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> lst))\n                   ~value))))\n</body></html></code></pre>\n</div>\n\n<p>\nLet's go back to the <code>luxon</code> example mentioned in the beginning of this blog and check what we can do with these newly defined tools.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">luxon</span> (<span class=\"hljs-name\">.eval</span> *context* <span class=\"hljs-string\">&quot;js&quot;</span> <span class=\"hljs-string\">&quot;require('luxon')&quot;</span>))\n\n(<span class=\"hljs-name\">js..</span> luxon -DateTime now toString) <span class=\"hljs-comment\">;; &quot;2025-11-14T16:48:11.324+08:00&quot;</span>\n</body></html></code></pre>\n</div>\n\n<p>\nCompare it to the snippet I showed at the end of the first section:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-name\">js..</span> lux/DateTime now toString)\n</body></html></code></pre>\n</div>\n\n<p>\nThe only thing lacking is a <code>require</code> mechanism, which is what we are going to implement in the next section.\n</p>\n</div>\n</div>\n<div id=\"outline-container-~require~-command\" class=\"outline-3\">\n<a href=\"#~require~-command\"><h3 id=\"~require~-command\" class=\"cr-self-reference \"><code>require</code> command</h3></a>\n<div class=\"outline-text-3\" id=\"text-~require~-command\">\n<p>\nOn the JavaScript side, the <code>require()</code> function returns an object from which we can access its exported variables or functions.\n</p>\n\n<p>\nOn the Clojure side, we can dynamically create a namespace with the <code>create-ns</code> function. After that we can make all the variables from the module object accessible in the newly created namespace with the <code>intern</code> function.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">defn-</span> <span class=\"hljs-title\">require-module</span> [name]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">-&gt;</span></span> *context*\n      (<span class=\"hljs-name\">.eval</span> <span class=\"hljs-string\">&quot;js&quot;</span>\n             (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> <span class=\"hljs-string\">&quot;require('&quot;</span> name <span class=\"hljs-string\">&quot;')&quot;</span>))))\n\n(<span class=\"hljs-keyword\">defn-</span> <span class=\"hljs-title\">parse-flags</span> [args]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">loop</span></span> [args (<span class=\"hljs-name\"><span class=\"hljs-built_in\">lazy-seq</span></span> args)\n         result (<span class=\"hljs-name\"><span class=\"hljs-built_in\">hash-map</span></span>)]\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">if</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">empty?</span></span> args)\n      result\n      (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [curr (<span class=\"hljs-name\"><span class=\"hljs-built_in\">first</span></span> args)\n            rst (<span class=\"hljs-name\"><span class=\"hljs-built_in\">rest</span></span> args)]\n        (<span class=\"hljs-name\"><span class=\"hljs-built_in\">if</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">or</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">keyword?</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">first</span></span> rst))\n                (<span class=\"hljs-name\"><span class=\"hljs-built_in\">empty?</span></span> rst))\n          (<span class=\"hljs-name\"><span class=\"hljs-built_in\">recur</span></span> rst (<span class=\"hljs-name\"><span class=\"hljs-built_in\">assoc</span></span> result curr <span class=\"hljs-literal\">true</span>))\n          (<span class=\"hljs-name\"><span class=\"hljs-built_in\">recur</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">rest</span></span> rst)\n                 (<span class=\"hljs-name\"><span class=\"hljs-built_in\">assoc</span></span> result curr (<span class=\"hljs-name\"><span class=\"hljs-built_in\">first</span></span> rst))))))))\n\n(<span class=\"hljs-keyword\">defn-</span> <span class=\"hljs-title\">normalize-module-name</span> [name]\n  (<span class=\"hljs-name\">s/replace</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> name) <span class=\"hljs-regex\">#&quot;/&quot;</span> <span class=\"hljs-string\">&quot;.&quot;</span>))\n\n(<span class=\"hljs-keyword\">defn</span> <span class=\"hljs-title\">require-js</span>\n  {<span class=\"hljs-symbol\">:clj-kondo/lint-as</span> 'clojure.core/require}\n  [[module-name &amp; flags] &amp; coll]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [flag-map (<span class=\"hljs-name\">parse-flags</span> flags)\n        module (<span class=\"hljs-name\">require-module</span> module-name)\n        alias-name (<span class=\"hljs-symbol\">:as</span> flag-map)\n        qualified-module-name (<span class=\"hljs-name\"><span class=\"hljs-built_in\">symbol</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> <span class=\"hljs-string\">&quot;js4clj.modules.&quot;</span> (<span class=\"hljs-name\">normalize-module-name</span> module-name)))]\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">create-ns</span></span> qualified-module-name)\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">doseq</span></span> [k (<span class=\"hljs-name\">.getMemberKeys</span> module)]\n      (<span class=\"hljs-name\"><span class=\"hljs-built_in\">intern</span></span> qualified-module-name\n              (<span class=\"hljs-name\"><span class=\"hljs-built_in\">symbol</span></span> k)\n              (<span class=\"hljs-name\">clojurify-value</span> (<span class=\"hljs-name\">.getMember</span> module k))))\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">when</span></span> alias-name\n      (<span class=\"hljs-name\"><span class=\"hljs-built_in\">alias</span></span> alias-name qualified-module-name)))\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">when</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">seq</span></span> coll)\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">apply</span></span> require-js coll)))\n</body></html></code></pre>\n</div>\n\n<p>\n<code>(require-js '[luxon :as lux])</code> is now all we need to require a JavaScript module.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-name\">require-js</span> '[luxon <span class=\"hljs-symbol\">:as</span> lux])\n\n(<span class=\"hljs-name\">js..</span> lux/DateTime now toString) <span class=\"hljs-comment\">;; &quot;2025-11-14T17:08:40.045+08:00&quot;</span>\n</body></html></code></pre>\n</div>\n\n<p>\nLet's try some more examples:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-name\">js..</span> lux/DateTime (<span class=\"hljs-name\">fromISO</span> <span class=\"hljs-string\">&quot;2017-05-15T08:30:00&quot;</span>) -year) <span class=\"hljs-comment\">;; 2017</span>\n\n<span class=\"hljs-comment\">;; or write it as</span>\n(<span class=\"hljs-name\"><span class=\"hljs-built_in\">-&gt;</span></span> lux/DateTime\n    (<span class=\"hljs-name\">js.</span> fromISO <span class=\"hljs-string\">&quot;2017-05-15T08:30:00&quot;</span>)\n    (<span class=\"hljs-name\">js.-</span> year)) <span class=\"hljs-comment\">;; 2017</span>\n\n(<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [now (<span class=\"hljs-name\">js.</span> lux/DateTime now)\n      later (<span class=\"hljs-name\">js.</span> lux/DateTime local <span class=\"hljs-number\">2026</span> <span class=\"hljs-number\">10</span> <span class=\"hljs-number\">12</span>)\n      i (<span class=\"hljs-name\">js.</span> lux/Interval fromDateTimes now later)]\n  (<span class=\"hljs-name\">js.</span> i length <span class=\"hljs-string\">&quot;years&quot;</span>)) <span class=\"hljs-comment\">;; 0.904136850298072</span>\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-bonus:-special-~js~-namespace\" class=\"outline-3\">\n<a href=\"#bonus:-special-~js~-namespace\"><h3 id=\"bonus:-special-~js~-namespace\" class=\"cr-self-reference \">Bonus: Special <code>js</code> namespace</h3></a>\n<div class=\"outline-text-3\" id=\"text-bonus:-special-~js~-namespace\">\n<p>\nClojureScript provides us a <a href=\"https://cljs.github.io/api/syntax/js-namespace\">special <code>js</code> namespace</a>, from where we can use various JavaScript global objects. We can also implement something like that.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">def</span> ^<span class=\"hljs-symbol\">:dynamic</span> <span class=\"hljs-title\">*no-clojurify*</span> <span class=\"hljs-literal\">false</span>)\n\n(<span class=\"hljs-keyword\">defn-</span> <span class=\"hljs-title\">define-builtin</span> [ns primitive &amp; [alias]]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">intern</span></span> ns (<span class=\"hljs-name\"><span class=\"hljs-built_in\">if</span></span> alias (<span class=\"hljs-name\"><span class=\"hljs-built_in\">symbol</span></span> alias) (<span class=\"hljs-name\"><span class=\"hljs-built_in\">symbol</span></span> primitive))\n          ((<span class=\"hljs-name\"><span class=\"hljs-built_in\">if</span></span> *no-clojurify* identity clojurify-value)\n           (<span class=\"hljs-name\">.eval</span> *context* <span class=\"hljs-string\">&quot;js&quot;</span> primitive))))\n\n(<span class=\"hljs-keyword\">defmacro</span> <span class=\"hljs-title\">define-builtins</span>\n  {<span class=\"hljs-symbol\">:clj-kondo/lint-as</span> 'clojure.core/declare}\n  [ns &amp; primitives]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">create-ns</span></span> ns)\n  `(<span class=\"hljs-name\"><span class=\"hljs-built_in\">doseq</span></span> [primitive# '~primitives]\n     (<span class=\"hljs-name\">define-builtin</span> '~ns (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> primitive#))))\n\n<span class=\"hljs-comment\">;; In cljs there is also a js/undefined</span>\n<span class=\"hljs-comment\">;;\tin which (= nil js/undefined) but we can't mimic it.</span>\n<span class=\"hljs-comment\">;; Still, we need a js/undefined in case we need to do some</span>\n<span class=\"hljs-comment\">;; \tvery specific interop.</span>\n(<span class=\"hljs-name\"><span class=\"hljs-built_in\">declare</span></span> undefined)\n(<span class=\"hljs-name\">with-bindings</span> {#'*no-clojurify* <span class=\"hljs-literal\">true</span>}\n  (<span class=\"hljs-name\">define-builtin</span> 'js <span class=\"hljs-string\">&quot;undefined&quot;</span> <span class=\"hljs-string\">&quot;undefined&quot;</span>))\n\n#_{<span class=\"hljs-symbol\">:clojure-lsp/ignore</span> [<span class=\"hljs-symbol\">:clojure-lsp/unused-public-var</span>]}\n(<span class=\"hljs-name\">define-builtins</span> js\n  globalThis\n  Infinity\n  NaN\n  Object\n  Function\n  Boolean\n  Symbol\n  Error\n  Number\n  BigInt\n  Math\n  Date\n  String\n  Array\n  Map\n  Set\n  WeakMap\n  WeakSet\n  JSON\n  ArrayBuffer\n  Promise\n  console)\n</body></html></code></pre>\n</div>\n\n<p>\nWe took a special handling of <code>js/undefined</code> (note when we clojurify JavaScript values, we turn both <code>null</code> and <code>undefined</code> into <code>nil</code>), since a direct equivalent of <code>undefined</code> in JavaScript may be needed for some interops. However, <code>js/undefined</code> In ClojureScript has some special properties we can't replicate, most notably, <code>(nil? js/undefined)</code> and <code>(= js/undefined nil)</code> results in <code>true</code> in ClojureScript.\n</p>\n</div>\n</div>\n</div>\n<div id=\"outline-container-limitations\" class=\"outline-2\">\n<a href=\"#limitations\"><h2 id=\"limitations\" class=\"cr-self-reference \">Limitations</h2></a>\n<div class=\"outline-text-2\" id=\"text-limitations\">\n</div>\n<div id=\"outline-container-functionalities-specific-to-an-environment\" class=\"outline-3\">\n<a href=\"#functionalities-specific-to-an-environment\"><h3 id=\"functionalities-specific-to-an-environment\" class=\"cr-self-reference \">Functionalities specific to an environment</h3></a>\n<div class=\"outline-text-3\" id=\"text-functionalities-specific-to-an-environment\">\n<p>\nJavaScript packages are often written under the assumption that, the code will either run on a Browser or a node.js environment. Unfortunately, GraalJS only implements the ECMAScript specification, which means we have neither functions specific to node.js nor functions specific to a browser.\n</p>\n\n<p>\nFor example, we don't have <code>WebWorker</code> api from the browser, nor <code>process</code>, <code>fs</code> api from node.js.\n</p>\n</div>\n</div>\n<div id=\"outline-container-multithreading-and-the-~js~-namespace\" class=\"outline-3\">\n<a href=\"#multithreading-and-the-~js~-namespace\"><h3 id=\"multithreading-and-the-~js~-namespace\" class=\"cr-self-reference \">Multithreading and the <code>js</code> namespace</h3></a>\n<div class=\"outline-text-3\" id=\"text-multithreading-and-the-~js~-namespace\">\n<p>\nWhen writing programs in Java, we usually use blocking operations and multithreading. However, <code>polyglot.Context</code> is not thread-safe. It isn't a problem in itself, since we can spin up multiple contexts. However, variables in <code>js</code> refer to variables in a specific context. Thus, if we want to use multiple contexts, we cannot refer to variables in the <code>js</code> namespace with the current settings. We may be able to mitigate or solve this problem with dynamic bindings or using a dedicated thread for JavaScript operations.\n</p>\n</div>\n</div>\n<div id=\"outline-container-shorthands-for-dot-macros\" class=\"outline-3\">\n<a href=\"#shorthands-for-dot-macros\"><h3 id=\"shorthands-for-dot-macros\" class=\"cr-self-reference \">Shorthands for dot macros</h3></a>\n<div class=\"outline-text-3\" id=\"text-shorthands-for-dot-macros\">\n<p>\nWe have already talked about it in the <a href=\"#dot-macros-and-~set!~\">Dot Macros</a> section. In ClojureScript we can <code>(ClassName.)</code> for instantiate an instance or <code>(.method obj)</code> for invoking an method. Implementing them would be really hard if not impossible.\n</p>\n</div>\n</div>\n<div id=\"outline-container-importing-ecmascript-modules\" class=\"outline-3\">\n<a href=\"#importing-ecmascript-modules\"><h3 id=\"importing-ecmascript-modules\" class=\"cr-self-reference \">Importing ECMAScript Modules</h3></a>\n<div class=\"outline-text-3\" id=\"text-importing-ecmascript-modules\">\n<p>\nThe <code>require-js</code> function can only import CommonJS modules. More and more projects are choosing ECMAScript modules over CommonJS modules these days. However, implementing an importing mechanism for ECMAScript modules is entirely feasible. GraalJS provides a <code>js.esm-eval-returns-exports</code> option, with this option enabled, we can import a ECMAScript module by loading the source file. However, it will take some time to write support for things like <code>exports</code> fields in <code>package.json</code>.\n</p>\n</div>\n</div>\n<div id=\"outline-container-using-javascript-array-in-clojure\" class=\"outline-3\">\n<a href=\"#using-javascript-array-in-clojure\"><h3 id=\"using-javascript-array-in-clojure\" class=\"cr-self-reference \">Using JavaScript array in Clojure</h3></a>\n<div class=\"outline-text-3\" id=\"text-using-javascript-array-in-clojure\">\n<p>\nIn ClojureScript, many times we can use a JavaScript array just like a ClojureScript vector (not vice versa though).\nWe haven't implement something similar to this.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body><span class=\"hljs-comment\">;; ClojureScript</span>\n(<span class=\"hljs-name\"><span class=\"hljs-built_in\">map</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">fn</span></span> [x] (<span class=\"hljs-name\"><span class=\"hljs-built_in\">*</span></span> x <span class=\"hljs-number\">2</span>)) #js [<span class=\"hljs-number\">1</span> <span class=\"hljs-number\">2</span> <span class=\"hljs-number\">3</span>])\n<span class=\"hljs-comment\">;; (2 4 6)</span>\n</body></html></code></pre>\n</div>\n</div>\n</div>\n</div>\n<div id=\"outline-container-to-be-continue...\" class=\"outline-2\">\n<a href=\"#to-be-continue...\"><h2 id=\"to-be-continue...\" class=\"cr-self-reference \">To Be Continueâ€¦</h2></a>\n<div class=\"outline-text-2\" id=\"text-to-be-continue...\">\n<p>\nDespite the limitations, I still believe this approach is something worth exploring. I'm planning on making an isomorphic React demonstration with Server Side Rendering and Client Side Rehydration using only a thin wrapper over React and React DOM Server (instead of reimplementing the SSR logics on the JVM). The code presented here is also expanded and refined when I'm writing the blog, and the code is open sourced at <a href=\"https://github.com/imakira/js4clj\">imakira/js4clj</a>.\n</p>\n</div>\n</div>\n","blog/orgx-require":null,"blog/modified-date":"2025-11-18T15:03:31+08:00"},{"blog/orgx":false,"blog/tags":[],"blog/title":"Build a ClojureScript Application Running on Node Using Nix","blog/show-toc?":true,"blog/file-path":"/home/void/Projects/imakira.github.io/blogs/build-a-clojurescript-application-running-on-node-using-nix.org","blog/author":null,"blog/email":null,"blog/description":"To build a ClojureScript application, we need to pull dependencies from two package managers. That is, JavaScript packages from  npm  and Clojure packages ...","blog/id":"build-a-clojurescript-application-running-on-node-using-nix","blog/category":"Coding","blog/language":"en_US","blog/published-date":"2025-11-03T17:25:27+08:00","blog/content":"<p>\nTo build a ClojureScript application, we need to pull dependencies from two package managers. That is, JavaScript packages from <code>npm</code> and Clojure packages from <code>deps.edn</code>. After pulling the dependencies, we can then let <code>shadow-cljs</code> compiles the ClojureScript files into a single javascript and make the result a npm package. In this post, we rely on <code>nixpkgs</code>'s builtin <code>fetchNpmDeps</code> and <code>buildNpmPackage</code> for the npm side, and <a href=\"https://github.com/jlesquembre/clj-nix\">clj-nix</a> for the nix side.\n</p>\n<div id=\"outline-container-prerequisites\" class=\"outline-2\">\n<a href=\"#prerequisites\"><h2 id=\"prerequisites\" class=\"cr-self-reference \">Prerequisites</h2></a>\n<div class=\"outline-text-2\" id=\"text-prerequisites\">\n<p>\nI will skip the details that are not unique to Nix. The following contents assume we already have a working shadow-cljs project that can produce a node.js target when running <code>npm run release</code>. Which is basically:\n</p>\n\n<ul class=\"org-ul\">\n<li>a <code>:node-script</code> target in <code>shadow-cljs.edn</code>, with <code>:main</code> function specified</li>\n<li>a <code>release</code> script in package.json, most probably <code>shadow-cljs release script</code></li>\n<li>an entry script specified in <code>bin</code> in package.json.</li>\n</ul>\n</div>\n</div>\n<div id=\"outline-container-prefetch-and-generate-lock-file-for-dependencies\" class=\"outline-2\">\n<a href=\"#prefetch-and-generate-lock-file-for-dependencies\"><h2 id=\"prefetch-and-generate-lock-file-for-dependencies\" class=\"cr-self-reference \">Prefetch and generate lock file for dependencies</h2></a>\n<div class=\"outline-text-2\" id=\"text-prefetch-and-generate-lock-file-for-dependencies\">\n<p>\nDuring the <i>build</i> phase of nix package, the process cannot perform any network request, as that will defeat the whole point of <i>determinism</i>. The common practice is to use a <i>lock file</i>. Which is essentially a recipe of all the necessary resources (and their checksums) for the building process. We can then prefetch all the resources into the nix store and tell the building process where to find the necessary resources during the actual building.\n</p>\n\n<p>\nOn the npm side, we do it by running the following command. It will output a sha256 code, we save it for later.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-bash\"><html><head></head><body>nix run nixpkgs#prefetch-npm-deps package-lock.json\n</body></html></code></pre>\n</div>\n\n<p>\nOn the Clojure side, we execute the following command. It will generate a <code>deps-lock.json</code> file. We will refer it in the <code>flake.nix</code>.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-bash\"><html><head></head><body>nix run github:jlesquembre/clj-nix#deps-lock\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-flake.nix\" class=\"outline-2\">\n<a href=\"#flake.nix\"><h2 id=\"flake.nix\" class=\"cr-self-reference \">flake.nix</h2></a>\n<div class=\"outline-text-2\" id=\"text-flake.nix\">\n<blockquote>\n<p>\nThe following nix script takes heavy inspiration from <a href=\"https://github.com/jlesquembre/clj-nix/issues/14#issuecomment-2661208232\">this github issue comment</a>.\n</p>\n</blockquote>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-nix\"><html><head></head><body>{\n  <span class=\"hljs-attr\">description</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;&quot;</span>;\n  <span class=\"hljs-attr\">inputs.flake-utils.url</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;github:numtide/flake-utils&quot;</span>;\n  <span class=\"hljs-attr\">inputs.nixpkgs.url</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;github:NixOS/nixpkgs/nixos-unstable&quot;</span>;\n  <span class=\"hljs-attr\">inputs.clj-nix.url</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;github:jlesquembre/clj-nix&quot;</span>;\n  <span class=\"hljs-attr\">outputs</span> <span class=\"hljs-operator\">=</span> { self, flake-utils, nixpkgs, clj-nix }:\n    flake-utils.lib.eachDefaultSystem (<span class=\"hljs-params\">system:</span>\n      <span class=\"hljs-keyword\">let</span>\n        <span class=\"hljs-attr\">pkgs</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-built_in\">import</span> nixpkgs {\n          <span class=\"hljs-keyword\">inherit</span> system;\n          <span class=\"hljs-attr\">overlays</span> <span class=\"hljs-operator\">=</span> [\n            clj-nix.overlays.default\n          ];\n        };\n      <span class=\"hljs-keyword\">in</span> {\n        <span class=\"hljs-attr\">packages.default</span> <span class=\"hljs-operator\">=</span> pkgs.buildNpmPackage <span class=\"hljs-keyword\">rec</span> {\n          <span class=\"hljs-attr\">pname</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;proj-name&quot;</span>;\n          <span class=\"hljs-attr\">nativeBuildInputs</span> <span class=\"hljs-operator\">=</span> [ pkgs.babashka pkgs.clojure ];\n          <span class=\"hljs-attr\">npmBuildScript</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;release&quot;</span>;\n          <span class=\"hljs-attr\">version</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;0.0.1&quot;</span>;\n          <span class=\"hljs-attr\">src</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">${self}</span>&quot;</span>;\n          <span class=\"hljs-comment\"># deps hash from previous prefetch-npm-deps</span>\n          <span class=\"hljs-attr\">npmDepsHash</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;sha256-0000=&quot;</span>;\n          <span class=\"hljs-comment\"># deps-lock.json generated by github:jlesquembre/clj-nix#deps-lock</span>\n          <span class=\"hljs-attr\">deps-cache</span> <span class=\"hljs-operator\">=</span> pkgs.mk-deps-cache { <span class=\"hljs-attr\">lockfile</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-symbol\">./deps-lock.json</span>; };\n          <span class=\"hljs-attr\">preBuild</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">''\n            bb -e '(-&gt; (slurp &quot;deps.edn&quot;)\n                       rewrite-clj.zip/of-string\n                       (rewrite-clj.zip/assoc :mvn/local-repo &quot;<span class=\"hljs-subst\">${deps-cache}</span>/.m2/repository&quot;)\n                       rewrite-clj.zip/root-string\n                       (#(spit &quot;deps.edn&quot; %)))'\n          ''</span>;\n        };\n      }\n    );\n}\n</body></html></code></pre>\n</div>\n\n<p>\nIn the <code>preBuild</code> script, we rewrite <code>deps.edn</code> file to tell <code>clj</code> to find dependencies in a local maven repo generated by <code>mk-deps-cache</code>, which is provided by <code>clj-nix</code> overlay. We then fill <code>npmDepsHash</code> with the value we got from previous commands.\n</p>\n\n<p>\nWith this <code>flake.nix</code>, we can then build the project with <code>nix build .</code> or run the script with <code>nix run .</code>.\n</p>\n\n<p>\nYou can check <a href=\"https://github.com/imakira/espoir\">this little project of mine</a> for a working example.\n</p>\n</div>\n</div>\n<div id=\"outline-container-limitations\" class=\"outline-2\">\n<a href=\"#limitations\"><h2 id=\"limitations\" class=\"cr-self-reference \"><span class=\"todo TODO\">TODO</span> Limitations</h2></a>\n<div class=\"outline-text-2\" id=\"text-limitations\">\n<p>\nThe hack in <code>preBuild</code> only deals with dependencies pulled from maven repos. Git dependencies aren't probably handled.\n</p>\n</div>\n</div>\n","blog/orgx-require":null,"blog/modified-date":"2025-11-03T17:25:27+08:00"},{"blog/orgx":false,"blog/tags":[],"blog/title":"Develop and Build a Common Lisp Project using Nix","blog/show-toc?":true,"blog/file-path":"/home/void/Projects/imakira.github.io/blogs/build-a-commonlisp-project-with-nix.org","blog/author":null,"blog/email":null,"blog/description":"I recently tried to build a Common Lisp project using Nix and found it is quite easy with just the  buildASDFSystem  function in nixpkgs and ASDF alone. I ...","blog/id":"develop-and-build-a-common-lisp-project-using-nix","blog/category":"Coding","blog/language":"en_US","blog/published-date":"2025-10-27T17:50:17+08:00","blog/content":"<p>\nI recently tried to build a Common Lisp project using Nix and found it is quite easy with just the <code>buildASDFSystem</code> function in nixpkgs and ASDF alone. I will share how I have done it here in case someone else finds it useful.\n</p>\n<div id=\"outline-container-simple-configuration-when-developing\" class=\"outline-2\">\n<a href=\"#simple-configuration-when-developing\"><h2 id=\"simple-configuration-when-developing\" class=\"cr-self-reference \">Simple Configuration When Developing</h2></a>\n<div class=\"outline-text-2\" id=\"text-simple-configuration-when-developing\">\n<p>\nOn the Nix we will have something like this:\n</p>\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-nix\"><html><head></head><body><span class=\"hljs-comment\"># flake.nix</span>\n{\n  <span class=\"hljs-attr\">description</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;&quot;</span>;\n  <span class=\"hljs-attr\">inputs.flake-utils.url</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;github:numtide/flake-utils&quot;</span>;\n  <span class=\"hljs-attr\">inputs.nixpkgs.url</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;github:NixOS/nixpkgs/nixos-unstable&quot;</span>;\n  <span class=\"hljs-attr\">outputs</span> <span class=\"hljs-operator\">=</span> { self, flake-utils, nixpkgs }:\n    flake-utils.lib.eachDefaultSystem (<span class=\"hljs-params\">system:</span>\n      <span class=\"hljs-keyword\">let</span> pkgs <span class=\"hljs-operator\">=</span> nixpkgs.legacyPackages.${system};\n      <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">rec</span> {\n        <span class=\"hljs-attr\">packages.default</span> <span class=\"hljs-operator\">=</span> pkgs.sbcl.buildASDFSystem {\n          <span class=\"hljs-attr\">pname</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;proj-name&quot;</span>;\n          <span class=\"hljs-attr\">version</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;0.1&quot;</span>;\n          <span class=\"hljs-attr\">src</span> <span class=\"hljs-operator\">=</span> self;\n          <span class=\"hljs-attr\">lispLibs</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">with</span> pkgs.sbclPackages; [\n            alexandria\n            <span class=\"hljs-comment\"># lisp packages in nixpkgs go here</span>\n          ];\n          <span class=\"hljs-attr\">nativeLibs</span> <span class=\"hljs-operator\">=</span> [\n            <span class=\"hljs-comment\"># native libs go here</span>\n          ];\n        };\n      }\n    );\n}\n</body></html></code></pre>\n</div>\n\n<p>\nOn the Lisp side we will have an <code>asd</code> file\n</p>\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-lisp\"><html><head></head><body><span class=\"hljs-comment\">;; proj-name.asd</span>\n(<span class=\"hljs-name\">require</span> 'asdf)\n(<span class=\"hljs-name\">asdf</span><span class=\"hljs-symbol\">:defsystem</span> <span class=\"hljs-string\">&quot;proj-name&quot;</span>\n  <span class=\"hljs-symbol\">:depends-on</span> (<span class=\"hljs-name\">#</span><span class=\"hljs-symbol\">:alexandria</span>)\n  <span class=\"hljs-symbol\">:components</span> ((<span class=\"hljs-symbol\">:file</span> <span class=\"hljs-string\">&quot;main&quot;</span>))) <span class=\"hljs-comment\">;; we will have a main.lisp file</span>\n</body></html></code></pre>\n</div>\n\n<p>\nWith these two files we can then start developing the project with the following steps\n</p>\n\n<ul class=\"org-ul\">\n<li>Enter nix develop environment by executing <code>nix develop .</code> in the directory the project.</li>\n<li>Launch Emacs inside the developing environment.</li>\n<li>Launch <code>sly</code> (or <code>slime</code>) in Emacs, and load the <code>asd</code> file by <code>sly-compile-and-load-file</code>.</li>\n<li>Execute <code>(asdf:load-system &quot;proj-name&quot;)</code> in the <code>sly</code> repl.</li>\n<li>Enjoy!</li>\n</ul>\n</div>\n</div>\n<div id=\"outline-container-building-an-executable\" class=\"outline-2\">\n<a href=\"#building-an-executable\"><h2 id=\"building-an-executable\" class=\"cr-self-reference \">Building an Executable</h2></a>\n<div class=\"outline-text-2\" id=\"text-building-an-executable\">\n<p>\nTo build an executable we need a few more snippets on the Nix side\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-nix\"><html><head></head><body><span class=\"hljs-comment\">#...</span>\n\n<span class=\"hljs-attr\">packages.default</span> <span class=\"hljs-operator\">=</span> pkgs.sbcl.buildASDFSystem {\n  <span class=\"hljs-comment\"># ...</span>\n  <span class=\"hljs-comment\"># other code is omitted here</span>\n  <span class=\"hljs-attr\">lispLibs</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">with</span> pkgs.sbclPackages; [\n    alexandria\n    <span class=\"hljs-comment\"># lisp packages in nixpkgs go here</span>\n  ];\n\n  <span class=\"hljs-attr\">nativeBuildInputs</span> <span class=\"hljs-operator\">=</span> [\n    pkgs.makeWrapper\n  ];\n\n  <span class=\"hljs-attr\">buildScript</span> <span class=\"hljs-operator\">=</span> pkgs.writeText <span class=\"hljs-string\">&quot;build-awesomes&quot;</span> <span class=\"hljs-string\">''\n    (require 'asdf)\n    (asdf:load-system &quot;proj-name&quot;)\n    (sb-ext:save-lisp-and-die\n                &quot;proj-name&quot;\n                :executable t\n                #+sb-core-compression :compression\n                #+sb-core-compression t\n                ;; assume we have the `main' function defined and exported in the main.lisp file\n                :toplevel #'main:main) \n  ''</span>;\n\n  <span class=\"hljs-attr\">installPhase</span> <span class=\"hljs-operator\">=</span>   <span class=\"hljs-string\">''\n    runHook preInstall\n    mkdir -p $out/bin\n    cp proj-name $out/bin\n\n    # make sure the executable can find dynamically linked libraries\n    wrapProgram $out/bin/proj-name \\\n                --prefix LD_LIBRARY_PATH : $LD_LIBRARY_PATH\n    runHook postInstall\n  ''</span>;\n};\n</body></html></code></pre>\n</div>\n\n<p>\nWhen we execute <code>nix build .</code> in the project directory, lisp scripts in <code>buildScript</code> will be executed and generates a binary file <code>proj-name</code>. The binary file will then be copied into <code>$out/bin</code> directory by the scripts inside <code>installPhase</code>. After the <code>nix build .</code> finished, we can find the executable in the <code>result/bin/</code> directory\n</p>\n\n<p>\nWe can also use <code>nix run .</code> to run the result executable directly.\n</p>\n</div>\n</div>\n<div id=\"outline-container-limitations-of-this-method-and-other-notes\" class=\"outline-2\">\n<a href=\"#limitations-of-this-method-and-other-notes\"><h2 id=\"limitations-of-this-method-and-other-notes\" class=\"cr-self-reference \">Limitations of This Method and Other Notes</h2></a>\n<div class=\"outline-text-2\" id=\"text-limitations-of-this-method-and-other-notes\">\n<p>\nThe biggest limitation of this solution may be you need to restart the REPL (or even the Emacs launched inside the develop environment) every time you add a package into the <code>flake.nix</code>.\n</p>\n\n<p>\nYou can find the lisp section of the nixpkgs documentation <a href=\"https://nixos.org/manual/nixpkgs/stable/#lisp-overview\">here</a>. <a href=\"https://github.com/NixOS/nixpkgs/blob/nixos-unstable/pkgs/development/lisp-modules/packages.nix\">packages.nix</a> in the nixpkgs also has plenty lisp project definitions we can take references from.\n</p>\n\n<p>\nI have a <a href=\"https://github.com/imakira/awesomes\">little project</a> built this way and it runs on github actions simply by using <code>nix run .</code>, you can also check that.\n</p>\n</div>\n</div>\n","blog/orgx-require":null,"blog/modified-date":"2025-10-27T17:50:17+08:00"},{"blog/orgx":true,"blog/tags":["clojure","lsp","tailwindcss"],"blog/title":"Demonstration","blog/show-toc?":true,"blog/file-path":"/home/void/Projects/imakira.github.io/blogs/demo.org","blog/author":null,"blog/email":null,"blog/description":"This is a demonstration of this static blog generator","blog/id":"demonstration","blog/category":"Coding","blog/language":"en_US","blog/published-date":"2024-10-13T22:15:21+08:00","blog/content":"<div id=\"outline-container-code-blocks\" class=\"outline-2\">\n<a href=\"#code-blocks\"><h2 id=\"code-blocks\" class=\"cr-self-reference \">Code Blocks</h2></a>\n<div class=\"outline-text-2\" id=\"text-code-blocks\">\n</div>\n<div id=\"outline-container-inline-code-block\" class=\"outline-3\">\n<a href=\"#inline-code-block\"><h3 id=\"inline-code-block\" class=\"cr-self-reference \">Inline Code Block</h3></a>\n<div class=\"outline-text-3\" id=\"text-inline-code-block\">\n<p>\nText around <html><head></head><body>(<span class=\"hljs-name\">uix.dom/create-root</span> (<span class=\"hljs-name\">js/document.getElementById</span> <span class=\"hljs-string\">&quot;root&quot;</span>))</body></html> the inline code block.\n</p>\n</div>\n</div>\n<div id=\"outline-container-code-blocks3\" class=\"outline-3\">\n<a href=\"#code-blocks3\"><h3 id=\"code-blocks3\" class=\"cr-self-reference \">Code Blocks</h3></a>\n<div class=\"outline-text-3\" id=\"text-code-blocks3\">\n<ul class=\"org-ul\">\n<li>Java</li>\n</ul>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-java\"><html><head></head><body><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">fib</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> n)</span> { \n    <span class=\"hljs-keyword\">if</span> (n &lt;= <span class=\"hljs-number\">1</span>) {\n        <span class=\"hljs-keyword\">return</span> n;\n    }\n    <span class=\"hljs-keyword\">return</span> fib(n - <span class=\"hljs-number\">1</span>) + fib(n - <span class=\"hljs-number\">2</span>);\n}\n</body></html></code></pre>\n</div>\n\n<ul class=\"org-ul\">\n<li>Clojure</li>\n</ul>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-name\">defui</span> app [{<span class=\"hljs-symbol\">:keys</span> [initial-route]}]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [[show-header? set-header!]\n        (<span class=\"hljs-name\">use-state</span>\n         (<span class=\"hljs-name\">some</span> #(<span class=\"hljs-name\"><span class=\"hljs-built_in\">=</span></span> % initial-route)\n               [<span class=\"hljs-string\">&quot;/&quot;</span> <span class=\"hljs-string\">&quot;/home.html&quot;</span> <span class=\"hljs-string\">&quot;/template.html&quot;</span>\n                <span class=\"hljs-string\">&quot;/index.html&quot;</span>]))]\n    (<span class=\"hljs-name\">context-binding</span> [*header-context* [show-header? set-header!]]\n      ($ router/router {<span class=\"hljs-symbol\">:routes</span> routes <span class=\"hljs-symbol\">:initial-route</span> initial-route}\n         ($ main {})))))\n</body></html></code></pre>\n</div>\n\n<ul class=\"org-ul\">\n<li>Emacs Lisp</li>\n</ul>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-emacs-lisp\"><html><head></head><body>(<span class=\"hljs-name\">save-excursion</span>                 \n    (<span class=\"hljs-name\">goto-char</span> (<span class=\"hljs-name\">point-min</span>))    \n</body></html></code></pre>\n</div>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-emacs-lisp\"><html><head></head><body>(<span class=\"hljs-name\">with-current-buffer</span> (<span class=\"hljs-name\">current-buffer</span>)\n  (<span class=\"hljs-name\">let</span> ((<span class=\"hljs-name\">ids</span> (<span class=\"hljs-name\">org-map-entries</span> (<span class=\"hljs-name\">lambda</span> ()\n                                (<span class=\"hljs-name\">org-entry-get</span> <span class=\"hljs-literal\">nil</span> <span class=\"hljs-string\">&quot;custom_id&quot;</span>)))))\n    (<span class=\"hljs-name\">org-map-entries</span> (<span class=\"hljs-name\">lambda</span> ()\n                       (<span class=\"hljs-name\">when</span> (<span class=\"hljs-name\">not</span> (<span class=\"hljs-name\">org-entry-get</span> <span class=\"hljs-literal\">nil</span> <span class=\"hljs-string\">&quot;custom_id&quot;</span>))\n                         (<span class=\"hljs-name\">let*</span> ((<span class=\"hljs-name\">candidate-id</span> (<span class=\"hljs-name\">concat</span> <span class=\"hljs-string\">&quot;blog_&quot;</span> (<span class=\"hljs-name\">url-encode-url</span> (<span class=\"hljs-name\">nth</span> <span class=\"hljs-number\">4</span> (<span class=\"hljs-name\">org-heading-components</span>)))))\n                                (<span class=\"hljs-name\">duplicates</span> (<span class=\"hljs-name\">cl-count</span> candidate-id ids)))\n                           (<span class=\"hljs-name\">org-entry-put</span> <span class=\"hljs-literal\">nil</span> <span class=\"hljs-string\">&quot;custom_id&quot;</span> (<span class=\"hljs-name\">concat</span> candidate-id\n                                                                  (<span class=\"hljs-name\">prin1-to-string</span> (<span class=\"hljs-name\">+</span> <span class=\"hljs-number\">1</span> duplicates))))))\n                       (<span class=\"hljs-name\">setq</span> ids (<span class=\"hljs-name\">cons</span> (<span class=\"hljs-name\">org-entry-get</span> <span class=\"hljs-literal\">nil</span> <span class=\"hljs-string\">&quot;custom_id&quot;</span>)\n                                       ids))))))\n</body></html></code></pre>\n</div>\n</div>\n</div>\n</div>\n<div id=\"outline-container-h2-sample-text\" class=\"outline-2\">\n<a href=\"#h2-sample-text\"><h2 id=\"h2-sample-text\" class=\"cr-self-reference \">H2 Sample Text</h2></a>\n<div class=\"outline-text-2\" id=\"text-h2-sample-text\">\n</div>\n<div id=\"outline-container-h3-sample-text-sample-text\" class=\"outline-3\">\n<a href=\"#h3-sample-text-sample-text\"><h3 id=\"h3-sample-text-sample-text\" class=\"cr-self-reference \">H3 Sample Text Sample Text</h3></a>\n<div class=\"outline-text-3\" id=\"text-h3-sample-text-sample-text\">\n<p>\nSome text in between\n</p>\n</div>\n<div id=\"outline-container-h4-sample-text-sample-text\" class=\"outline-4\">\n<a href=\"#h4-sample-text-sample-text\"><h4 id=\"h4-sample-text-sample-text\" class=\"cr-self-reference \">H4 Sample Text Sample Text</h4></a>\n<div class=\"outline-text-4\" id=\"text-h4-sample-text-sample-text\">\n<p>\nSome text in between\n</p>\n</div>\n<div id=\"outline-container-h5-sample-text-sample-text\" class=\"outline-5\">\n<a href=\"#h5-sample-text-sample-text\"><h5 id=\"h5-sample-text-sample-text\" class=\"cr-self-reference \">H5 Sample Text Sample Text</h5></a>\n<div class=\"outline-text-5\" id=\"text-h5-sample-text-sample-text\">\n<p>\nSome text in between\n</p>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div id=\"outline-container-common-elements\" class=\"outline-2\">\n<a href=\"#common-elements\"><h2 id=\"common-elements\" class=\"cr-self-reference \">Common Elements</h2></a>\n<div class=\"outline-text-2\" id=\"text-common-elements\">\n<ul class=\"org-ul\">\n<li><i>italic</i></li>\n<li><b>bold</b></li>\n<li><span class=\"underline\">underline</span></li>\n<li><code>verbatim</code></li>\n<li><code>code</code></li>\n<li><del>strike-through</del></li>\n<li>Horizontal Rule</li>\n<li><code>code</code></li>\n</ul>\n<hr>\n</div>\n</div>\n<div id=\"outline-container-other-elements\" class=\"outline-2\">\n<a href=\"#other-elements\"><h2 id=\"other-elements\" class=\"cr-self-reference \">Other Elements</h2></a>\n<div class=\"outline-text-2\" id=\"text-other-elements\">\n</div>\n<div id=\"outline-container-table\" class=\"outline-3\">\n<a href=\"#table\"><h3 id=\"table\" class=\"cr-self-reference \">Table</h3></a>\n<div class=\"outline-text-3\" id=\"text-table\">\n<table>\n\n\n<colgroup>\n<col class=\"org-left\">\n\n<col class=\"org-right\">\n\n<col class=\"org-right\">\n</colgroup>\n<thead>\n<tr>\n<th scope=\"col\" class=\"org-left\">Name</th>\n<th scope=\"col\" class=\"org-right\">Phone</th>\n<th scope=\"col\" class=\"org-right\">Age</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"org-left\">Peter</td>\n<td class=\"org-right\">1234</td>\n<td class=\"org-right\">17</td>\n</tr>\n\n<tr>\n<td class=\"org-left\">Anna</td>\n<td class=\"org-right\">4321</td>\n<td class=\"org-right\">25</td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n<div id=\"outline-container-reference\" class=\"outline-3\">\n<a href=\"#reference\"><h3 id=\"reference\" class=\"cr-self-reference \">Reference</h3></a>\n<div class=\"outline-text-3\" id=\"text-reference\">\n<blockquote>\n<p>\nEverything should be made as simple as possible,\nbut not any simpler â€“ Albert Einstein\n</p>\n</blockquote>\n</div>\n</div>\n<div id=\"outline-container-unordered-list\" class=\"outline-3\">\n<a href=\"#unordered-list\"><h3 id=\"unordered-list\" class=\"cr-self-reference \">Unordered List</h3></a>\n<div class=\"outline-text-3\" id=\"text-unordered-list\">\n<ul class=\"org-ul\">\n<li>Item 1</li>\n<li>Item 2\n<ul class=\"org-ul\">\n<li>Level 2\n<ul class=\"org-ul\">\n<li>Level 3\n<ul class=\"org-ul\">\n<li>Level 4</li>\n</ul></li>\n<li>Another Mark</li>\n</ul></li>\n</ul></li>\n<li>Item 3</li>\n</ul>\n</div>\n<div id=\"outline-container-ordered-list\" class=\"outline-5\">\n<a href=\"#ordered-list\"><h5 id=\"ordered-list\" class=\"cr-self-reference \">Ordered List</h5></a>\n<div class=\"outline-text-5\" id=\"text-ordered-list\">\n<ol class=\"org-ol\">\n<li>Item 1</li>\n<li>Item 2</li>\n<li>Item 3</li>\n<li>Item 4</li>\n</ol>\n</div>\n</div>\n</div>\n<div id=\"outline-container-description-list\" class=\"outline-3\">\n<a href=\"#description-list\"><h3 id=\"description-list\" class=\"cr-self-reference \">Description List</h3></a>\n<div class=\"outline-text-3\" id=\"text-description-list\">\n<dl class=\"org-dl\">\n<dt>Name</dt><dd>Description\n<dl class=\"org-dl\">\n<dt>Nested</dt><dd>Nested Description</dd>\n</dl></dd>\n<dt>Name</dt><dd>Description</dd>\n</dl>\n</div>\n</div>\n<div id=\"outline-container-sample-image\" class=\"outline-3\">\n<a href=\"#sample-image\"><h3 id=\"sample-image\" class=\"cr-self-reference \">Sample Image</h3></a>\n<div class=\"outline-text-3\" id=\"text-sample-image\">\n\n<figure id=\"org8c83bd8\">\n<img width=\"550\" height=\"368\" src=\"imgs/1.jpg\" alt=\"1.jpg\">\n\n<figcaption><span class=\"figure-number\">Figure 1: </span>This is an image</figcaption>\n</figure>\n\n\n<figure id=\"org82d2a42\">\n<img width=\"550\" height=\"368\" src=\"imgs/1.webp\" alt=\"1.webp\">\n\n</figure>\n\n\n<figure id=\"org43ae580\">\n<img width=\"2624\" height=\"3936\" src=\"https://images.unsplash.com/photo-1746717410283-f4017128c38f?ixlib=rb-4.1.0&amp;q=85&amp;fm=jpg&amp;crop=entropy&amp;cs=srgb&amp;dl=natalia-grela-sFINbLpdfqw-unsplash.jpg\" alt=\"photo-1746717410283-f4017128c38f?ixlib=rb-4.1.0&amp;q=85&amp;fm=jpg&amp;crop=entropy&amp;cs=srgb&amp;dl=natalia-grela-sFINbLpdfqw-unsplash.jpg\">\n\n<figcaption><span class=\"figure-number\">Figure 2: </span>sample high resolution vertical image</figcaption>\n</figure>\n\n\n<figure id=\"orgb28ac82\">\n<img width=\"4928\" height=\"3280\" src=\"https://images.unsplash.com/photo-1653384236127-c61634419fe0?ixlib=rb-4.1.0&amp;q=85&amp;fm=jpg&amp;crop=entropy&amp;cs=srgb&amp;dl=johann-walter-bantz-Bp7hIvZnj9I-unsplash.jpg\" alt=\"photo-1653384236127-c61634419fe0?ixlib=rb-4.1.0&amp;q=85&amp;fm=jpg&amp;crop=entropy&amp;cs=srgb&amp;dl=johann-walter-bantz-Bp7hIvZnj9I-unsplash.jpg\">\n\n<figcaption><span class=\"figure-number\">Figure 3: </span>sample high resolution horizontal iamge</figcaption>\n</figure>\n</div>\n</div>\n<div id=\"outline-container-verbatim\" class=\"outline-3\">\n<a href=\"#verbatim\"><h3 id=\"verbatim\" class=\"cr-self-reference \">Verbatim</h3></a>\n<div class=\"outline-text-3\" id=\"text-verbatim\">\n</div>\n</div>\n</div>\n<div id=\"outline-container-inline-cljc-code\" class=\"outline-2\">\n<a href=\"#inline-cljc-code\"><h2 id=\"inline-cljc-code\" class=\"cr-self-reference \">Inline CLJC Code</h2></a>\n<div class=\"outline-text-2\" id=\"text-inline-cljc-code\">\n<pre class=\"uix\">  ($ :button {:on-click (fn [&amp; _] #?(:cljs (js/alert &quot;clicked!&quot;)))} &quot;Click Me&quot;)\n\n</pre>\n</div>\n</div>\n","blog/orgx-require":[["net.coruscation.cerulean.components","as","comp"]],"blog/modified-date":"2025-12-13T22:18:29+08:00"}]