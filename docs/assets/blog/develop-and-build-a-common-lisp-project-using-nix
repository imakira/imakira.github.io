{"category":"Coding","tags":[],"email":null,"content":"<p>\nI recently tried to build a Common Lisp project using Nix and found it is quite easy with just the <code>buildASDFSystem</code> function in nixpkgs and ASDF alone. I will share how I have done it here in case someone else finds it useful.\n</p>\n<div id=\"outline-container-org9a884be\" class=\"outline-2\">\n<a href=\"#org9a884be\"><h2 id=\"org9a884be\" class=\"cr-self-reference \">Simple Configuration When Developing</h2></a>\n<div class=\"outline-text-2\" id=\"text-org9a884be\">\n<p>\nOn the Nix we will have something like this:\n</p>\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-nix\"><html><head></head><body><span class=\"hljs-comment\"># flake.nix</span>\n{\n  <span class=\"hljs-attr\">description</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;&quot;</span>;\n  <span class=\"hljs-attr\">inputs.flake-utils.url</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;github:numtide/flake-utils&quot;</span>;\n  <span class=\"hljs-attr\">inputs.nixpkgs.url</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;github:NixOS/nixpkgs/nixos-unstable&quot;</span>;\n  <span class=\"hljs-attr\">outputs</span> <span class=\"hljs-operator\">=</span> { self, flake-utils, nixpkgs }:\n    flake-utils.lib.eachDefaultSystem (<span class=\"hljs-params\">system:</span>\n      <span class=\"hljs-keyword\">let</span> pkgs <span class=\"hljs-operator\">=</span> nixpkgs.legacyPackages.${system};\n      <span class=\"hljs-keyword\">in</span> <span class=\"hljs-keyword\">rec</span> {\n        <span class=\"hljs-attr\">packages.default</span> <span class=\"hljs-operator\">=</span> pkgs.sbcl.buildASDFSystem {\n          <span class=\"hljs-attr\">pname</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;proj-name&quot;</span>;\n          <span class=\"hljs-attr\">version</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;0.1&quot;</span>;\n          <span class=\"hljs-attr\">src</span> <span class=\"hljs-operator\">=</span> self;\n          <span class=\"hljs-attr\">lispLibs</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">with</span> pkgs.sbclPackages; [\n            alexandria\n            <span class=\"hljs-comment\"># lisp packages in nixpkgs go here</span>\n          ];\n          <span class=\"hljs-attr\">nativeLibs</span> <span class=\"hljs-operator\">=</span> [\n            <span class=\"hljs-comment\"># native libs go here</span>\n          ];\n        };\n      }\n    );\n}\n</body></html></code></pre>\n</div>\n\n<p>\nOn the Lisp side we will have an <code>asd</code> file\n</p>\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-lisp\"><html><head></head><body><span class=\"hljs-comment\">;; proj-name.asd</span>\n(<span class=\"hljs-name\">require</span> 'asdf)\n(<span class=\"hljs-name\">asdf</span><span class=\"hljs-symbol\">:defsystem</span> <span class=\"hljs-string\">&quot;proj-name&quot;</span>\n  <span class=\"hljs-symbol\">:depends-on</span> (<span class=\"hljs-name\">#</span><span class=\"hljs-symbol\">:alexandria</span>)\n  <span class=\"hljs-symbol\">:components</span> ((<span class=\"hljs-symbol\">:file</span> <span class=\"hljs-string\">&quot;main&quot;</span>))) <span class=\"hljs-comment\">;; we will have a main.lisp file</span>\n</body></html></code></pre>\n</div>\n\n<p>\nWith these two files we can then start developing the project with the following steps\n</p>\n\n<ul class=\"org-ul\">\n<li>Enter nix develop environment by executing <code>nix develop .</code> in the directory the project.</li>\n<li>Launch Emacs inside the developing environment.</li>\n<li>Launch <code>sly</code> (or <code>slime</code>) in Emacs, and load the <code>asd</code> file by <code>sly-compile-and-load-file</code>.</li>\n<li>Execute <code>(asdf:load-system &quot;proj-name&quot;)</code> in the <code>sly</code> repl.</li>\n<li>Enjoy!</li>\n</ul>\n</div>\n</div>\n<div id=\"outline-container-org2dd4eed\" class=\"outline-2\">\n<a href=\"#org2dd4eed\"><h2 id=\"org2dd4eed\" class=\"cr-self-reference \">Building an Executable</h2></a>\n<div class=\"outline-text-2\" id=\"text-org2dd4eed\">\n<p>\nTo build an executable we need a few more snippets on the Nix side\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-nix\"><html><head></head><body><span class=\"hljs-comment\">#...</span>\n\n<span class=\"hljs-attr\">packages.default</span> <span class=\"hljs-operator\">=</span> pkgs.sbcl.buildASDFSystem {\n  <span class=\"hljs-comment\"># ...</span>\n  <span class=\"hljs-comment\"># other code is omitted here</span>\n  <span class=\"hljs-attr\">lispLibs</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">with</span> pkgs.sbclPackages; [\n    alexandria\n    <span class=\"hljs-comment\"># lisp packages in nixpkgs go here</span>\n  ];\n\n  <span class=\"hljs-attr\">nativeBuildInputs</span> <span class=\"hljs-operator\">=</span> [\n    pkgs.makeWrapper\n  ];\n\n  <span class=\"hljs-attr\">buildScript</span> <span class=\"hljs-operator\">=</span> pkgs.writeText <span class=\"hljs-string\">&quot;build-awesomes&quot;</span> <span class=\"hljs-string\">''\n    (require 'asdf)\n    (asdf:load-system &quot;proj-name&quot;)\n    (sb-ext:save-lisp-and-die\n                &quot;proj-name&quot;\n                :executable t\n                #+sb-core-compression :compression\n                #+sb-core-compression t\n                ;; assume we have the `main' function defined and exported in the main.lisp file\n                :toplevel #'main:main) \n  ''</span>;\n\n  <span class=\"hljs-attr\">installPhase</span> <span class=\"hljs-operator\">=</span>   <span class=\"hljs-string\">''\n    runHook preInstall\n    mkdir -p $out/bin\n    cp proj-name $out/bin\n\n    # make sure the executable can find dynamically linked libraries\n    wrapProgram $out/bin/proj-name \\\n                --prefix LD_LIBRARY_PATH : $LD_LIBRARY_PATH\n    runHook postInstall\n  ''</span>;\n};\n</body></html></code></pre>\n</div>\n\n<p>\nWhen we execute <code>nix build .</code> in the project directory, lisp scripts in <code>buildScript</code> will be executed and generates a binary file <code>proj-name</code>. The binary file will then be copied into <code>$out/bin</code> directory by the scripts inside <code>installPhase</code>. After the <code>nix build .</code> finished, we can find the executable in the <code>result/bin/</code> directory\n</p>\n\n<p>\nWe can also use <code>nix run .</code> to run the result executable directly.\n</p>\n</div>\n</div>\n<div id=\"outline-container-orga386a80\" class=\"outline-2\">\n<a href=\"#orga386a80\"><h2 id=\"orga386a80\" class=\"cr-self-reference \">Limitations of This Method and Other Notes</h2></a>\n<div class=\"outline-text-2\" id=\"text-orga386a80\">\n<p>\nThe biggest limitation of this solution may be you need to restart the REPL (or even the Emacs launched inside the develop environment) every time you add a package into the <code>flake.nix</code>.\n</p>\n\n<p>\nYou can find the lisp section of the nixpkgs documentation <a href=\"https://nixos.org/manual/nixpkgs/stable/#lisp-overview\">here</a>. <a href=\"https://github.com/NixOS/nixpkgs/blob/nixos-unstable/pkgs/development/lisp-modules/packages.nix\">packages.nix</a> in the nixpkgs also has plenty lisp project definitions we can take references from.\n</p>\n\n<p>\nI have a <a href=\"https://github.com/imakira/awesomes\">little project</a> built this way and it runs on github actions simply by using <code>nix run .</code>, you can also check that.\n</p>\n</div>\n</div>\n","published-date":"2025-10-27T17:50:17+08:00","title":"Develop and Build a Common Lisp Project using Nix","show-toc?":true,"author":null,"language":"en_US","id":"develop-and-build-a-common-lisp-project-using-nix","file-path":"/home/void/Projects/imakira.github.io/blogs/build-a-commonlisp-project-with-nix.org","modified-date":"2025-10-27T17:31:20+08:00"}