{"description":"The experience of using  lsp-mode  or  elgot  depends heavily on the lsp server you are using and the project you are working on. With the newly added JSON...","category":"Coding","tags":[],"email":null,"content":"<p>\nThe experience of using <code>lsp-mode</code> or <code>elgot</code> depends heavily on the lsp server you are using and the project you are working on. With the newly added JSON parser in Emacs 30 and the garbage collecting improvements in the <a href=\"https://github.com/emacs-mirror/emacs/blob/feature/igc/README-IGC\">igc branch</a>, the experience of <code>lsp-mode</code> or <code>eglot</code> can be more than good enough. Still, if you are using the more demanding lsp server (like some language servers for frontend development) or working on a larger-size project, the experience could still be unsatisfying or even super frustrating. If you have ever experienced Emacs freezing after checkout to another git branch or big gc lag when using <code>gcmh-mode</code>, you could still consider giving <code>lsp-bridge</code> a try.\n</p>\n\n<p>\nIn exchange for speed and fluency, <code>lsp-bridge</code> replaces every builtin and well known tools that aren't suitable for async operations, including but not limited to <code>completion-at-point</code>, <code>xref</code>, <code>eldoc</code>. This prevents a lot of users from ever trying it, and that's reasonable. However, the async nature of <code>lsp-bridge</code> also brings its own advantages.\n</p>\n\n<p>\nFor a small example, consider that even the <code>go-to-definition</code> operation in <code>lsp-bridge</code> is asynchronous. With other lsp clients, Emacs is stuck between the time you call <code>xref-find-definitions</code> and the lsp server returns a response. With <code>lsp-bridge</code>, even if you are waiting for a response, Emacs is free to do other things in the meantime, such as doing a garbage collection, or executing a callback registered by <code>run-with-idle-timer</code>.\n</p>\n\n<p>\nFinally, you certainly can use lsp-bridge only for some modes and keep using <code>completion-at-point</code> for other modes. That's also what I'm doing.\n</p>\n<div id=\"outline-container-org841db70\" class=\"outline-2\">\n<a href=\"#org841db70\"><h2 id=\"org841db70\" class=\"cr-self-reference \">Basic Setup</h2></a>\n<div class=\"outline-text-2\" id=\"text-org841db70\">\n<p>\nTo use <code>lsp-bridge</code>, you first need to install some external dependencies.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-bash\"><html><head></head><body>pip3 install epc orjson sexpdata six setuptools paramiko rapidfuzz watchdog packaging\n</body></html></code></pre>\n</div>\n\n<p>\nIf you are using Nix, you need to add a python package with dependencies to your Nix config files.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-nix\"><html><head></head><body>(python3.withPackages (\n      <span class=\"hljs-params\">ps:</span> <span class=\"hljs-keyword\">with</span> ps; [\n        <span class=\"hljs-comment\"># ...</span>\n        epc\n        orjson\n        packaging\n        paramiko\n        rapidfuzz\n        setuptools\n        sexpdata\n        six\n        watchdog\n      ]\n    ))\n</body></html></code></pre>\n</div>\n\n<p>\nWith external dependencies installed, now we can install the <code>lsp-bridge</code> package. Here's how I have done it with <code>straight</code> and <code>use-package</code>.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-emacs-lisp\"><html><head></head><body>(<span class=\"hljs-name\">use-package</span> lsp-bridge\n  <span class=\"hljs-symbol\">:hook</span>\n  (<span class=\"hljs-name\">clojure-mode</span> . lsp-bridge-mode)\n  (<span class=\"hljs-name\">clojure-ts-mode</span> . lsp-bridge-mode)\n  (<span class=\"hljs-name\">typescript-ts-mode</span> . lsp-bridge-mode)\n  (<span class=\"hljs-name\">js-ts-mode</span> . lsp-bridge-mode)\n  (<span class=\"hljs-name\">java-ts-mode</span> . lsp-bridge-mode)\n  <span class=\"hljs-symbol\">:straight</span> '(lsp-bridge <span class=\"hljs-symbol\">:type</span> git <span class=\"hljs-symbol\">:host</span> github <span class=\"hljs-symbol\">:repo</span> <span class=\"hljs-string\">&quot;manateelazycat/lsp-bridge&quot;</span>\n                         <span class=\"hljs-symbol\">:files</span> (:defaults <span class=\"hljs-string\">&quot;*.el&quot;</span> <span class=\"hljs-string\">&quot;*.py&quot;</span> <span class=\"hljs-string\">&quot;acm&quot;</span> <span class=\"hljs-string\">&quot;core&quot;</span> <span class=\"hljs-string\">&quot;langserver&quot;</span> <span class=\"hljs-string\">&quot;multiserver&quot;</span> <span class=\"hljs-string\">&quot;resources&quot;</span>)\n                         <span class=\"hljs-symbol\">:build</span> (:not compile))\n\n  <span class=\"hljs-symbol\">:init</span>\n  (<span class=\"hljs-name\">defun</span> me/lsp-bridge-corfu-hook ()\n    (<span class=\"hljs-name\">when</span> (<span class=\"hljs-name\">and</span> lsp-bridge-mode\n               (<span class=\"hljs-name\">boundp</span> 'corfu-mode)\n               corfu-mode)\n      (<span class=\"hljs-name\">corfu-mode</span> <span class=\"hljs-number\">-1</span>)))\n  (<span class=\"hljs-name\">add-hook</span> 'lsp-bridge-mode-hook #'me/lsp-bridge-corfu-hook))\n</body></html></code></pre>\n</div>\n\n<p>\nHere I only enabled <code>lsp-bridge-mode</code> for modes in the <code>:hook</code> part, and I disabled <code>corfu</code> in <code>lsp-bridge-mode-hook</code> (I'm still using it for other programming or writing tasks).\n</p>\n\n<p>\nUnlike <code>lsp-mode</code>, lsp-bridge doesn't provide a lsp server installation function. Check <a href=\"https://github.com/manateelazycat/lsp-bridge?tab=readme-ov-file#supported-language-servers\">Supported language servers</a> and their corresponding pages for installation methods.\n</p>\n\n<p>\nIf the server is installed and <code>lsp-bridge-mode</code> is enabled, it should just work without any other configurations. If it doesn't, set <code>lsp-bridge-enable-debug</code> to true and check <code>*lsp-bridge*</code> for error messages.\n</p>\n</div>\n</div>\n<div id=\"outline-container-org9f6dcbf\" class=\"outline-2\">\n<a href=\"#org9f6dcbf\"><h2 id=\"org9f6dcbf\" class=\"cr-self-reference \">Configuration</h2></a>\n<div class=\"outline-text-2\" id=\"text-org9f6dcbf\">\n</div>\n<div id=\"outline-container-org68b5d1a\" class=\"outline-3\">\n<a href=\"#org68b5d1a\"><h3 id=\"org68b5d1a\" class=\"cr-self-reference \">Keymapping</h3></a>\n<div class=\"outline-text-3\" id=\"text-org68b5d1a\">\n<p>\nlsp-bridge provides its xef and eldoc equivalents, but it's up to us to mapping them. Here is what I do just for a reference.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-emacs-lisp\"><html><head></head><body>(<span class=\"hljs-name\">general-evil-define-key</span> '(normal) '(lsp-bridge-mode-map)\n  <span class=\"hljs-string\">&quot;s S&quot;</span> #'lsp-bridge-workspace-list-symbols\n  <span class=\"hljs-string\">&quot;s D&quot;</span> #'lsp-bridge-diagnostic-list\n  <span class=\"hljs-string\">&quot;s R&quot;</span> #'lsp-bridge-rename\n  <span class=\"hljs-string\">&quot;g d&quot;</span> #'lsp-bridge-find-def\n  <span class=\"hljs-string\">&quot;g r&quot;</span> #'lsp-bridge-find-references\n  <span class=\"hljs-string\">&quot;g D&quot;</span> #'lsp-bridge-find-impl\n  <span class=\"hljs-string\">&quot;C-RET&quot;</span> #'lsp-bridge-code-action\n  <span class=\"hljs-string\">&quot;C-&lt;return&gt;&quot;</span> #'lsp-bridge-code-action)\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-orgaa6c114\" class=\"outline-3\">\n<a href=\"#orgaa6c114\"><h3 id=\"orgaa6c114\" class=\"cr-self-reference \">a Little Hack (minimum popup width)</h3></a>\n<div class=\"outline-text-3\" id=\"text-orgaa6c114\">\n<p>\nIn corfu you can set minimum popup width with <code>corfu-min-width</code>. <code>lsp-bridge~/~acm</code> currently doesn't provide a way to do so. However it is relatively easy to hack one.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-emacs-lisp\"><html><head></head><body>(<span class=\"hljs-name\">setq</span> me/acm-minimum-width <span class=\"hljs-number\">1000</span>)\n\n(<span class=\"hljs-name\">defun</span> me/acm-minimum-width-function (<span class=\"hljs-name\">oldfun</span> <span class=\"hljs-symbol\">&amp;rest</span> r)\n  (<span class=\"hljs-name\">let</span> ((<span class=\"hljs-name\">result</span> (<span class=\"hljs-name\">apply</span> oldfun r)))\n    (<span class=\"hljs-name\">max</span> me/acm-minimum-width result)))\n\n(<span class=\"hljs-name\">advice-add</span> 'acm-menu-max-length <span class=\"hljs-symbol\">:around</span> #'me/acm-minimum-width-function)\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-org03ca401\" class=\"outline-3\">\n<a href=\"#org03ca401\"><h3 id=\"org03ca401\" class=\"cr-self-reference \">flymake</h3></a>\n<div class=\"outline-text-3\" id=\"text-org03ca401\">\n<p>\nThere is actually a third-party lsp-bridge integration for flymake. Check <a href=\"https://github.com/eki3z/flymake-bridge\">eki3z/flymake-bridge</a>.\n</p>\n</div>\n</div>\n</div>\n<div id=\"outline-container-orgd0777b4\" class=\"outline-2\">\n<a href=\"#orgd0777b4\"><h2 id=\"orgd0777b4\" class=\"cr-self-reference \">Workspace Management</h2></a>\n<div class=\"outline-text-2\" id=\"text-orgd0777b4\">\n<p>\nlsp-bridge's workspace detection depends entirely on <code>git</code>. It simply use the nearest directory contains <code>.git</code> as the workspace root. This may not be enough for some use cases. However, it provides a <code>lsp-bridge-get-project-path-by-filepath</code> for us to customize. We can implement something similar to what lsp-mode provides fairly easily.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-emacs-lisp\"><html><head></head><body>(<span class=\"hljs-name\">require</span> 'f)\n\n<span class=\"hljs-comment\">;; assume savehist-mode is enabled</span>\n(<span class=\"hljs-name\">defvar</span> me/lsp-bridge-workspaces (<span class=\"hljs-name\">list</span>))\n(<span class=\"hljs-name\">add-to-list</span> 'savehist-additional-variables 'me/lsp-bridge-workspaces)\n\n(<span class=\"hljs-name\">defun</span> me/lsp-bridge-workspace-add (<span class=\"hljs-name\">project-root</span>)\n  (<span class=\"hljs-name\">interactive</span>\n   (<span class=\"hljs-name\">list</span> (<span class=\"hljs-name\">read-directory-name</span> <span class=\"hljs-string\">&quot;Select folder:&quot;</span>)))\n  (<span class=\"hljs-name\">add-to-list</span> 'me/lsp-bridge-workspaces project-root))\n\n(<span class=\"hljs-name\">defun</span> me/lsp-bridge-workspace-remove (<span class=\"hljs-name\">project-root</span>)\n  (<span class=\"hljs-name\">interactive</span> (<span class=\"hljs-name\">list</span> (<span class=\"hljs-name\">completing-read</span> <span class=\"hljs-string\">&quot;Select folder to remove: &quot;</span>\n                                      me/lsp-bridge-workspaces)))\n  (<span class=\"hljs-name\">setq</span> me/lsp-bridge-workspaces (<span class=\"hljs-name\">cl-remove</span> project-root me/lsp-bridge-workspaces <span class=\"hljs-symbol\">:test</span> #'equal)))\n\n(<span class=\"hljs-name\">defun</span> me/lsp-bridge-get-workspace (<span class=\"hljs-name\">path</span>)\n  (<span class=\"hljs-name\">cl-first</span> (<span class=\"hljs-name\">cl-mapcar</span> #'f-expand\n                       (<span class=\"hljs-name\">cl-remove-if-not</span> (<span class=\"hljs-name\">lambda</span> (<span class=\"hljs-name\">workspace</span>)\n                                           (<span class=\"hljs-name\">if</span> (<span class=\"hljs-name\">f-ancestor-of</span>? (<span class=\"hljs-name\">f-expand</span> workspace) path)\n                                                   workspace                                  \n                                             <span class=\"hljs-literal\">nil</span>))\n                                         me/lsp-bridge-workspaces))))\n\n(<span class=\"hljs-name\">setq</span> lsp-bridge-get-project-path-by-filepath #'me/lsp-bridge-get-workspace)\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-org86a7e94\" class=\"outline-2\">\n<a href=\"#org86a7e94\"><h2 id=\"org86a7e94\" class=\"cr-self-reference \">Working with Java</h2></a>\n<div class=\"outline-text-2\" id=\"text-org86a7e94\">\n<p>\nWe need a few more lines of configuration to make it works with Java.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-emacs-lisp\"><html><head></head><body>(<span class=\"hljs-name\">use-package</span> lsp-bridge\n  <span class=\"hljs-comment\">;; ...</span>\n  <span class=\"hljs-symbol\">:init</span>\n  (<span class=\"hljs-name\">require</span> 'lsp-bridge-jdtls)\n  (<span class=\"hljs-name\">setq</span> lsp-bridge-enable-auto-import <span class=\"hljs-literal\">t</span>)\n  <span class=\"hljs-comment\">;; ... other configurations</span>\n  )\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-org9cf4d4f\" class=\"outline-2\">\n<a href=\"#org9cf4d4f\"><h2 id=\"org9cf4d4f\" class=\"cr-self-reference \">Working with Clojure and Cider</h2></a>\n<div class=\"outline-text-2\" id=\"text-org9cf4d4f\">\n<p>\nWhen writing Clojure, I would like to use <code>cider</code> for completion and let lsp handling everything else. With <code>lsp-mode</code> we can just locally set <code>lsp-enable-completion-at-point</code> to false. With <code>lsp-bridge</code>, well, we can disable <code>lsp-bridge</code>'s automatic popup and continue to use corfu.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-emacs-lisp\"><html><head></head><body>(<span class=\"hljs-name\">use-package</span> cider\n  <span class=\"hljs-symbol\">:after</span> lsp-bridge-mode\n  <span class=\"hljs-symbol\">:config</span>\n  (<span class=\"hljs-name\">defun</span> me/lsp-bridge-cider-hook ()\n    (<span class=\"hljs-name\">when</span> cider-mode\n      (<span class=\"hljs-name\">setq-local</span> lsp-bridge-complete-manually <span class=\"hljs-literal\">t</span>)\n      (<span class=\"hljs-name\">corfu-mode</span> <span class=\"hljs-number\">1</span>)))\n  (<span class=\"hljs-name\">add-hook</span> 'cider-mode-hook #'me/lsp-bridge-cider-hook <span class=\"hljs-number\">80</span>))\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-orgf833e6b\" class=\"outline-2\">\n<a href=\"#orgf833e6b\"><h2 id=\"orgf833e6b\" class=\"cr-self-reference \">Conclusion</h2></a>\n<div class=\"outline-text-2\" id=\"text-orgf833e6b\">\n<p>\nOverall I would say I'm satisfied with what lsp-bridge provides and amazed at its fluency. I can now load and browse through <a href=\"https://github.com/oracle/graaljs.git\">graaljs</a>'s source code with no stutter, no random freeze I need to <code>C-g</code>, that may or may not work, no nothing. The strategy of off-loading computation to an external process and async everything seems to put very light weight on the Emacs side and work really well.\n</p>\n</div>\n</div>\n","published-date":"2025-11-22T23:33:09+08:00","title":"My Experience with lsp-bridge","show-toc?":true,"author":null,"language":"en_US","id":"my-experience-with-lsp-bridge","file-path":"/home/void/Projects/imakira.github.io/blogs/my-experiment-with-lsp-bridge.org","modified-date":"2025-11-22T23:32:29+08:00"}