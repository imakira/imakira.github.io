{"description":"To build a ClojureScript application, we need to pull dependencies from two package managers. That is, JavaScript packages from  npm  and Clojure packages ...","category":"Coding","tags":[],"email":null,"content":"<p>\nTo build a ClojureScript application, we need to pull dependencies from two package managers. That is, JavaScript packages from <code>npm</code> and Clojure packages from <code>deps.edn</code>. After pulling the dependencies, we can then let <code>shadow-cljs</code> compiles the ClojureScript files into a single javascript and make the result a npm package. In this post, we rely on <code>nixpkgs</code>'s builtin <code>fetchNpmDeps</code> and <code>buildNpmPackage</code> for the npm side, and <a href=\"https://github.com/jlesquembre/clj-nix\">clj-nix</a> for the nix side.\n</p>\n<div id=\"outline-container-org15d9f84\" class=\"outline-2\">\n<a href=\"#org15d9f84\"><h2 id=\"org15d9f84\" class=\"cr-self-reference \">Prerequisites</h2></a>\n<div class=\"outline-text-2\" id=\"text-org15d9f84\">\n<p>\nI will skip the details that are not unique to Nix. The following contents assume we already have a working shadow-cljs project that can produce a node.js target when running <code>npm run release</code>. Which is basically:\n</p>\n\n<ul class=\"org-ul\">\n<li>a <code>:node-script</code> target in <code>shadow-cljs.edn</code>, with <code>:main</code> function specified</li>\n<li>a <code>release</code> script in package.json, most probably <code>shadow-cljs release script</code></li>\n<li>an entry script specified in <code>bin</code> in package.json.</li>\n</ul>\n</div>\n</div>\n<div id=\"outline-container-orgcb7e938\" class=\"outline-2\">\n<a href=\"#orgcb7e938\"><h2 id=\"orgcb7e938\" class=\"cr-self-reference \">Prefetch and generate lock file for dependencies</h2></a>\n<div class=\"outline-text-2\" id=\"text-orgcb7e938\">\n<p>\nDuring the <i>build</i> phase of nix package, the process cannot perform any network request, as that will defeat the whole point of <i>determinism</i>. The common practice is to use a <i>lock file</i>. Which is essentially a recipe of all the necessary resources (and their checksums) for the building process. We can then prefetch all the resources into the nix store and tell the building process where to find the necessary resources during the actual building.\n</p>\n\n<p>\nOn the npm side, we do it by running the following command. It will output a sha256 code, we save it for later.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-bash\"><html><head></head><body>nix run nixpkgs#prefetch-npm-deps package-lock.json\n</body></html></code></pre>\n</div>\n\n<p>\nOn the Clojure side, we execute the following command. It will generate a <code>deps-lock.json</code> file. We will refer it in the <code>flake.nix</code>.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-bash\"><html><head></head><body>nix run github:jlesquembre/clj-nix#deps-lock\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-orgf2a8b12\" class=\"outline-2\">\n<a href=\"#orgf2a8b12\"><h2 id=\"orgf2a8b12\" class=\"cr-self-reference \">flake.nix</h2></a>\n<div class=\"outline-text-2\" id=\"text-orgf2a8b12\">\n<blockquote>\n<p>\nThe following nix script takes heavy inspiration from <a href=\"https://github.com/jlesquembre/clj-nix/issues/14#issuecomment-2661208232\">this github issue comment</a>.\n</p>\n</blockquote>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-nix\"><html><head></head><body>{\n  <span class=\"hljs-attr\">description</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;&quot;</span>;\n  <span class=\"hljs-attr\">inputs.flake-utils.url</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;github:numtide/flake-utils&quot;</span>;\n  <span class=\"hljs-attr\">inputs.nixpkgs.url</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;github:NixOS/nixpkgs/nixos-unstable&quot;</span>;\n  <span class=\"hljs-attr\">inputs.clj-nix.url</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;github:jlesquembre/clj-nix&quot;</span>;\n  <span class=\"hljs-attr\">outputs</span> <span class=\"hljs-operator\">=</span> { self, flake-utils, nixpkgs, clj-nix }:\n    flake-utils.lib.eachDefaultSystem (<span class=\"hljs-params\">system:</span>\n      <span class=\"hljs-keyword\">let</span>\n        <span class=\"hljs-attr\">pkgs</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-built_in\">import</span> nixpkgs {\n          <span class=\"hljs-keyword\">inherit</span> system;\n          <span class=\"hljs-attr\">overlays</span> <span class=\"hljs-operator\">=</span> [\n            clj-nix.overlays.default\n          ];\n        };\n      <span class=\"hljs-keyword\">in</span> {\n        <span class=\"hljs-attr\">packages.default</span> <span class=\"hljs-operator\">=</span> pkgs.buildNpmPackage <span class=\"hljs-keyword\">rec</span> {\n          <span class=\"hljs-attr\">pname</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;proj-name&quot;</span>;\n          <span class=\"hljs-attr\">nativeBuildInputs</span> <span class=\"hljs-operator\">=</span> [ pkgs.babashka pkgs.clojure ];\n          <span class=\"hljs-attr\">npmBuildScript</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;release&quot;</span>;\n          <span class=\"hljs-attr\">version</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;0.0.1&quot;</span>;\n          <span class=\"hljs-attr\">src</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">${self}</span>&quot;</span>;\n          <span class=\"hljs-comment\"># deps hash from previous prefetch-npm-deps</span>\n          <span class=\"hljs-attr\">npmDepsHash</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;sha256-0000=&quot;</span>;\n          <span class=\"hljs-comment\"># deps-lock.json generated by github:jlesquembre/clj-nix#deps-lock</span>\n          <span class=\"hljs-attr\">deps-cache</span> <span class=\"hljs-operator\">=</span> pkgs.mk-deps-cache { <span class=\"hljs-attr\">lockfile</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-symbol\">./deps-lock.json</span>; };\n          <span class=\"hljs-attr\">preBuild</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">''\n            bb -e '(-&gt; (slurp &quot;deps.edn&quot;)\n                       rewrite-clj.zip/of-string\n                       (rewrite-clj.zip/assoc :mvn/local-repo &quot;<span class=\"hljs-subst\">${deps-cache}</span>/.m2/repository&quot;)\n                       rewrite-clj.zip/root-string\n                       (#(spit &quot;deps.edn&quot; %)))'\n          ''</span>;\n        };\n      }\n    );\n}\n</body></html></code></pre>\n</div>\n\n<p>\nIn the <code>preBuild</code> script, we rewrite <code>deps.edn</code> file to tell <code>clj</code> to find dependencies in a local maven repo generated by <code>mk-deps-cache</code>, which is provided by <code>clj-nix</code> overlay. We then fill <code>npmDepsHash</code> with the value we got from previous commands.\n</p>\n\n<p>\nWith this <code>flake.nix</code>, we can then build the project with <code>nix build .</code> or run the script with <code>nix run .</code>.\n</p>\n\n<p>\nYou can check <a href=\"https://github.com/imakira/espoir\">this little project of mine</a> for a working example.\n</p>\n</div>\n</div>\n<div id=\"outline-container-org9225a55\" class=\"outline-2\">\n<a href=\"#org9225a55\"><h2 id=\"org9225a55\" class=\"cr-self-reference \"><span class=\"todo TODO\">TODO</span> Limitations</h2></a>\n<div class=\"outline-text-2\" id=\"text-org9225a55\">\n<p>\nThe hack in <code>preBuild</code> only deals with dependencies pulled from maven repos. Git dependencies aren't probably handled.\n</p>\n</div>\n</div>\n","published-date":"2025-11-03T17:25:27+08:00","title":"Build a ClojureScript Application Running on Node Using Nix","show-toc?":true,"author":null,"language":"en_US","id":"build-a-clojurescript-application-running-on-node-using-nix","file-path":"/home/void/Projects/imakira.github.io/blogs/build-a-clojurescript-application-running-on-node-using-nix.org","modified-date":"2025-11-03T17:23:59+08:00"}