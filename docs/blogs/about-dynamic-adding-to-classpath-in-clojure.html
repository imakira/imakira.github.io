<!DOCTYPE html><html class="no-js" lang="en"><head><meta charset="utf-8" /><meta content="ie=edge" http-equiv="x-ua-compatible" /><meta content="Well, I guess people will just inevitably get into the problem of  classpath , one way or another.  The Classpath is a Lie  described the problem very well..." name="description" /><meta content="width=device-width, initial-scale=1" name="viewport" /><title>About Dynamic Adding to Classpath in Clojure | Coruscation.net</title><link href="https://fonts.googleapis.com" rel="preconnect" /><link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" /><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&amp;display=swap" rel="stylesheet" /><link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&amp;icon_names=keyboard_arrow_down" rel="stylesheet" /><link href="/main.css?v=1769345769464" rel="stylesheet" /><link href="https://coruscation.net/atom.xml" rel="alternate" title="Coruscation.net" type="application/rss+xml" /><link href="/js/main.js" rel="modulepreload" /><link href="/js/./orgx.about-dynamic-adding-to-classpath-in-clojure.js" rel="modulepreload" /></head><body><div id="root"><div class="app h-dvh w-full xl:grid xl:grid-cols-[20rem_9fr]"><div class="transition-all"><div class="bg-opacity-100 px-4 relative bg-[#0260B3] sm:flex sm:justify-between block gap-4 xl:grid xl:grid-cols-[2fr_3fr] xl:h-dvh xl:fixed xl:w-[20rem]"><a class="flex justify-center block" href="/"><span class="text-3xl text-cyan-50 pt-4 sm:py-6 xl:sideways-lr xl:text-6xl xl:pb-8">Coruscation.net</span></a><div class="flex justify-center"><div class="flex flex-col items-center justify-end py-1 relative left-[0.275rem] sm:items-end xl:justify-between"><div class="navigator-bar gap-3 text-base text-slate-50 opacity-80 flex px-5 my-2 xl:text-2xl xl:flex-col xl:pt-6"><div class="px-1 group-hover:text-cyan-50 text-lg"><a href="/">HOME</a></div><div class="px-1 group-hover:text-cyan-50 text-lg"><a href="https://github.com/imakira">ABOUT</a></div><div class="px-1 group-hover:text-cyan-50 text-lg"><a href="https://github.com/imakira">PROJECTS</a></div></div><div class="justify-center w-full mb-8 relative hidden xl:flex"><div class="flex relative"><a href="/atom.xml"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="40" height="32">&lt;!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc. --&gt;<path d="M64 32C28.7 32 0 60.7 0 96L0 416c0 35.3 28.7 64 64 64l320 0c35.3 0 64-28.7 64-64l0-320c0-35.3-28.7-64-64-64L64 32zM96 136c0-13.3 10.7-24 24-24c137 0 248 111 248 248c0 13.3-10.7 24-24 24s-24-10.7-24-24c0-110.5-89.5-200-200-200c-13.3 0-24-10.7-24-24zm0 96c0-13.3 10.7-24 24-24c83.9 0 152 68.1 152 152c0 13.3-10.7 24-24 24s-24-10.7-24-24c0-57.4-46.6-104-104-104c-13.3 0-24-10.7-24-24zm0 120a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"></path></svg></a><a href="https://github.com/imakira/cerulean"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" width="40" height="32">&lt;!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc. --&gt;<path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a href=""><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="40" height="32">&lt;!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc. --&gt;<path d="M64 32C28.7 32 0 60.7 0 96L0 416c0 35.3 28.7 64 64 64l320 0c35.3 0 64-28.7 64-64l0-320c0-35.3-28.7-64-64-64L64 32zM218 271.7L64.2 172.4C66 156.4 79.5 144 96 144l256 0c16.5 0 30 12.4 31.8 28.4L230 271.7c-1.8 1.2-3.9 1.8-6 1.8s-4.2-.6-6-1.8zm29.4 26.9L384 210.4 384 336c0 17.7-14.3 32-32 32L96 368c-17.7 0-32-14.3-32-32l0-125.6 136.6 88.2c7 4.5 15.1 6.9 23.4 6.9s16.4-2.4 23.4-6.9z"></path></svg></a></div></div></div></div></div></div><main class="pt-5 px-2 sm:px-4 xl:pt-7 xl:px-8"><div class="px-4 relative"><div><h1 class="font-medium text-neutral-700 leading-tight text-2xl sm:text-[2rem]">About Dynamic Adding to Classpath in Clojure</h1><hr class="border-t-1 border-slate-500 w-full my-3"/><div class="text-base grid items-center text-gray-700 pl-[1px] grid-cols-[7rem_1fr]"><div class="text-sky-700 border-l-2 pl-2 text-lg">Coding</div><span class="flex items-center gap-4"><span class="flex items-center gap-2"><span class="text-gray-600">Pub.</span><span class="text-base text-gray-700">Jan 25, 2026</span></span><span class="flex items-center gap-2"><span class="text-gray-600">Upd.</span><span class="text-base text-gray-700">Jan 25, 2026</span></span></span></div></div><div></div><input id="toc-mobile-control" class="hidden" type="checkbox"/><label class=" toc-header cursor-pointer select-none block text-sky-700 border-1 pl-2  flex justify-between items-center mt-3 bg-white sticky top-0 h-8 pr-1  md:hidden ml-[1px] relative " for="toc-mobile-control"><div class="relative h-full w-full overflow-hidden"><div class="text-lg toc-header-text relative  w-full transition-all "><div class="h-8 w-96">Table Of Content</div><div class="h-8 w-96 overflow-hidden">Use Builtin  clojure.core/add-classpath</div><div class="h-8 w-96 overflow-hidden">Use  add-classpath  from  pomegranate</div><div class="h-8 w-96 overflow-hidden">Create a  DynamicClassLoader  When There isn&#x27;t One</div><div class="h-8 w-96 overflow-hidden">When Using  kaocha</div><div class="h-8 w-96 overflow-hidden">A Few More Words</div><div class="h-8 w-96 overflow-hidden">Links</div></div></div><span class="material-symbols-outlined checked:rotate-180 transition-all dropdown-icon">keyboard_arrow_down</span></label><div class="toc-mobile-wrapper2 h-1 sticky top-8"><div class="grid toc-mobile-wrapper transition-all border-neutral-400 border-l-1 bg-white md:hidden ml-[1px] "><ul class="toc-mobile-content text-[1.05rem] 2xl:text-lg "><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#use-builtin-~clojure.core/add-classpath~"><span>Use Builtin  clojure.core/add-classpath</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#use-~add-classpath~-from-~pomegranate~"><span>Use  add-classpath  from  pomegranate</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#create-a-~dynamicclassloader~-when-there-isn&#x27;t-one"><span>Create a  DynamicClassLoader  When There isn&#x27;t One</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#when-using-~kaocha~"><span>When Using  kaocha</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#a-few-more-words"><span>A Few More Words</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#links"><span>Links</span></a></div></div></div></li></ul></div></div><div class="gap-8 w-full h-full md:grid md:grid-cols-[minmax(0px,7fr)_minmax(17rem,17rem)] 2xl:grid-cols-[minmax(0px,7fr)_minmax(20rem,20rem)]"><div class="cr-document md:mt-1"><p>
Well, I guess people will just inevitably get into the problem of <code>classpath</code>, one way or another. <a href="https://lambdaisland.com/blog/2021-08-25-classpath-is-a-lie">The Classpath is a Lie</a> described the problem very well: <i>classpath is a lie</i>. <code>classpath</code>, <i>per se</i>, is a simple list separated by colons, however, the real work is done by the <code>Classloader</code>.
</p><p>
Nevertheless, this isn&#x27;t a post talking about <code>classpath</code> and <code>ClassLoader</code>. There are already a lot of great articles talking about it (<a href="#links">links</a> at the end of this post), and I can&#x27;t claim I understand <code>ClassLoaders</code> to the extent that I can confidently teach others about it either.
</p><p>
This is a blog about what I have found during the process of trying to add new directories to <code>classpath</code> and <code>require</code> Clojure files in them at runtime. <code>ClassLoader</code> in Clojure is something very messy. The best strategy probably is to avoid the problem altogether. But still, if you really want to do it, I wish the following content can offer some help.
</p><div id="outline-container-use-builtin-~clojure.core/add-classpath~" class="outline-2"><a href="#use-builtin-~clojure.core/add-classpath~"><h2 id="use-builtin-~clojure.core/add-classpath~" class="cr-self-reference ">Use Builtin <code>clojure.core/add-classpath</code></h2></a><div id="text-use-builtin-~clojure.core/add-classpath~" class="outline-text-2"><p><code>Clojure</code> has a builtin <code>add-classpath</code> function. Although it has been deprecated, it works for simple use cases.
</p><div class="org-src-container"><pre class="cr-highlighted"><code class="lang-clojure">(<span class="hljs-keyword">defn</span> <span class="hljs-title">check-dynamic-load</span> []
  (<span class="hljs-name"><span class="hljs-built_in">let</span></span> [tmp-dir (<span class="hljs-name">.toFile</span> (<span class="hljs-name">Files/createTempDirectory</span> <span class="hljs-string">&quot;classpath-demo&quot;</span> (<span class="hljs-name"><span class="hljs-built_in">into-array</span></span> java.nio.file.attribute.FileAttribute [])))
        tmp-clj (<span class="hljs-name">File/createTempFile</span> <span class="hljs-string">&quot;demo&quot;</span> <span class="hljs-string">&quot;.clj&quot;</span> tmp-dir)
        tmp-name (<span class="hljs-name">subs</span> (<span class="hljs-name">.getName</span> tmp-clj)
                       <span class="hljs-number">0</span>
                       (<span class="hljs-name">.lastIndexOf</span> (<span class="hljs-name">.getName</span> tmp-clj)
                                     <span class="hljs-string">&quot;.&quot;</span>))]
    <span class="hljs-comment">;; Add `tmp-dir` to `classpath` using builtin `add-classpath`.</span>
    (<span class="hljs-name">add-classpath</span> (<span class="hljs-name">.toURL</span> tmp-dir))

    <span class="hljs-comment">;; Put a Clojure file under the directory</span>
    (<span class="hljs-name">spit</span> tmp-clj
          (<span class="hljs-name"><span class="hljs-built_in">str</span></span> <span class="hljs-string">&quot;(ns &quot;</span> tmp-name <span class="hljs-string">&quot;) (def a 1)&quot;</span>))
                                        <span class="hljs-comment">;</span>
    <span class="hljs-comment">;; `require` the Clojure file, and resolve the variable</span>
    (<span class="hljs-name"><span class="hljs-built_in">assert</span></span> (<span class="hljs-name"><span class="hljs-built_in">=</span></span> <span class="hljs-number">1</span> (<span class="hljs-name">var-get</span> (<span class="hljs-name">requiring-resolve</span> (<span class="hljs-name"><span class="hljs-built_in">symbol</span></span> tmp-name
                                                     <span class="hljs-string">&quot;a&quot;</span>)))))

    <span class="hljs-comment">;; Update the Clojure file</span>
    (<span class="hljs-name">spit</span> tmp-clj
          (<span class="hljs-name"><span class="hljs-built_in">str</span></span> <span class="hljs-string">&quot;(ns &quot;</span> tmp-name <span class="hljs-string">&quot;) (def a 2)&quot;</span>))

    <span class="hljs-comment">;; Reload the Clojure file</span>
    (<span class="hljs-name">require</span> (<span class="hljs-name"><span class="hljs-built_in">symbol</span></span> tmp-name)
             <span class="hljs-symbol">:reload-all</span>)

    <span class="hljs-comment">;; We can read the new value</span>
    (<span class="hljs-name"><span class="hljs-built_in">assert</span></span> (<span class="hljs-name"><span class="hljs-built_in">=</span></span> <span class="hljs-number">2</span> (<span class="hljs-name">var-get</span> (<span class="hljs-name">requiring-resolve</span> (<span class="hljs-name"><span class="hljs-built_in">symbol</span></span> tmp-name
                                                     <span class="hljs-string">&quot;a&quot;</span>)))))
    (<span class="hljs-name">println</span> <span class="hljs-string">&quot;success&quot;</span>)))

<span class="hljs-comment">;; success</span>
(<span class="hljs-name">check-dynamic-load</span>)
</code></pre></div><p>
If we evaluate the above code in a REPL or in cider, it works and prints &quot;success&quot;. As we can see from the code, we can <code>require</code> a Clojure file whose path determined at runtime, and reload it to get the updated value.
</p><p>
However, there is a reason of it being deprecated. We can check its source code:
</p><div class="org-src-container"><pre class="cr-highlighted"><code class="lang-java"><span class="hljs-comment">// The method used by clojure.core/add-classpath</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addURL</span><span class="hljs-params">(Object url)</span> <span class="hljs-keyword">throws</span> MalformedURLException{
      <span class="hljs-type">URL</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> (url <span class="hljs-keyword">instanceof</span> String) ? toUrl((String) url) : (URL) url;
      <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">ccl</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();
      <span class="hljs-keyword">if</span>(ccl <span class="hljs-keyword">instanceof</span> DynamicClassLoader)
              ((DynamicClassLoader)ccl).addURL(u);
      <span class="hljs-keyword">else</span>
              <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalAccessError</span>(<span class="hljs-string">&quot;Context classloader is not a DynamicClassLoader&quot;</span>);
}
</code></pre></div><p>
It checks if the current thread&#x27;s <code>ContextClassLoader</code> is a <code>DynamicClassLoader</code>. If so, it will call the <code>DynamicClassLoader</code>&#x27;s <code>addURL</code> method.
That means, this method will fail if there&#x27;s some code set the current <code>ContextClassLoader</code> to something other than a <code>DynamicClassLoader</code>.
</p><div><blockquote class="not-italic bg-stone-50 pl-4 py-2 border-l-3  my-4 border-sky-500"><div class="not-italic font-semibold mb-1 text-gray-700">Note</div><div class="not-italic"><p>
We expect <code>add-classpath</code> continues to work in case because the convention of setting a new <code>ClassLoader</code> is to set the current <code>ClassLoader</code> as the parent of the newly created <code>ClassLoader</code>. However, <code>clojure.core/add-classpath</code> only checks the current <code>ClassLoader</code>, more on this in the section.
</p>

</div></blockquote></div><div class="org-src-container"><pre class="cr-highlighted"><code class="lang-clojure">(<span class="hljs-name"><span class="hljs-built_in">let</span></span> [future
      (<span class="hljs-name"><span class="hljs-built_in">future</span></span>
        (<span class="hljs-name"><span class="hljs-built_in">let</span></span> [cl (<span class="hljs-name">.getContextClassLoader</span> (<span class="hljs-name">Thread/currentThread</span>))]
          (<span class="hljs-name">.setContextClassLoader</span> (<span class="hljs-name">Thread/currentThread</span>)
                                  (<span class="hljs-name">java.net.URLClassLoader.</span> (<span class="hljs-name"><span class="hljs-built_in">into-array</span></span> java.net.URL [])
                                                            cl)))
            (<span class="hljs-name"><span class="hljs-built_in">try</span></span> (<span class="hljs-name">check-dynamic-load</span>)
             (<span class="hljs-name"><span class="hljs-built_in">assert</span></span> <span class="hljs-string">&quot;unreachable&quot;</span>)
             (<span class="hljs-name">catch</span> Throwable t
               (<span class="hljs-name">println</span> <span class="hljs-string">&quot;dynamic loading failed&quot;</span>))))]
  <span class="hljs-comment">;; &quot;dynamic loading failed&quot;</span>
  @future)
</code></pre></div></div></div><div id="outline-container-use-~add-classpath~-from-~pomegranate~" class="outline-2"><a href="#use-~add-classpath~-from-~pomegranate~"><h2 id="use-~add-classpath~-from-~pomegranate~" class="cr-self-reference ">Use <code>add-classpath</code> from <code>pomegranate</code></h2></a><div id="text-use-~add-classpath~-from-~pomegranate~" class="outline-text-2"><p><a href="https://github.com/clj-commons/pomegranate">pomegranate</a> provides a <code>add-classpath</code> that solves the problem described in the previous section.
</p><p>
The only thing we need to change is to replace <code>clojure.core/add-classpath</code> with <code>cemerick.pomegranate/add-classpath</code>.
</p><div class="org-src-container"><pre class="cr-highlighted"><code class="lang-clojure">(<span class="hljs-name"><span class="hljs-built_in">ns</span></span> demo
  (<span class="hljs-symbol">:require</span>
   [cemerick.pomegranate <span class="hljs-symbol">:as</span> pomegranate]))

(<span class="hljs-keyword">defn</span> <span class="hljs-title">check-dynamic-load-using-pomegranate</span> []
  (<span class="hljs-name"><span class="hljs-built_in">let</span></span> [<span class="hljs-comment">;; ...</span>
        ]
    <span class="hljs-comment">;; same code as `check-dynamic-load`</span>
    (<span class="hljs-name">pomegranate/add-classpath</span> (<span class="hljs-name">.toURL</span> tmp-dir))
    <span class="hljs-comment">;; same code as `check-dynamic-load`</span>
    ))

(<span class="hljs-name"><span class="hljs-built_in">let</span></span> [future
      (<span class="hljs-name"><span class="hljs-built_in">future</span></span>
        (<span class="hljs-name"><span class="hljs-built_in">let</span></span> [cl (<span class="hljs-name">.getContextClassLoader</span> (<span class="hljs-name">Thread/currentThread</span>))]
          (<span class="hljs-name">.setContextClassLoader</span> (<span class="hljs-name">Thread/currentThread</span>)
                                  (<span class="hljs-name">java.net.URLClassLoader.</span> (<span class="hljs-name"><span class="hljs-built_in">into-array</span></span> java.net.URL [])
                                                            cl)))
        (<span class="hljs-name">check-dynamic-load-using-pomegranate</span>)
        (<span class="hljs-name">print</span> <span class="hljs-string">&quot;success&quot;</span>))]
  <span class="hljs-comment">;; success</span>
  @future)
</code></pre></div><p>
Unlike <code>add-classpath</code> from <code>clojure.core</code>, <code>pomegranate</code>&#x27;s <code>add-classpath</code> try to find the <code>ClassLoader</code> closest to the <i>Primordial ClassLoader</i> that is compatible with <code>add-classpath</code>, and call the <code>addURL</code> method from it.
</p><div class="org-src-container"><pre class="cr-highlighted"><code class="lang-clojure"><span class="hljs-comment">;; in `add-classpath` function in pomegranate.clj  </span>
(<span class="hljs-name"><span class="hljs-built_in">let</span></span> [classloaders (<span class="hljs-name">classloader-hierarchy</span>)]
      (<span class="hljs-name"><span class="hljs-built_in">if-let</span></span> [cl (<span class="hljs-name"><span class="hljs-built_in">last</span></span> (<span class="hljs-name"><span class="hljs-built_in">filter</span></span> modifiable-classloader? classloaders))]
        (<span class="hljs-name">add-classpath</span> jar-or-dir cl)
        (<span class="hljs-name"><span class="hljs-built_in">throw</span></span> (<span class="hljs-name">IllegalStateException.</span> (<span class="hljs-name"><span class="hljs-built_in">str</span></span> <span class="hljs-string">&quot;Could not find a suitable classloader to modify from &quot;</span>
                                            (<span class="hljs-name"><span class="hljs-built_in">mapv</span></span> (<span class="hljs-name"><span class="hljs-built_in">fn</span></span> [^ClassLoader c]
                                                    (<span class="hljs-name"><span class="hljs-built_in">-&gt;</span></span> c .getClass .getSimpleName))
                                                  classloaders))))))
</code></pre></div></div></div><div id="outline-container-create-a-~dynamicclassloader~-when-there-isn't-one" class="outline-2"><a href="#create-a-~dynamicclassloader~-when-there-isn&#x27;t-one"><h2 id="create-a-~dynamicclassloader~-when-there-isn't-one" class="cr-self-reference ">Create a <code>DynamicClassLoader</code> When There isn&#x27;t One</h2></a><div id="text-create-a-~dynamicclassloader~-when-there-isn't-one" class="outline-text-2"><p>
If you are running Clojure in REPL or with <code>nrepl</code>, the <code>ContextClassLoader</code> of the current thread will certainly be <code>DynamicClassLoader</code>, set by one of those tools. However, when you run <code>clj</code> command in a non-interactive manner, or use a AOT-compiled jar file, this wouldn&#x27;t be the case.
</p><p>
This problem is quite easy to solve, we just need to set the <code>ContextClassLoader</code> to a <code>DynamicClassLoader</code> created by ourselves in the entrypoint of the program.
</p><div class="org-src-container"><pre class="cr-highlighted"><code class="lang-clojure">(<span class="hljs-keyword">defn</span> <span class="hljs-title">-main</span> [&amp; args]
  (<span class="hljs-name"><span class="hljs-built_in">let</span></span> [cl (<span class="hljs-name">.getContextClassLoader</span> (<span class="hljs-name">Thread/currentThread</span>))]
    (<span class="hljs-name">.setContextClassLoader</span> (<span class="hljs-name">Thread/currentThread</span>) (<span class="hljs-name">clojure.lang.DynamicClassLoader.</span> cl)))
  <span class="hljs-comment">;; other code...</span>
  )
</code></pre></div></div></div><div id="outline-container-when-using-~kaocha~" class="outline-2"><a href="#when-using-~kaocha~"><h2 id="when-using-~kaocha~" class="cr-self-reference ">When Using <code>kaocha</code></h2></a><div id="text-when-using-~kaocha~" class="outline-text-2"><p>
So far, so good. Except when you finish the code and try to test some code and run it under the <a href="https://github.com/lambdaisland/kaocha">kaocha</a> test runner. <code>kaocha</code> also did its own thing with <code>ClassLoader</code> and provides a <code>add-classpath</code> method. It breaks the previous method.
</p><p>
By detecting <code>kaocha</code>&#x27;s presence and calling its <code>add-classpath</code>, alongside with the <code>pomegranate</code> one solves the issue for me.
</p><div class="org-src-container"><pre class="cr-highlighted"><code class="lang-clojure">(<span class="hljs-name"><span class="hljs-built_in">when</span></span> (<span class="hljs-name">find-ns</span> &#x27;kaocha.classpath)
  ((<span class="hljs-name"><span class="hljs-built_in">intern</span></span> &#x27;kaocha.classpath
           &#x27;add-classpath)
   new-path))
</code></pre></div></div></div><div id="outline-container-a-few-more-words" class="outline-2"><a href="#a-few-more-words"><h2 id="a-few-more-words" class="cr-self-reference ">A Few More Words</h2></a><div id="text-a-few-more-words" class="outline-text-2"><p>
This post is definitely not comprehensive, and there are still a lot things I currently do not understand. The method I have described works for me for now. If you want to understand more about this topic, I have listed a few links below.
</p></div></div><div id="outline-container-links" class="outline-2"><a href="#links"><h2 id="links" class="cr-self-reference ">Links</h2></a><div id="text-links" class="outline-text-2"><ol class="org-ol"><li><a href="https://www.infoworld.com/article/2171026/find-a-way-out-of-the-classloader-maze.html">Find a way out of the ClassLoader maze</a> (2003)</li><li><a href="https://danielsz.github.io/2021-05-12T13_24.html">Once Upon a Class</a></li><li><a href="https://lambdaisland.com/blog/2021-08-25-classpath-is-a-lie">The Classpath is a Lie</a></li></ol></div></div></div><div class="mt-4"><div class="border-neutral-400 border-l-2 text-[1.05rem] 2xl:text-lg w-78 fixed right-0 top-[13.5rem] z-200 max-h-[80vh] overflow-y-auto select-none hidden md:block xl:top-36  2xl:w-96"><ul><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#use-builtin-~clojure.core/add-classpath~"><span>Use Builtin  clojure.core/add-classpath</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#use-~add-classpath~-from-~pomegranate~"><span>Use  add-classpath  from  pomegranate</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#create-a-~dynamicclassloader~-when-there-isn&#x27;t-one"><span>Create a  DynamicClassLoader  When There isn&#x27;t One</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#when-using-~kaocha~"><span>When Using  kaocha</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#a-few-more-words"><span>A Few More Words</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#links"><span>Links</span></a></div></div></div></li></ul></div></div></div></div></main></div></div><script>window.__server_path = "/"</script><script>window.__cerulean_rehydrate = true;</script><script>globalThis["user-config"] = {"title":"Coruscation.net","cname":"coruscation.net","root-url":"https://coruscation.net","author":"imakira","links":{"rss":{"href":"/atom.xml","external?":true},"github":{"href":"https://github.com/imakira/cerulean"},"email":{"path":"me","domain":"coruscation.net"}},"navigation":{"home":{"text":"HOME","href":"/"},"about":{"text":"ABOUT","href":"https://github.com/imakira"},"projects":{"text":"PROJECTS","href":"https://github.com/imakira"}},"special-pages":["about"]};
globalThis["blog/about-dynamic-adding-to-classpath-in-clojure"] = {"blog/orgx":true,"blog/tags":[],"blog/unlisted":false,"blog/title":"About Dynamic Adding to Classpath in Clojure","blog/show-toc?":true,"blog/file-path":"/home/void/Projects/cerulean/workspace/blogs/class-path.org","blog/author":null,"blog/email":null,"blog/description":"Well, I guess people will just inevitably get into the problem of  classpath , one way or another.  The Classpath is a Lie  described the problem very well...","blog/id":"about-dynamic-adding-to-classpath-in-clojure","blog/category":"Coding","blog/language":"en_US","blog/published-date":"2026-01-25T00:00:00+08:00","blog/content":"<p>\nWell, I guess people will just inevitably get into the problem of <code>classpath</code>, one way or another. <a href=\"https://lambdaisland.com/blog/2021-08-25-classpath-is-a-lie\">The Classpath is a Lie</a> described the problem very well: <i>classpath is a lie</i>. <code>classpath</code>, <i>per se</i>, is a simple list separated by colons, however, the real work is done by the <code>Classloader</code>.\n</p>\n\n<p>\nNevertheless, this isn't a post talking about <code>classpath</code> and <code>ClassLoader</code>. There are already a lot of great articles talking about it (<a href=\"#links\">links</a> at the end of this post), and I can't claim I understand <code>ClassLoaders</code> to the extent that I can confidently teach others about it either.\n</p>\n\n<p>\nThis is a blog about what I have found during the process of trying to add new directories to <code>classpath</code> and <code>require</code> Clojure files in them at runtime. <code>ClassLoader</code> in Clojure is something very messy. The best strategy probably is to avoid the problem altogether. But still, if you really want to do it, I wish the following content can offer some help.\n</p>\n<div id=\"outline-container-use-builtin-~clojure.core/add-classpath~\" class=\"outline-2\">\n<a href=\"#use-builtin-~clojure.core/add-classpath~\"><h2 id=\"use-builtin-~clojure.core/add-classpath~\" class=\"cr-self-reference \">Use Builtin <code>clojure.core/add-classpath</code></h2></a>\n<div class=\"outline-text-2\" id=\"text-use-builtin-~clojure.core/add-classpath~\">\n<p>\n<code>Clojure</code> has a builtin <code>add-classpath</code> function. Although it has been deprecated, it works for simple use cases.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">defn</span> <span class=\"hljs-title\">check-dynamic-load</span> []\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [tmp-dir (<span class=\"hljs-name\">.toFile</span> (<span class=\"hljs-name\">Files/createTempDirectory</span> <span class=\"hljs-string\">&quot;classpath-demo&quot;</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> java.nio.file.attribute.FileAttribute [])))\n        tmp-clj (<span class=\"hljs-name\">File/createTempFile</span> <span class=\"hljs-string\">&quot;demo&quot;</span> <span class=\"hljs-string\">&quot;.clj&quot;</span> tmp-dir)\n        tmp-name (<span class=\"hljs-name\">subs</span> (<span class=\"hljs-name\">.getName</span> tmp-clj)\n                       <span class=\"hljs-number\">0</span>\n                       (<span class=\"hljs-name\">.lastIndexOf</span> (<span class=\"hljs-name\">.getName</span> tmp-clj)\n                                     <span class=\"hljs-string\">&quot;.&quot;</span>))]\n    <span class=\"hljs-comment\">;; Add `tmp-dir` to `classpath` using builtin `add-classpath`.</span>\n    (<span class=\"hljs-name\">add-classpath</span> (<span class=\"hljs-name\">.toURL</span> tmp-dir))\n\n    <span class=\"hljs-comment\">;; Put a Clojure file under the directory</span>\n    (<span class=\"hljs-name\">spit</span> tmp-clj\n          (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> <span class=\"hljs-string\">&quot;(ns &quot;</span> tmp-name <span class=\"hljs-string\">&quot;) (def a 1)&quot;</span>))\n                                        <span class=\"hljs-comment\">;</span>\n    <span class=\"hljs-comment\">;; `require` the Clojure file, and resolve the variable</span>\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">assert</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">=</span></span> <span class=\"hljs-number\">1</span> (<span class=\"hljs-name\">var-get</span> (<span class=\"hljs-name\">requiring-resolve</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">symbol</span></span> tmp-name\n                                                     <span class=\"hljs-string\">&quot;a&quot;</span>)))))\n\n    <span class=\"hljs-comment\">;; Update the Clojure file</span>\n    (<span class=\"hljs-name\">spit</span> tmp-clj\n          (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> <span class=\"hljs-string\">&quot;(ns &quot;</span> tmp-name <span class=\"hljs-string\">&quot;) (def a 2)&quot;</span>))\n\n    <span class=\"hljs-comment\">;; Reload the Clojure file</span>\n    (<span class=\"hljs-name\">require</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">symbol</span></span> tmp-name)\n             <span class=\"hljs-symbol\">:reload-all</span>)\n\n    <span class=\"hljs-comment\">;; We can read the new value</span>\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">assert</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">=</span></span> <span class=\"hljs-number\">2</span> (<span class=\"hljs-name\">var-get</span> (<span class=\"hljs-name\">requiring-resolve</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">symbol</span></span> tmp-name\n                                                     <span class=\"hljs-string\">&quot;a&quot;</span>)))))\n    (<span class=\"hljs-name\">println</span> <span class=\"hljs-string\">&quot;success&quot;</span>)))\n\n<span class=\"hljs-comment\">;; success</span>\n(<span class=\"hljs-name\">check-dynamic-load</span>)\n</body></html></code></pre>\n</div>\n\n<p>\nIf we evaluate the above code in a REPL or in cider, it works and prints &quot;success&quot;. As we can see from the code, we can <code>require</code> a Clojure file whose path determined at runtime, and reload it to get the updated value.\n</p>\n\n<p>\nHowever, there is a reason of it being deprecated. We can check its source code:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-java\"><html><head></head><body><span class=\"hljs-comment\">// The method used by clojure.core/add-classpath</span>\n<span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title function_\">addURL</span><span class=\"hljs-params\">(Object url)</span> <span class=\"hljs-keyword\">throws</span> MalformedURLException{\n      <span class=\"hljs-type\">URL</span> <span class=\"hljs-variable\">u</span> <span class=\"hljs-operator\">=</span> (url <span class=\"hljs-keyword\">instanceof</span> String) ? toUrl((String) url) : (URL) url;\n      <span class=\"hljs-type\">ClassLoader</span> <span class=\"hljs-variable\">ccl</span> <span class=\"hljs-operator\">=</span> Thread.currentThread().getContextClassLoader();\n      <span class=\"hljs-keyword\">if</span>(ccl <span class=\"hljs-keyword\">instanceof</span> DynamicClassLoader)\n              ((DynamicClassLoader)ccl).addURL(u);\n      <span class=\"hljs-keyword\">else</span>\n              <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">IllegalAccessError</span>(<span class=\"hljs-string\">&quot;Context classloader is not a DynamicClassLoader&quot;</span>);\n}\n</body></html></code></pre>\n</div>\n\n<p>\nIt checks if the current thread's <code>ContextClassLoader</code> is a <code>DynamicClassLoader</code>. If so, it will call the <code>DynamicClassLoader</code>'s <code>addURL</code> method.\nThat means, this method will fail if there's some code set the current <code>ContextClassLoader</code> to something other than a <code>DynamicClassLoader</code>.\n</p>\n\n<pre class=\"orgx\" data-wrapper=\"use-comp\" data-wrapper-data=\"note\"><p>\nWe expect <code>add-classpath</code> continues to work in case because the convention of setting a new <code>ClassLoader</code> is to set the current <code>ClassLoader</code> as the parent of the newly created <code>ClassLoader</code>. However, <code>clojure.core/add-classpath</code> only checks the current <code>ClassLoader</code>, more on this in the section.\n</p>\n\n</pre>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [future\n      (<span class=\"hljs-name\"><span class=\"hljs-built_in\">future</span></span>\n        (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [cl (<span class=\"hljs-name\">.getContextClassLoader</span> (<span class=\"hljs-name\">Thread/currentThread</span>))]\n          (<span class=\"hljs-name\">.setContextClassLoader</span> (<span class=\"hljs-name\">Thread/currentThread</span>)\n                                  (<span class=\"hljs-name\">java.net.URLClassLoader.</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> java.net.URL [])\n                                                            cl)))\n            (<span class=\"hljs-name\"><span class=\"hljs-built_in\">try</span></span> (<span class=\"hljs-name\">check-dynamic-load</span>)\n             (<span class=\"hljs-name\"><span class=\"hljs-built_in\">assert</span></span> <span class=\"hljs-string\">&quot;unreachable&quot;</span>)\n             (<span class=\"hljs-name\">catch</span> Throwable t\n               (<span class=\"hljs-name\">println</span> <span class=\"hljs-string\">&quot;dynamic loading failed&quot;</span>))))]\n  <span class=\"hljs-comment\">;; &quot;dynamic loading failed&quot;</span>\n  @future)\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-use-~add-classpath~-from-~pomegranate~\" class=\"outline-2\">\n<a href=\"#use-~add-classpath~-from-~pomegranate~\"><h2 id=\"use-~add-classpath~-from-~pomegranate~\" class=\"cr-self-reference \">Use <code>add-classpath</code> from <code>pomegranate</code></h2></a>\n<div class=\"outline-text-2\" id=\"text-use-~add-classpath~-from-~pomegranate~\">\n<p>\n<a href=\"https://github.com/clj-commons/pomegranate\">pomegranate</a> provides a <code>add-classpath</code> that solves the problem described in the previous section.\n</p>\n\n<p>\nThe only thing we need to change is to replace <code>clojure.core/add-classpath</code> with <code>cemerick.pomegranate/add-classpath</code>.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-name\"><span class=\"hljs-built_in\">ns</span></span> demo\n  (<span class=\"hljs-symbol\">:require</span>\n   [cemerick.pomegranate <span class=\"hljs-symbol\">:as</span> pomegranate]))\n\n(<span class=\"hljs-keyword\">defn</span> <span class=\"hljs-title\">check-dynamic-load-using-pomegranate</span> []\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [<span class=\"hljs-comment\">;; ...</span>\n        ]\n    <span class=\"hljs-comment\">;; same code as `check-dynamic-load`</span>\n    (<span class=\"hljs-name\">pomegranate/add-classpath</span> (<span class=\"hljs-name\">.toURL</span> tmp-dir))\n    <span class=\"hljs-comment\">;; same code as `check-dynamic-load`</span>\n    ))\n\n(<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [future\n      (<span class=\"hljs-name\"><span class=\"hljs-built_in\">future</span></span>\n        (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [cl (<span class=\"hljs-name\">.getContextClassLoader</span> (<span class=\"hljs-name\">Thread/currentThread</span>))]\n          (<span class=\"hljs-name\">.setContextClassLoader</span> (<span class=\"hljs-name\">Thread/currentThread</span>)\n                                  (<span class=\"hljs-name\">java.net.URLClassLoader.</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> java.net.URL [])\n                                                            cl)))\n        (<span class=\"hljs-name\">check-dynamic-load-using-pomegranate</span>)\n        (<span class=\"hljs-name\">print</span> <span class=\"hljs-string\">&quot;success&quot;</span>))]\n  <span class=\"hljs-comment\">;; success</span>\n  @future)\n</body></html></code></pre>\n</div>\n\n<p>\nUnlike <code>add-classpath</code> from <code>clojure.core</code>, <code>pomegranate</code>'s <code>add-classpath</code> try to find the <code>ClassLoader</code> closest to the <i>Primordial ClassLoader</i> that is compatible with <code>add-classpath</code>, and call the <code>addURL</code> method from it.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body><span class=\"hljs-comment\">;; in `add-classpath` function in pomegranate.clj  </span>\n(<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [classloaders (<span class=\"hljs-name\">classloader-hierarchy</span>)]\n      (<span class=\"hljs-name\"><span class=\"hljs-built_in\">if-let</span></span> [cl (<span class=\"hljs-name\"><span class=\"hljs-built_in\">last</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">filter</span></span> modifiable-classloader? classloaders))]\n        (<span class=\"hljs-name\">add-classpath</span> jar-or-dir cl)\n        (<span class=\"hljs-name\"><span class=\"hljs-built_in\">throw</span></span> (<span class=\"hljs-name\">IllegalStateException.</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> <span class=\"hljs-string\">&quot;Could not find a suitable classloader to modify from &quot;</span>\n                                            (<span class=\"hljs-name\"><span class=\"hljs-built_in\">mapv</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">fn</span></span> [^ClassLoader c]\n                                                    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">-&gt;</span></span> c .getClass .getSimpleName))\n                                                  classloaders))))))\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-create-a-~dynamicclassloader~-when-there-isn't-one\" class=\"outline-2\">\n<a href=\"#create-a-~dynamicclassloader~-when-there-isn't-one\"><h2 id=\"create-a-~dynamicclassloader~-when-there-isn't-one\" class=\"cr-self-reference \">Create a <code>DynamicClassLoader</code> When There isn't One</h2></a>\n<div class=\"outline-text-2\" id=\"text-create-a-~dynamicclassloader~-when-there-isn't-one\">\n<p>\nIf you are running Clojure in REPL or with <code>nrepl</code>, the <code>ContextClassLoader</code> of the current thread will certainly be <code>DynamicClassLoader</code>, set by one of those tools. However, when you run <code>clj</code> command in a non-interactive manner, or use a AOT-compiled jar file, this wouldn't be the case.\n</p>\n\n<p>\nThis problem is quite easy to solve, we just need to set the <code>ContextClassLoader</code> to a <code>DynamicClassLoader</code> created by ourselves in the entrypoint of the program.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">defn</span> <span class=\"hljs-title\">-main</span> [&amp; args]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [cl (<span class=\"hljs-name\">.getContextClassLoader</span> (<span class=\"hljs-name\">Thread/currentThread</span>))]\n    (<span class=\"hljs-name\">.setContextClassLoader</span> (<span class=\"hljs-name\">Thread/currentThread</span>) (<span class=\"hljs-name\">clojure.lang.DynamicClassLoader.</span> cl)))\n  <span class=\"hljs-comment\">;; other code...</span>\n  )\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-when-using-~kaocha~\" class=\"outline-2\">\n<a href=\"#when-using-~kaocha~\"><h2 id=\"when-using-~kaocha~\" class=\"cr-self-reference \">When Using <code>kaocha</code></h2></a>\n<div class=\"outline-text-2\" id=\"text-when-using-~kaocha~\">\n<p>\nSo far, so good. Except when you finish the code and try to test some code and run it under the <a href=\"https://github.com/lambdaisland/kaocha\">kaocha</a> test runner. <code>kaocha</code> also did its own thing with <code>ClassLoader</code> and provides a <code>add-classpath</code> method. It breaks the previous method.\n</p>\n\n<p>\nBy detecting <code>kaocha</code>'s presence and calling its <code>add-classpath</code>, alongside with the <code>pomegranate</code> one solves the issue for me.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-name\"><span class=\"hljs-built_in\">when</span></span> (<span class=\"hljs-name\">find-ns</span> 'kaocha.classpath)\n  ((<span class=\"hljs-name\"><span class=\"hljs-built_in\">intern</span></span> 'kaocha.classpath\n           'add-classpath)\n   new-path))\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-a-few-more-words\" class=\"outline-2\">\n<a href=\"#a-few-more-words\"><h2 id=\"a-few-more-words\" class=\"cr-self-reference \">A Few More Words</h2></a>\n<div class=\"outline-text-2\" id=\"text-a-few-more-words\">\n<p>\nThis post is definitely not comprehensive, and there are still a lot things I currently do not understand. The method I have described works for me for now. If you want to understand more about this topic, I have listed a few links below.\n</p>\n</div>\n</div>\n<div id=\"outline-container-links\" class=\"outline-2\">\n<a href=\"#links\"><h2 id=\"links\" class=\"cr-self-reference \">Links</h2></a>\n<div class=\"outline-text-2\" id=\"text-links\">\n<ol class=\"org-ol\">\n<li><a href=\"https://www.infoworld.com/article/2171026/find-a-way-out-of-the-classloader-maze.html\">Find a way out of the ClassLoader maze</a> (2003)</li>\n<li><a href=\"https://danielsz.github.io/2021-05-12T13_24.html\">Once Upon a Class</a></li>\n<li><a href=\"https://lambdaisland.com/blog/2021-08-25-classpath-is-a-lie\">The Classpath is a Lie</a></li>\n</ol>\n</div>\n</div>\n","blog/orgx-require":null,"blog/modified-date":"2026-01-25T20:43:45+08:00"};
globalThis["net-coruscation-cerulean-common-pages-225-15about-dynamic-adding-to-classpath-in-clojure"] = "[{:level 1, :content \"Use Builtin  clojure.core/add-classpath\", :id \"use-builtin-~clojure.core/add-classpath~\"} {:level 1, :content \"Use  add-classpath  from  pomegranate\", :id \"use-~add-classpath~-from-~pomegranate~\"} {:level 1, :content \"Create a  DynamicClassLoader  When There isn't One\", :id \"create-a-~dynamicclassloader~-when-there-isn't-one\"} {:level 1, :content \"When Using  kaocha\", :id \"when-using-~kaocha~\"} {:level 1, :content \"A Few More Words\", :id \"a-few-more-words\"} {:level 1, :content \"Links\", :id \"links\"}]\n";</script><script src="/js/./orgx.about-dynamic-adding-to-classpath-in-clojure.js" type="module"></script><script type="module">import * as exps  from '/js/./orgx.about-dynamic-adding-to-classpath-in-clojure.js';
window['__orgx.about-dynamic-adding-to-classpath-in-clojure'] = exps;</script><script defer="defer" src="/js/main.js" type="module"></script></body></html>