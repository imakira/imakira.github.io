<!DOCTYPE html><html class="no-js" lang="en"><head><meta charset="utf-8" /><meta content="ie=edge" http-equiv="x-ua-compatible" /><meta content="Recently I want to have a utility in Clojure that can notify me when there is a change happened in some specified directory. Fortunately Java seems to nati..." name="description" /><meta content="width=device-width, initial-scale=1" name="viewport" /><title>Watching Files with java.nio.file.WatchService and Clojure | Coruscation.net</title><link href="https://fonts.googleapis.com" rel="preconnect" /><link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" /><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&amp;display=swap" rel="stylesheet" /><link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&amp;icon_names=keyboard_arrow_down" rel="stylesheet" /><link href="/main.css?v=1766843427218" rel="stylesheet" /><link href="https://coruscation.net/atom.xml" rel="alternate" title="Coruscation.net" type="application/rss+xml" /><link href="/js/main.js" rel="modulepreload" /></head><body><div id="root"><div class="app h-dvh w-full xl:grid xl:grid-cols-[20rem_9fr]"><div class="transition-all"><div class="bg-opacity-100 px-4 relative bg-[#0260B3] sm:flex sm:justify-between block gap-4 xl:grid xl:grid-cols-[2fr_3fr] xl:h-dvh xl:fixed xl:w-[20rem]"><a class="flex justify-center block" href="/"><span class="text-3xl text-cyan-50 pt-4 sm:py-6 xl:sideways-lr xl:text-6xl xl:pb-8">Coruscation.net</span></a><div class="flex justify-center"><div class="flex flex-col items-center justify-end py-1 relative left-[0.275rem] sm:items-end xl:justify-between"><div class="navigator-bar gap-3 text-base text-slate-50 opacity-80 flex px-5 my-2 xl:text-2xl xl:flex-col xl:pt-6"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300 group-hover:bg-yellow-400"></div><div class="relative w-full h-full"><div class="px-1 group-hover:text-cyan-50 text-lg"><a href="/">HOME</a></div></div></div><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300 group-hover:bg-yellow-400"></div><div class="relative w-full h-full"><div class="px-1 group-hover:text-cyan-50 text-lg"><a href="https://github.com/imakira">ABOUT</a></div></div></div><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300 group-hover:bg-yellow-400"></div><div class="relative w-full h-full"><div class="px-1 group-hover:text-cyan-50 text-lg"><a href="https://github.com/imakira">PROJECTS</a></div></div></div></div><div class="justify-center w-full mb-8 relative hidden xl:flex"><div class="flex relative"><a href="/atom.xml"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="40" height="32">&lt;!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc. --&gt;<path d="M64 32C28.7 32 0 60.7 0 96L0 416c0 35.3 28.7 64 64 64l320 0c35.3 0 64-28.7 64-64l0-320c0-35.3-28.7-64-64-64L64 32zM96 136c0-13.3 10.7-24 24-24c137 0 248 111 248 248c0 13.3-10.7 24-24 24s-24-10.7-24-24c0-110.5-89.5-200-200-200c-13.3 0-24-10.7-24-24zm0 96c0-13.3 10.7-24 24-24c83.9 0 152 68.1 152 152c0 13.3-10.7 24-24 24s-24-10.7-24-24c0-57.4-46.6-104-104-104c-13.3 0-24-10.7-24-24zm0 120a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"></path></svg></a><a href="https://github.com/imakira/cerulean"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" width="40" height="32">&lt;!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc. --&gt;<path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></div></div></div></div></div></div><main class="pt-5 px-2 sm:px-4 xl:pt-7 xl:px-8"><div class="px-4 relative"><div><h1 class="font-medium text-neutral-700 leading-tight text-2xl sm:text-[2rem]">Watching Files with java.nio.file.WatchService and Clojure</h1><hr class="border-t-1 border-slate-500 w-full my-3"/><div class="text-base grid items-center text-gray-700 pl-[1px] grid-cols-[7rem_1fr]"><div class="text-sky-700 border-l-2 pl-2 text-lg">Coding</div><span class="flex items-center gap-4"><span class="flex items-center gap-2"><span class="text-gray-600">Pub.</span><span class="text-base text-gray-700">Dec 13, 2025</span></span><span class="flex items-center gap-2"><span class="text-gray-600">Upd.</span><span class="text-base text-gray-700">Dec 14, 2025</span></span></span></div></div><div></div><input id="toc-mobile-control" class="hidden" type="checkbox"/><label class=" toc-header cursor-pointer select-none block text-sky-700 border-1 pl-2  flex justify-between items-center mt-3 bg-white sticky top-0 h-8 pr-1  md:hidden ml-[1px] relative " for="toc-mobile-control"><div class="relative h-full w-full overflow-hidden"><div class="text-lg toc-header-text relative  w-full transition-all "><div class="h-8 w-96">Table Of Content</div><div class="h-8 w-96 overflow-hidden">The Problem</div><div class="h-8 w-96 overflow-hidden">The Workaround</div><div class="h-8 w-96 overflow-hidden">How is it Handled by Other Projects?</div><div class="h-8 w-96 overflow-hidden">chokidar</div><div class="h-8 w-96 overflow-hidden">inotify-tools</div><div class="h-8 w-96 overflow-hidden">Conclusion</div></div></div><span class="material-symbols-outlined checked:rotate-180 transition-all dropdown-icon">keyboard_arrow_down</span></label><div class="toc-mobile-wrapper2 h-1 sticky top-8"><div class="grid toc-mobile-wrapper transition-all border-neutral-400 border-l-1 bg-white md:hidden ml-[1px] "><ul class="toc-mobile-content text-[1.05rem] 2xl:text-lg "><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#the-problem"><span>The Problem</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#the-workaround"><span>The Workaround</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#how-is-it-handled-by-other-projects?"><span>How is it Handled by Other Projects?</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-8" href="#chokidar"><span>chokidar</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-8" href="#inotify-tools"><span>inotify-tools</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#conclusion"><span>Conclusion</span></a></div></div></div></li></ul></div></div><div class="gap-8 w-full h-full md:grid md:grid-cols-[minmax(0px,7fr)_minmax(17rem,17rem)] 2xl:grid-cols-[minmax(0px,7fr)_minmax(20rem,20rem)]"><div class="cr-document md:mt-1"><p>
Recently I want to have a utility in Clojure that can notify me when there is a change happened in some specified directory. Fortunately Java seems to natively support it by providing a <code>java.nio.file.WatchService</code>. It seems trivial so I want to use it directly in Clojure instead of adding another dependency to my project. It turns out to be sightly more complicated than I expected. Let me explain.
</p>
<div id="outline-container-the-problem" class="outline-2">
<a href="#the-problem"><h2 id="the-problem" class="cr-self-reference ">The Problem</h2></a>
<div class="outline-text-2" id="text-the-problem">
<p>
The challenge mainly lies in the fact that, Java doesn't natively support recursively watching a directory. If we want this behavoir, we have to implement it ourselves.
</p>

<div class="org-src-container">
<pre class="cr-highlighted"><code class="lang-clojure"><html><head></head><body>(<span class="hljs-keyword">def</span> ^<span class="hljs-symbol">:dynamic</span> <span class="hljs-title">*chan-size*</span> <span class="hljs-number">512</span>)

(<span class="hljs-keyword">defn</span> <span class="hljs-title">register</span> [^Path path ^WatchService watch-service]
  (<span class="hljs-name">.register</span> path
             watch-service
             (<span class="hljs-name"><span class="hljs-built_in">into-array</span></span> WatchEvent$Kind
                         [StandardWatchEventKinds/ENTRY_CREATE
                          StandardWatchEventKinds/ENTRY_DELETE
                          StandardWatchEventKinds/ENTRY_MODIFY
                          StandardWatchEventKinds/OVERFLOW])))

(<span class="hljs-keyword">defn</span> <span class="hljs-title">watch</span> [&amp; paths]
  (<span class="hljs-name"><span class="hljs-built_in">let</span></span> [resp-chan (<span class="hljs-name">a/chan</span> *chan-size*)
        cancel-chan (<span class="hljs-name">a/chan</span> <span class="hljs-number">1</span>)
        stopped? (<span class="hljs-name"><span class="hljs-built_in">atom</span></span> <span class="hljs-literal">false</span>)

        worker
        (<span class="hljs-name"><span class="hljs-built_in">future</span></span>
          (<span class="hljs-name"><span class="hljs-built_in">let</span></span> [paths (<span class="hljs-name"><span class="hljs-built_in">map</span></span> (<span class="hljs-name"><span class="hljs-built_in">fn</span></span> [p]
                             (<span class="hljs-name">Path/of</span> p (<span class="hljs-name"><span class="hljs-built_in">into-array</span></span> String [])))
                           paths)
                watch-service (<span class="hljs-name"><span class="hljs-built_in">-&gt;</span></span> (<span class="hljs-name">java.nio.file.FileSystems/getDefault</span>)
                                  (<span class="hljs-name">.newWatchService</span>))]
            (<span class="hljs-name"><span class="hljs-built_in">doseq</span></span> [path paths]
              (<span class="hljs-name"><span class="hljs-built_in">doseq</span></span> [^File subpath-file (<span class="hljs-name">file-seq</span> (<span class="hljs-name">.toFile</span> path))]
                (<span class="hljs-name"><span class="hljs-built_in">when</span></span> (<span class="hljs-name">.isDirectory</span> subpath-file)
                  (<span class="hljs-name">register</span> (<span class="hljs-name">.toPath</span> subpath-file)
                            watch-service))))
            (<span class="hljs-name"><span class="hljs-built_in">try</span></span>
              (<span class="hljs-name"><span class="hljs-built_in">while</span></span> (<span class="hljs-name"><span class="hljs-built_in">not</span></span> @stopped?)
                (<span class="hljs-name"><span class="hljs-built_in">let</span></span> [watch-key (<span class="hljs-name">.take</span> watch-service)
                      events (<span class="hljs-name">.pollEvents</span> watch-key)
                      ^Path parent-dir (<span class="hljs-name">.watchable</span> watch-key)]
                  (<span class="hljs-name"><span class="hljs-built_in">doseq</span></span> [^WatchEvent event events]
                    (<span class="hljs-name"><span class="hljs-built_in">let</span></span> [^WatchEvent$Kind kind (<span class="hljs-name">.kind</span> event)
                          ^Path event-path (<span class="hljs-name">.context</span> event)
                          ^Path resolved-path (<span class="hljs-name">.resolve</span> parent-dir event-path)]
                      (<span class="hljs-name">a/&gt;!!</span> resp-chan
                             {<span class="hljs-symbol">:kind</span> (<span class="hljs-name"><span class="hljs-built_in">case</span></span> (<span class="hljs-name">.name</span> kind)
                                      <span class="hljs-string">&quot;ENTRY_CREATE&quot;</span> <span class="hljs-symbol">:entry-create</span>
                                      <span class="hljs-string">&quot;ENTRY_MODIFY&quot;</span> <span class="hljs-symbol">:entry-modify</span>
                                      <span class="hljs-string">&quot;ENTRY_DELETE&quot;</span> <span class="hljs-symbol">:entry-delete</span>
                                      <span class="hljs-string">&quot;OVERFLOW&quot;</span> <span class="hljs-symbol">:overflow</span>)
                              <span class="hljs-symbol">:path</span> resolved-path})

                      <span class="hljs-comment">;; If the newly created object is a directory,</span>
                      <span class="hljs-comment">;;   we recursively register files in it.</span>
                          (<span class="hljs-name"><span class="hljs-built_in">when</span></span> (<span class="hljs-name"><span class="hljs-built_in">and</span></span> (<span class="hljs-name"><span class="hljs-built_in">=</span></span> kind StandardWatchEventKinds/ENTRY_CREATE)
                                 (<span class="hljs-name">.isDirectory</span> (<span class="hljs-name">.toFile</span> resolved-path)))
                        (<span class="hljs-name"><span class="hljs-built_in">doseq</span></span> [^File subpath-file (<span class="hljs-name">file-seq</span> (<span class="hljs-name">.toFile</span> resolved-path))]
                          (<span class="hljs-name"><span class="hljs-built_in">when</span></span> (<span class="hljs-name">.isDirectory</span> subpath-file)
                            (<span class="hljs-name">register</span> (<span class="hljs-name">.toPath</span> subpath-file)
                                      watch-service))))
                      (<span class="hljs-name">.reset</span> watch-key)))))
              (<span class="hljs-name">catch</span> InterruptedException _)
              (<span class="hljs-name">finally</span>
                (<span class="hljs-name">.close</span> watch-service)))))

        sentinel (<span class="hljs-name"><span class="hljs-built_in">future</span></span>
                   (<span class="hljs-name"><span class="hljs-built_in">while</span></span> (<span class="hljs-name"><span class="hljs-built_in">not</span></span> (<span class="hljs-name">a/&lt;!!</span> cancel-chan)))
                   (<span class="hljs-name"><span class="hljs-built_in">reset!</span></span> stopped? <span class="hljs-literal">true</span>)
                   (<span class="hljs-name">future-cancel</span> worker)
                   (<span class="hljs-name">a/close!</span> resp-chan)
                   (<span class="hljs-name">a/close!</span> cancel-chan))]
    (<span class="hljs-name"><span class="hljs-built_in">with-meta</span></span> [resp-chan cancel-chan]
      {<span class="hljs-symbol">:debug</span> {<span class="hljs-symbol">:worker</span> worker
               <span class="hljs-symbol">:sentinel</span> sentinel
               <span class="hljs-symbol">:stopped?</span> stopped?}})))
</body></html></code></pre>
</div>

<p>
The initial implementation looks like this, which is fairly straightforward. We start by recursively registering files in the directories provided by <code>paths</code> argument, and if there is a newly created directory, we also recursively register its contents. Clojure provides a <code>file-seq</code> function that makes this task much easier. For an example usage of this code, check the end of this post.
</p>

<p>
However, there is only one issue: If a file is created in a subdirectory before the subdirectory got registered, the event won't be fired.
</p>

<pre class="example" id="org09005b9">+---------------+
| worker thread |
+-------+-------+
        +                 +---------------+
        +-----------------| create subdir |
        |                 +---------------+
+-------+---------------+
| event: subdir created |
+-------+---------------+    
        |                 +------------------------+
        +-----------------+ new file in the subdir |
        |                 +------------------------+
+-------+-----------+
| subdir registered |
+-------------------+
</pre>
</div>
</div>
<div id="outline-container-the-workaround" class="outline-2">
<a href="#the-workaround"><h2 id="the-workaround" class="cr-self-reference ">The Workaround</h2></a>
<div class="outline-text-2" id="text-the-workaround">
<p>
We can have a workaround of this by emitting an event of each file in the newly created directory, like this:
</p>

<div class="org-src-container">
<pre class="cr-highlighted"><code class="lang-clojure"><html><head></head><body>(<span class="hljs-name"><span class="hljs-built_in">when</span></span> (<span class="hljs-name"><span class="hljs-built_in">and</span></span> (<span class="hljs-name"><span class="hljs-built_in">=</span></span> kind StandardWatchEventKinds/ENTRY_CREATE)
           (<span class="hljs-name">.isDirectory</span> (<span class="hljs-name">.toFile</span> resolved-path)))

  (<span class="hljs-name">register</span> resolved-path
            watch-service)

  (<span class="hljs-name"><span class="hljs-built_in">doseq</span></span> [^File subpath-file (<span class="hljs-name"><span class="hljs-built_in">rest</span></span> (<span class="hljs-name">file-seq</span> (<span class="hljs-name">.toFile</span> resolved-path)))]
    (<span class="hljs-name"><span class="hljs-built_in">when</span></span> (<span class="hljs-name">.isDirectory</span> subpath-file)
      (<span class="hljs-name">register</span> (<span class="hljs-name">.toPath</span> subpath-file)
                watch-service))
    (<span class="hljs-name">a/&gt;!!</span> resp-chan
           {<span class="hljs-symbol">:kind</span> <span class="hljs-symbol">:entry-create</span>
            <span class="hljs-symbol">:path</span> (<span class="hljs-name">.toPath</span> subpath-file)})))
</body></html></code></pre>
</div>

<p>
However, it introduces a new problem. If a file is created in a subdirectory after be subdirectory is regsitered, but before the subdirectories scanning is finished. The event of the file may be emitted twice.
</p>

<pre class="example" id="orgb332a07">  +---------------+
  | worker thread |
  +-------+-------+
          +                +----------------+
          +----------------+ subdir created |
          |                +----------------+
          |
 +--------+----------+
 | subdir registered |
 +--------+----------+
          |              +-------------------------+
          |--------------+ file1 created in subdir |
          |              +-------------------------+
 +--------+---------+
 | scan: find file1 |
 +--------+---------+  
          |               
          |               
+---------+------------+ 
| event: file1 created |
+----------------------+      
</pre>

<p>
We have three choices here, we can:
</p>

<ul class="org-ul">
<li>ignore this issue, treat it as something acceptable.</li>
<li>discard the workaround all together, let the user scan if there is any new file in the newly created directory.</li>
<li>memorize all the files detected, check if the event has already been fired if a new file is detected.</li>
</ul>

<p>
In my case, the first option is good enough, however, it got me curious about how this issue is handled by other projects.
</p>
</div>
</div>
<div id="outline-container-how-is-it-handled-by-other-projects?" class="outline-2">
<a href="#how-is-it-handled-by-other-projects?"><h2 id="how-is-it-handled-by-other-projects?" class="cr-self-reference ">How is it Handled by Other Projects?</h2></a>
<div class="outline-text-2" id="text-how-is-it-handled-by-other-projects?">
</div>
<div id="outline-container-chokidar" class="outline-3">
<a href="#chokidar"><h3 id="chokidar" class="cr-self-reference ">chokidar</h3></a>
<div class="outline-text-3" id="text-chokidar">
<p>
<a href="https://github.com/paulmillr/chokidar">chokidar</a> is a famous file watching library in JavaScript. It seems to have chosen the third option:
</p>

<div class="org-src-container">
<pre class="cr-highlighted"><code class="lang-typescript"><html><head></head><body><span class="hljs-comment">// handler.ts</span>
<span class="hljs-comment">// line starting from 575</span>

<span class="hljs-comment">// Files that present in current directory snapshot</span>
<span class="hljs-comment">// but absent in previous are added to watch list and</span>
<span class="hljs-comment">// emit `add` event.</span>
<span class="hljs-keyword">if</span> (item === target || (!target &amp;&amp; !previous.<span class="hljs-title function_">has</span>(item))) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fsw</span>.<span class="hljs-title function_">_incrReadyCount</span>();

  <span class="hljs-comment">// ensure relativeness of path is preserved in case of watcher reuse</span>
  path = sp.<span class="hljs-title function_">join</span>(dir, sp.<span class="hljs-title function_">relative</span>(dir, path));

  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_addToNodeFs</span>(path, initialAdd, wh, depth + <span class="hljs-number">1</span>);
}
</body></html></code></pre>
</div>
</div>
</div>
<div id="outline-container-inotify-tools" class="outline-3">
<a href="#inotify-tools"><h3 id="inotify-tools" class="cr-self-reference ">inotify-tools</h3></a>
<div class="outline-text-3" id="text-inotify-tools">
<p>
<a href="https://github.com/inotify-tools/inotify-tools">inotify-tools</a> is a set of cli tools providing interface to <code>inotify</code>. It was written in C++ and newer version is rewritten in Rust.
</p>

<p>
By default, <code>inotify-wait</code> quits after it detected a change. Therefore the problem described in the previous section is naturally up to the user to solve.
</p>

<p>
It also provides an <code>--monitor</code> option to continuously monitoring the changes happened in a directory. With <code>--monitor</code> on, it seems to choose the second option described in the previous section.
</p>

<div class="org-src-container">
<pre class="cr-highlighted"><code class="lang-bash"><html><head></head><body>&gt; inotifywait -mr -e create .

Setting up watches.  Beware: since -r was given, this may take a <span class="hljs-keyword">while</span>!
Watches established.

<span class="hljs-comment"># executing `mkdir -p s1/s2/s3/s4` in another shell session</span>

./ CREATE,ISDIR s1
Watching new directory ./s1/
</body></html></code></pre>
</div>

<p>
If we create the directories one by one, all the directories will be notified. However, by using <code>-p</code> option to create multiple level of directories at once. Only the first one will be notified.
</p>

<p>
We can further confirm it by reading the source code:
</p>

<div class="org-src-container">
<pre class="cr-highlighted"><code class="lang-cpp"><html><head></head><body><span class="hljs-comment">// inotifywait.cpp</span>
<span class="hljs-comment">// L391, main function</span>

<span class="hljs-keyword">do</span> {
  event = <span class="hljs-built_in">inotifytools_next_event</span>(timeout);

  <span class="hljs-comment">/*
   * ......
   */</span>

  <span class="hljs-keyword">if</span> (monitor &amp;&amp; recursive) {
    <span class="hljs-keyword">if</span> ((event-&gt;mask &amp; IN_CREATE) ||
        (!moved_from &amp;&amp; (event-&gt;mask &amp; IN_MOVED_TO))) {
      <span class="hljs-comment">// New file - if it is a directory, watch it</span>
      <span class="hljs-type">char</span> *new_file = <span class="hljs-built_in">inotifytools_dirpath_from_event</span>(event);
      <span class="hljs-keyword">if</span> (new_file &amp;&amp; *new_file &amp;&amp; <span class="hljs-built_in">isdir</span>(new_file)) {
        <span class="hljs-keyword">if</span> (!quiet) {
          <span class="hljs-built_in">output_error</span>(sysl, <span class="hljs-string">&quot;Watching new directory %s\n&quot;</span>, new_file);
        }
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">inotifytools_watch_recursively</span>(new_file, events)) {
          <span class="hljs-built_in">output_error</span>(sysl, <span class="hljs-string">&quot;Couldn't watch new directory %s: %s\n&quot;</span>, new_file,
                       <span class="hljs-built_in">strerror</span>(<span class="hljs-built_in">inotifytools_error</span>()));
        }
      }
      <span class="hljs-built_in">free</span>(new_file);
    } 

    <span class="hljs-comment">/*
     * ......
     */</span>
  }
  <span class="hljs-built_in">fflush</span>(<span class="hljs-literal">NULL</span>);
} <span class="hljs-keyword">while</span> (monitor)
</body></html></code></pre>
</div>

<p>
The program constantly polls and prints new events in the main function. If the newly created object is a directory and <code>--recursive</code> option is on, it recursively watch the newly created directory. However, it won't print files in the new directory if we check the <code>inotifytools_watch_recursively</code> function.
</p>
</div>
</div>
</div>
<div id="outline-container-conclusion" class="outline-2">
<a href="#conclusion"><h2 id="conclusion" class="cr-self-reference ">Conclusion</h2></a>
<div class="outline-text-2" id="text-conclusion">
<p>
There doesn't seem to a definitive solution to this issue. The workaround described in <a href="#the-workaround">section 2</a> seems to be good enough in my case. I will conclude this post by posing a simple example usage of the code with the workaround applied.
</p>

<div class="org-src-container">
<pre class="cr-highlighted"><code class="lang-clojure"><html><head></head><body>(<span class="hljs-name">deftest</span> wach_service_example
  (<span class="hljs-name">testing</span> <span class="hljs-string">&quot;&quot;</span>
    (<span class="hljs-name"><span class="hljs-built_in">let</span></span> [test-dir (<span class="hljs-name"><span class="hljs-built_in">str</span></span> *test-dir* <span class="hljs-string">&quot;/example&quot;</span>)]
      (<span class="hljs-name">.mkdirs</span> (<span class="hljs-name">io/file</span> test-dir))
      (<span class="hljs-name"><span class="hljs-built_in">let</span></span> [[resp cancel] (<span class="hljs-name">subject/watch</span> test-dir)
            worker (<span class="hljs-name"><span class="hljs-built_in">future</span></span>
                     (<span class="hljs-name"><span class="hljs-built_in">loop</span></span> [event (<span class="hljs-name">a/&lt;!!</span> resp)
                            result (<span class="hljs-name"><span class="hljs-built_in">transient</span></span> [])]
                       (<span class="hljs-name"><span class="hljs-built_in">if</span></span> (<span class="hljs-name"><span class="hljs-built_in">not</span></span> (<span class="hljs-name"><span class="hljs-built_in">nil?</span></span> event))
                         (<span class="hljs-name"><span class="hljs-built_in">recur</span></span> (<span class="hljs-name">a/&lt;!!</span> resp)
                                (<span class="hljs-name"><span class="hljs-built_in">conj!</span></span> result
                                       {<span class="hljs-symbol">:kind</span> (<span class="hljs-symbol">:kind</span> event)
                                        <span class="hljs-symbol">:path</span> (<span class="hljs-name">.toString</span> (<span class="hljs-symbol">:path</span> event))}))
                         (<span class="hljs-name"><span class="hljs-built_in">persistent!</span></span> result))))]
        (<span class="hljs-name">.sleep</span> java.util.concurrent.TimeUnit/MILLISECONDS <span class="hljs-number">200</span>)
        (<span class="hljs-name">.mkdirs</span> (<span class="hljs-name">io/file</span> (<span class="hljs-name"><span class="hljs-built_in">str</span></span> test-dir <span class="hljs-string">&quot;/s1/s2&quot;</span>)))
        (<span class="hljs-name">.createNewFile</span> (<span class="hljs-name">io/file</span> (<span class="hljs-name"><span class="hljs-built_in">str</span></span> test-dir <span class="hljs-string">&quot;/s1/s2/file&quot;</span>)))
        <span class="hljs-comment">;; We can't delete the files too quickly after they are created,</span>
        <span class="hljs-comment">;;    otherwise we will receive no event.</span>
        (<span class="hljs-name">.sleep</span> java.util.concurrent.TimeUnit/MILLISECONDS <span class="hljs-number">200</span>)
        (<span class="hljs-name"><span class="hljs-built_in">doseq</span></span> [f (<span class="hljs-name"><span class="hljs-built_in">reverse</span></span> (<span class="hljs-name"><span class="hljs-built_in">rest</span></span> (<span class="hljs-name">file-seq</span> (<span class="hljs-name">io/file</span> test-dir))))]
          (<span class="hljs-name">.delete</span> f))
        (<span class="hljs-name">.sleep</span> java.util.concurrent.TimeUnit/MILLISECONDS <span class="hljs-number">200</span>)
        <span class="hljs-comment">;; shutdown the watch service</span>
        (<span class="hljs-name">a/&gt;!!</span> cancel <span class="hljs-literal">true</span>)

        <span class="hljs-comment">;; verify the result</span>
        (<span class="hljs-name">is</span> (<span class="hljs-name"><span class="hljs-built_in">=</span></span> [{<span class="hljs-symbol">:kind</span> <span class="hljs-symbol">:entry-create</span><span class="hljs-punctuation">,</span>		  
                         <span class="hljs-symbol">:path</span> <span class="hljs-string">&quot;test/resource/watch_service_test/example/s1&quot;</span>}
                        {<span class="hljs-symbol">:kind</span> <span class="hljs-symbol">:entry-create</span><span class="hljs-punctuation">,</span>
                         <span class="hljs-symbol">:path</span> <span class="hljs-string">&quot;test/resource/watch_service_test/example/s1/s2&quot;</span>}
                        {<span class="hljs-symbol">:kind</span> <span class="hljs-symbol">:entry-create</span><span class="hljs-punctuation">,</span>
                         <span class="hljs-symbol">:path</span> <span class="hljs-string">&quot;test/resource/watch_service_test/example/s1/s2/file&quot;</span>}
                        {<span class="hljs-symbol">:kind</span> <span class="hljs-symbol">:entry-delete</span><span class="hljs-punctuation">,</span>
                         <span class="hljs-symbol">:path</span> <span class="hljs-string">&quot;test/resource/watch_service_test/example/s1/s2/file&quot;</span>}
                        {<span class="hljs-symbol">:kind</span> <span class="hljs-symbol">:entry-delete</span><span class="hljs-punctuation">,</span>
                         <span class="hljs-symbol">:path</span> <span class="hljs-string">&quot;test/resource/watch_service_test/example/s1/s2&quot;</span>}
                        {<span class="hljs-symbol">:kind</span> <span class="hljs-symbol">:entry-delete</span><span class="hljs-punctuation">,</span>
                         <span class="hljs-symbol">:path</span> <span class="hljs-string">&quot;test/resource/watch_service_test/example/s1&quot;</span>}]
               @worker))))))
</body></html></code></pre>
</div>

<p>
You can also find the source code and some unit tests <a href="https://gist.github.com/imakira/4b537a13ecd8c1816427068d10777565">here</a>.
</p>
</div>
</div>
</div><div class="mt-4"><div class="border-neutral-400 border-l-2 text-[1.05rem] 2xl:text-lg w-78 fixed right-0 top-[13.5rem] z-200 max-h-[80vh] overflow-y-auto select-none hidden md:block xl:top-36  2xl:w-96"><ul><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#the-problem"><span>The Problem</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#the-workaround"><span>The Workaround</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#how-is-it-handled-by-other-projects?"><span>How is it Handled by Other Projects?</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-8" href="#chokidar"><span>chokidar</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-8" href="#inotify-tools"><span>inotify-tools</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#conclusion"><span>Conclusion</span></a></div></div></div></li></ul></div></div></div></div></main></div></div><script>window.__server_path = "/"</script><script>window.__cerulean_rehydrate = true;</script><script>globalThis["blog/watching-files-with-java-nio-file-watchservice-and-clojure"] = {"blog/orgx":false,"blog/tags":[],"blog/unlisted":false,"blog/title":"Watching Files with java.nio.file.WatchService and Clojure","blog/show-toc?":true,"blog/file-path":"/home/void/Projects/imakira.github.io/blogs/watching-files-with-java.nio.file.WatchService-and-clojure.org","blog/author":null,"blog/email":null,"blog/description":"Recently I want to have a utility in Clojure that can notify me when there is a change happened in some specified directory. Fortunately Java seems to nati...","blog/id":"watching-files-with-java-nio-file-watchservice-and-clojure","blog/category":"Coding","blog/language":"en_US","blog/published-date":"2025-12-13T22:18:29+08:00","blog/content":"<p>\nRecently I want to have a utility in Clojure that can notify me when there is a change happened in some specified directory. Fortunately Java seems to natively support it by providing a <code>java.nio.file.WatchService</code>. It seems trivial so I want to use it directly in Clojure instead of adding another dependency to my project. It turns out to be sightly more complicated than I expected. Let me explain.\n</p>\n<div id=\"outline-container-the-problem\" class=\"outline-2\">\n<a href=\"#the-problem\"><h2 id=\"the-problem\" class=\"cr-self-reference \">The Problem</h2></a>\n<div class=\"outline-text-2\" id=\"text-the-problem\">\n<p>\nThe challenge mainly lies in the fact that, Java doesn't natively support recursively watching a directory. If we want this behavoir, we have to implement it ourselves.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-keyword\">def</span> ^<span class=\"hljs-symbol\">:dynamic</span> <span class=\"hljs-title\">*chan-size*</span> <span class=\"hljs-number\">512</span>)\n\n(<span class=\"hljs-keyword\">defn</span> <span class=\"hljs-title\">register</span> [^Path path ^WatchService watch-service]\n  (<span class=\"hljs-name\">.register</span> path\n             watch-service\n             (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> WatchEvent$Kind\n                         [StandardWatchEventKinds/ENTRY_CREATE\n                          StandardWatchEventKinds/ENTRY_DELETE\n                          StandardWatchEventKinds/ENTRY_MODIFY\n                          StandardWatchEventKinds/OVERFLOW])))\n\n(<span class=\"hljs-keyword\">defn</span> <span class=\"hljs-title\">watch</span> [&amp; paths]\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [resp-chan (<span class=\"hljs-name\">a/chan</span> *chan-size*)\n        cancel-chan (<span class=\"hljs-name\">a/chan</span> <span class=\"hljs-number\">1</span>)\n        stopped? (<span class=\"hljs-name\"><span class=\"hljs-built_in\">atom</span></span> <span class=\"hljs-literal\">false</span>)\n\n        worker\n        (<span class=\"hljs-name\"><span class=\"hljs-built_in\">future</span></span>\n          (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [paths (<span class=\"hljs-name\"><span class=\"hljs-built_in\">map</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">fn</span></span> [p]\n                             (<span class=\"hljs-name\">Path/of</span> p (<span class=\"hljs-name\"><span class=\"hljs-built_in\">into-array</span></span> String [])))\n                           paths)\n                watch-service (<span class=\"hljs-name\"><span class=\"hljs-built_in\">-&gt;</span></span> (<span class=\"hljs-name\">java.nio.file.FileSystems/getDefault</span>)\n                                  (<span class=\"hljs-name\">.newWatchService</span>))]\n            (<span class=\"hljs-name\"><span class=\"hljs-built_in\">doseq</span></span> [path paths]\n              (<span class=\"hljs-name\"><span class=\"hljs-built_in\">doseq</span></span> [^File subpath-file (<span class=\"hljs-name\">file-seq</span> (<span class=\"hljs-name\">.toFile</span> path))]\n                (<span class=\"hljs-name\"><span class=\"hljs-built_in\">when</span></span> (<span class=\"hljs-name\">.isDirectory</span> subpath-file)\n                  (<span class=\"hljs-name\">register</span> (<span class=\"hljs-name\">.toPath</span> subpath-file)\n                            watch-service))))\n            (<span class=\"hljs-name\"><span class=\"hljs-built_in\">try</span></span>\n              (<span class=\"hljs-name\"><span class=\"hljs-built_in\">while</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">not</span></span> @stopped?)\n                (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [watch-key (<span class=\"hljs-name\">.take</span> watch-service)\n                      events (<span class=\"hljs-name\">.pollEvents</span> watch-key)\n                      ^Path parent-dir (<span class=\"hljs-name\">.watchable</span> watch-key)]\n                  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">doseq</span></span> [^WatchEvent event events]\n                    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [^WatchEvent$Kind kind (<span class=\"hljs-name\">.kind</span> event)\n                          ^Path event-path (<span class=\"hljs-name\">.context</span> event)\n                          ^Path resolved-path (<span class=\"hljs-name\">.resolve</span> parent-dir event-path)]\n                      (<span class=\"hljs-name\">a/&gt;!!</span> resp-chan\n                             {<span class=\"hljs-symbol\">:kind</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">case</span></span> (<span class=\"hljs-name\">.name</span> kind)\n                                      <span class=\"hljs-string\">&quot;ENTRY_CREATE&quot;</span> <span class=\"hljs-symbol\">:entry-create</span>\n                                      <span class=\"hljs-string\">&quot;ENTRY_MODIFY&quot;</span> <span class=\"hljs-symbol\">:entry-modify</span>\n                                      <span class=\"hljs-string\">&quot;ENTRY_DELETE&quot;</span> <span class=\"hljs-symbol\">:entry-delete</span>\n                                      <span class=\"hljs-string\">&quot;OVERFLOW&quot;</span> <span class=\"hljs-symbol\">:overflow</span>)\n                              <span class=\"hljs-symbol\">:path</span> resolved-path})\n\n                      <span class=\"hljs-comment\">;; If the newly created object is a directory,</span>\n                      <span class=\"hljs-comment\">;;   we recursively register files in it.</span>\n                          (<span class=\"hljs-name\"><span class=\"hljs-built_in\">when</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">and</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">=</span></span> kind StandardWatchEventKinds/ENTRY_CREATE)\n                                 (<span class=\"hljs-name\">.isDirectory</span> (<span class=\"hljs-name\">.toFile</span> resolved-path)))\n                        (<span class=\"hljs-name\"><span class=\"hljs-built_in\">doseq</span></span> [^File subpath-file (<span class=\"hljs-name\">file-seq</span> (<span class=\"hljs-name\">.toFile</span> resolved-path))]\n                          (<span class=\"hljs-name\"><span class=\"hljs-built_in\">when</span></span> (<span class=\"hljs-name\">.isDirectory</span> subpath-file)\n                            (<span class=\"hljs-name\">register</span> (<span class=\"hljs-name\">.toPath</span> subpath-file)\n                                      watch-service))))\n                      (<span class=\"hljs-name\">.reset</span> watch-key)))))\n              (<span class=\"hljs-name\">catch</span> InterruptedException _)\n              (<span class=\"hljs-name\">finally</span>\n                (<span class=\"hljs-name\">.close</span> watch-service)))))\n\n        sentinel (<span class=\"hljs-name\"><span class=\"hljs-built_in\">future</span></span>\n                   (<span class=\"hljs-name\"><span class=\"hljs-built_in\">while</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">not</span></span> (<span class=\"hljs-name\">a/&lt;!!</span> cancel-chan)))\n                   (<span class=\"hljs-name\"><span class=\"hljs-built_in\">reset!</span></span> stopped? <span class=\"hljs-literal\">true</span>)\n                   (<span class=\"hljs-name\">future-cancel</span> worker)\n                   (<span class=\"hljs-name\">a/close!</span> resp-chan)\n                   (<span class=\"hljs-name\">a/close!</span> cancel-chan))]\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">with-meta</span></span> [resp-chan cancel-chan]\n      {<span class=\"hljs-symbol\">:debug</span> {<span class=\"hljs-symbol\">:worker</span> worker\n               <span class=\"hljs-symbol\">:sentinel</span> sentinel\n               <span class=\"hljs-symbol\">:stopped?</span> stopped?}})))\n</body></html></code></pre>\n</div>\n\n<p>\nThe initial implementation looks like this, which is fairly straightforward. We start by recursively registering files in the directories provided by <code>paths</code> argument, and if there is a newly created directory, we also recursively register its contents. Clojure provides a <code>file-seq</code> function that makes this task much easier. For an example usage of this code, check the end of this post.\n</p>\n\n<p>\nHowever, there is only one issue: If a file is created in a subdirectory before the subdirectory got registered, the event won't be fired.\n</p>\n\n<pre class=\"example\" id=\"org09005b9\">+---------------+\n| worker thread |\n+-------+-------+\n        +                 +---------------+\n        +-----------------| create subdir |\n        |                 +---------------+\n+-------+---------------+\n| event: subdir created |\n+-------+---------------+    \n        |                 +------------------------+\n        +-----------------+ new file in the subdir |\n        |                 +------------------------+\n+-------+-----------+\n| subdir registered |\n+-------------------+\n</pre>\n</div>\n</div>\n<div id=\"outline-container-the-workaround\" class=\"outline-2\">\n<a href=\"#the-workaround\"><h2 id=\"the-workaround\" class=\"cr-self-reference \">The Workaround</h2></a>\n<div class=\"outline-text-2\" id=\"text-the-workaround\">\n<p>\nWe can have a workaround of this by emitting an event of each file in the newly created directory, like this:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-name\"><span class=\"hljs-built_in\">when</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">and</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">=</span></span> kind StandardWatchEventKinds/ENTRY_CREATE)\n           (<span class=\"hljs-name\">.isDirectory</span> (<span class=\"hljs-name\">.toFile</span> resolved-path)))\n\n  (<span class=\"hljs-name\">register</span> resolved-path\n            watch-service)\n\n  (<span class=\"hljs-name\"><span class=\"hljs-built_in\">doseq</span></span> [^File subpath-file (<span class=\"hljs-name\"><span class=\"hljs-built_in\">rest</span></span> (<span class=\"hljs-name\">file-seq</span> (<span class=\"hljs-name\">.toFile</span> resolved-path)))]\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">when</span></span> (<span class=\"hljs-name\">.isDirectory</span> subpath-file)\n      (<span class=\"hljs-name\">register</span> (<span class=\"hljs-name\">.toPath</span> subpath-file)\n                watch-service))\n    (<span class=\"hljs-name\">a/&gt;!!</span> resp-chan\n           {<span class=\"hljs-symbol\">:kind</span> <span class=\"hljs-symbol\">:entry-create</span>\n            <span class=\"hljs-symbol\">:path</span> (<span class=\"hljs-name\">.toPath</span> subpath-file)})))\n</body></html></code></pre>\n</div>\n\n<p>\nHowever, it introduces a new problem. If a file is created in a subdirectory after be subdirectory is regsitered, but before the subdirectories scanning is finished. The event of the file may be emitted twice.\n</p>\n\n<pre class=\"example\" id=\"orgb332a07\">  +---------------+\n  | worker thread |\n  +-------+-------+\n          +                +----------------+\n          +----------------+ subdir created |\n          |                +----------------+\n          |\n +--------+----------+\n | subdir registered |\n +--------+----------+\n          |              +-------------------------+\n          |--------------+ file1 created in subdir |\n          |              +-------------------------+\n +--------+---------+\n | scan: find file1 |\n +--------+---------+  \n          |               \n          |               \n+---------+------------+ \n| event: file1 created |\n+----------------------+      \n</pre>\n\n<p>\nWe have three choices here, we can:\n</p>\n\n<ul class=\"org-ul\">\n<li>ignore this issue, treat it as something acceptable.</li>\n<li>discard the workaround all together, let the user scan if there is any new file in the newly created directory.</li>\n<li>memorize all the files detected, check if the event has already been fired if a new file is detected.</li>\n</ul>\n\n<p>\nIn my case, the first option is good enough, however, it got me curious about how this issue is handled by other projects.\n</p>\n</div>\n</div>\n<div id=\"outline-container-how-is-it-handled-by-other-projects?\" class=\"outline-2\">\n<a href=\"#how-is-it-handled-by-other-projects?\"><h2 id=\"how-is-it-handled-by-other-projects?\" class=\"cr-self-reference \">How is it Handled by Other Projects?</h2></a>\n<div class=\"outline-text-2\" id=\"text-how-is-it-handled-by-other-projects?\">\n</div>\n<div id=\"outline-container-chokidar\" class=\"outline-3\">\n<a href=\"#chokidar\"><h3 id=\"chokidar\" class=\"cr-self-reference \">chokidar</h3></a>\n<div class=\"outline-text-3\" id=\"text-chokidar\">\n<p>\n<a href=\"https://github.com/paulmillr/chokidar\">chokidar</a> is a famous file watching library in JavaScript. It seems to have chosen the third option:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-typescript\"><html><head></head><body><span class=\"hljs-comment\">// handler.ts</span>\n<span class=\"hljs-comment\">// line starting from 575</span>\n\n<span class=\"hljs-comment\">// Files that present in current directory snapshot</span>\n<span class=\"hljs-comment\">// but absent in previous are added to watch list and</span>\n<span class=\"hljs-comment\">// emit `add` event.</span>\n<span class=\"hljs-keyword\">if</span> (item === target || (!target &amp;&amp; !previous.<span class=\"hljs-title function_\">has</span>(item))) {\n  <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">fsw</span>.<span class=\"hljs-title function_\">_incrReadyCount</span>();\n\n  <span class=\"hljs-comment\">// ensure relativeness of path is preserved in case of watcher reuse</span>\n  path = sp.<span class=\"hljs-title function_\">join</span>(dir, sp.<span class=\"hljs-title function_\">relative</span>(dir, path));\n\n  <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">_addToNodeFs</span>(path, initialAdd, wh, depth + <span class=\"hljs-number\">1</span>);\n}\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-inotify-tools\" class=\"outline-3\">\n<a href=\"#inotify-tools\"><h3 id=\"inotify-tools\" class=\"cr-self-reference \">inotify-tools</h3></a>\n<div class=\"outline-text-3\" id=\"text-inotify-tools\">\n<p>\n<a href=\"https://github.com/inotify-tools/inotify-tools\">inotify-tools</a> is a set of cli tools providing interface to <code>inotify</code>. It was written in C++ and newer version is rewritten in Rust.\n</p>\n\n<p>\nBy default, <code>inotify-wait</code> quits after it detected a change. Therefore the problem described in the previous section is naturally up to the user to solve.\n</p>\n\n<p>\nIt also provides an <code>--monitor</code> option to continuously monitoring the changes happened in a directory. With <code>--monitor</code> on, it seems to choose the second option described in the previous section.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-bash\"><html><head></head><body>&gt; inotifywait -mr -e create .\n\nSetting up watches.  Beware: since -r was given, this may take a <span class=\"hljs-keyword\">while</span>!\nWatches established.\n\n<span class=\"hljs-comment\"># executing `mkdir -p s1/s2/s3/s4` in another shell session</span>\n\n./ CREATE,ISDIR s1\nWatching new directory ./s1/\n</body></html></code></pre>\n</div>\n\n<p>\nIf we create the directories one by one, all the directories will be notified. However, by using <code>-p</code> option to create multiple level of directories at once. Only the first one will be notified.\n</p>\n\n<p>\nWe can further confirm it by reading the source code:\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-cpp\"><html><head></head><body><span class=\"hljs-comment\">// inotifywait.cpp</span>\n<span class=\"hljs-comment\">// L391, main function</span>\n\n<span class=\"hljs-keyword\">do</span> {\n  event = <span class=\"hljs-built_in\">inotifytools_next_event</span>(timeout);\n\n  <span class=\"hljs-comment\">/*\n   * ......\n   */</span>\n\n  <span class=\"hljs-keyword\">if</span> (monitor &amp;&amp; recursive) {\n    <span class=\"hljs-keyword\">if</span> ((event-&gt;mask &amp; IN_CREATE) ||\n        (!moved_from &amp;&amp; (event-&gt;mask &amp; IN_MOVED_TO))) {\n      <span class=\"hljs-comment\">// New file - if it is a directory, watch it</span>\n      <span class=\"hljs-type\">char</span> *new_file = <span class=\"hljs-built_in\">inotifytools_dirpath_from_event</span>(event);\n      <span class=\"hljs-keyword\">if</span> (new_file &amp;&amp; *new_file &amp;&amp; <span class=\"hljs-built_in\">isdir</span>(new_file)) {\n        <span class=\"hljs-keyword\">if</span> (!quiet) {\n          <span class=\"hljs-built_in\">output_error</span>(sysl, <span class=\"hljs-string\">&quot;Watching new directory %s\\n&quot;</span>, new_file);\n        }\n        <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-built_in\">inotifytools_watch_recursively</span>(new_file, events)) {\n          <span class=\"hljs-built_in\">output_error</span>(sysl, <span class=\"hljs-string\">&quot;Couldn't watch new directory %s: %s\\n&quot;</span>, new_file,\n                       <span class=\"hljs-built_in\">strerror</span>(<span class=\"hljs-built_in\">inotifytools_error</span>()));\n        }\n      }\n      <span class=\"hljs-built_in\">free</span>(new_file);\n    } \n\n    <span class=\"hljs-comment\">/*\n     * ......\n     */</span>\n  }\n  <span class=\"hljs-built_in\">fflush</span>(<span class=\"hljs-literal\">NULL</span>);\n} <span class=\"hljs-keyword\">while</span> (monitor)\n</body></html></code></pre>\n</div>\n\n<p>\nThe program constantly polls and prints new events in the main function. If the newly created object is a directory and <code>--recursive</code> option is on, it recursively watch the newly created directory. However, it won't print files in the new directory if we check the <code>inotifytools_watch_recursively</code> function.\n</p>\n</div>\n</div>\n</div>\n<div id=\"outline-container-conclusion\" class=\"outline-2\">\n<a href=\"#conclusion\"><h2 id=\"conclusion\" class=\"cr-self-reference \">Conclusion</h2></a>\n<div class=\"outline-text-2\" id=\"text-conclusion\">\n<p>\nThere doesn't seem to a definitive solution to this issue. The workaround described in <a href=\"#the-workaround\">section 2</a> seems to be good enough in my case. I will conclude this post by posing a simple example usage of the code with the workaround applied.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-clojure\"><html><head></head><body>(<span class=\"hljs-name\">deftest</span> wach_service_example\n  (<span class=\"hljs-name\">testing</span> <span class=\"hljs-string\">&quot;&quot;</span>\n    (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [test-dir (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> *test-dir* <span class=\"hljs-string\">&quot;/example&quot;</span>)]\n      (<span class=\"hljs-name\">.mkdirs</span> (<span class=\"hljs-name\">io/file</span> test-dir))\n      (<span class=\"hljs-name\"><span class=\"hljs-built_in\">let</span></span> [[resp cancel] (<span class=\"hljs-name\">subject/watch</span> test-dir)\n            worker (<span class=\"hljs-name\"><span class=\"hljs-built_in\">future</span></span>\n                     (<span class=\"hljs-name\"><span class=\"hljs-built_in\">loop</span></span> [event (<span class=\"hljs-name\">a/&lt;!!</span> resp)\n                            result (<span class=\"hljs-name\"><span class=\"hljs-built_in\">transient</span></span> [])]\n                       (<span class=\"hljs-name\"><span class=\"hljs-built_in\">if</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">not</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">nil?</span></span> event))\n                         (<span class=\"hljs-name\"><span class=\"hljs-built_in\">recur</span></span> (<span class=\"hljs-name\">a/&lt;!!</span> resp)\n                                (<span class=\"hljs-name\"><span class=\"hljs-built_in\">conj!</span></span> result\n                                       {<span class=\"hljs-symbol\">:kind</span> (<span class=\"hljs-symbol\">:kind</span> event)\n                                        <span class=\"hljs-symbol\">:path</span> (<span class=\"hljs-name\">.toString</span> (<span class=\"hljs-symbol\">:path</span> event))}))\n                         (<span class=\"hljs-name\"><span class=\"hljs-built_in\">persistent!</span></span> result))))]\n        (<span class=\"hljs-name\">.sleep</span> java.util.concurrent.TimeUnit/MILLISECONDS <span class=\"hljs-number\">200</span>)\n        (<span class=\"hljs-name\">.mkdirs</span> (<span class=\"hljs-name\">io/file</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> test-dir <span class=\"hljs-string\">&quot;/s1/s2&quot;</span>)))\n        (<span class=\"hljs-name\">.createNewFile</span> (<span class=\"hljs-name\">io/file</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">str</span></span> test-dir <span class=\"hljs-string\">&quot;/s1/s2/file&quot;</span>)))\n        <span class=\"hljs-comment\">;; We can't delete the files too quickly after they are created,</span>\n        <span class=\"hljs-comment\">;;    otherwise we will receive no event.</span>\n        (<span class=\"hljs-name\">.sleep</span> java.util.concurrent.TimeUnit/MILLISECONDS <span class=\"hljs-number\">200</span>)\n        (<span class=\"hljs-name\"><span class=\"hljs-built_in\">doseq</span></span> [f (<span class=\"hljs-name\"><span class=\"hljs-built_in\">reverse</span></span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">rest</span></span> (<span class=\"hljs-name\">file-seq</span> (<span class=\"hljs-name\">io/file</span> test-dir))))]\n          (<span class=\"hljs-name\">.delete</span> f))\n        (<span class=\"hljs-name\">.sleep</span> java.util.concurrent.TimeUnit/MILLISECONDS <span class=\"hljs-number\">200</span>)\n        <span class=\"hljs-comment\">;; shutdown the watch service</span>\n        (<span class=\"hljs-name\">a/&gt;!!</span> cancel <span class=\"hljs-literal\">true</span>)\n\n        <span class=\"hljs-comment\">;; verify the result</span>\n        (<span class=\"hljs-name\">is</span> (<span class=\"hljs-name\"><span class=\"hljs-built_in\">=</span></span> [{<span class=\"hljs-symbol\">:kind</span> <span class=\"hljs-symbol\">:entry-create</span><span class=\"hljs-punctuation\">,</span>\t\t  \n                         <span class=\"hljs-symbol\">:path</span> <span class=\"hljs-string\">&quot;test/resource/watch_service_test/example/s1&quot;</span>}\n                        {<span class=\"hljs-symbol\">:kind</span> <span class=\"hljs-symbol\">:entry-create</span><span class=\"hljs-punctuation\">,</span>\n                         <span class=\"hljs-symbol\">:path</span> <span class=\"hljs-string\">&quot;test/resource/watch_service_test/example/s1/s2&quot;</span>}\n                        {<span class=\"hljs-symbol\">:kind</span> <span class=\"hljs-symbol\">:entry-create</span><span class=\"hljs-punctuation\">,</span>\n                         <span class=\"hljs-symbol\">:path</span> <span class=\"hljs-string\">&quot;test/resource/watch_service_test/example/s1/s2/file&quot;</span>}\n                        {<span class=\"hljs-symbol\">:kind</span> <span class=\"hljs-symbol\">:entry-delete</span><span class=\"hljs-punctuation\">,</span>\n                         <span class=\"hljs-symbol\">:path</span> <span class=\"hljs-string\">&quot;test/resource/watch_service_test/example/s1/s2/file&quot;</span>}\n                        {<span class=\"hljs-symbol\">:kind</span> <span class=\"hljs-symbol\">:entry-delete</span><span class=\"hljs-punctuation\">,</span>\n                         <span class=\"hljs-symbol\">:path</span> <span class=\"hljs-string\">&quot;test/resource/watch_service_test/example/s1/s2&quot;</span>}\n                        {<span class=\"hljs-symbol\">:kind</span> <span class=\"hljs-symbol\">:entry-delete</span><span class=\"hljs-punctuation\">,</span>\n                         <span class=\"hljs-symbol\">:path</span> <span class=\"hljs-string\">&quot;test/resource/watch_service_test/example/s1&quot;</span>}]\n               @worker))))))\n</body></html></code></pre>\n</div>\n\n<p>\nYou can also find the source code and some unit tests <a href=\"https://gist.github.com/imakira/4b537a13ecd8c1816427068d10777565\">here</a>.\n</p>\n</div>\n</div>\n","blog/orgx-require":null,"blog/modified-date":"2025-12-14T00:36:14+08:00"};</script><script defer="defer" src="/js/main.js" type="module"></script></body></html>