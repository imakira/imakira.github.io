<!DOCTYPE html><html class="no-js" lang="en"><head><meta charset="utf-8" /><meta content="ie=edge" http-equiv="x-ua-compatible" /><meta content="To build a ClojureScript application, we need to pull dependencies from two package managers. That is, JavaScript packages from  npm  and Clojure packages ..." name="description" /><meta content="width=device-width, initial-scale=1" name="viewport" /><title>Build a ClojureScript Application Running on Node Using Nix | Coruscation.net</title><link href="https://fonts.googleapis.com" rel="preconnect" /><link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" /><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&amp;display=swap" rel="stylesheet" /><link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&amp;icon_names=keyboard_arrow_down" rel="stylesheet" /><link href="/main.css?v=1768642818691" rel="stylesheet" /><link href="https://coruscation.net/atom.xml" rel="alternate" title="Coruscation.net" type="application/rss+xml" /><link href="/js/main.js" rel="modulepreload" /><link href="/js/./orgx.build-a-clojurescript-application-running-on-node-using-nix.js" rel="modulepreload" /></head><body><div id="root"><div class="app h-dvh w-full xl:grid xl:grid-cols-[20rem_9fr]"><div class="transition-all"><div class="bg-opacity-100 px-4 relative bg-[#0260B3] sm:flex sm:justify-between block gap-4 xl:grid xl:grid-cols-[2fr_3fr] xl:h-dvh xl:fixed xl:w-[20rem]"><a class="flex justify-center block" href="/"><span class="text-3xl text-cyan-50 pt-4 sm:py-6 xl:sideways-lr xl:text-6xl xl:pb-8">Coruscation.net</span></a><div class="flex justify-center"><div class="flex flex-col items-center justify-end py-1 relative left-[0.275rem] sm:items-end xl:justify-between"><div class="navigator-bar gap-3 text-base text-slate-50 opacity-80 flex px-5 my-2 xl:text-2xl xl:flex-col xl:pt-6"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300 group-hover:bg-yellow-400"></div><div class="relative w-full h-full"><div class="px-1 group-hover:text-cyan-50 text-lg"><a href="/">HOME</a></div></div></div><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300 group-hover:bg-yellow-400"></div><div class="relative w-full h-full"><div class="px-1 group-hover:text-cyan-50 text-lg"><a href="https://github.com/imakira">ABOUT</a></div></div></div><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300 group-hover:bg-yellow-400"></div><div class="relative w-full h-full"><div class="px-1 group-hover:text-cyan-50 text-lg"><a href="https://github.com/imakira">PROJECTS</a></div></div></div></div><div class="justify-center w-full mb-8 relative hidden xl:flex"><div class="flex relative"><a href="/atom.xml"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="40" height="32">&lt;!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc. --&gt;<path d="M64 32C28.7 32 0 60.7 0 96L0 416c0 35.3 28.7 64 64 64l320 0c35.3 0 64-28.7 64-64l0-320c0-35.3-28.7-64-64-64L64 32zM96 136c0-13.3 10.7-24 24-24c137 0 248 111 248 248c0 13.3-10.7 24-24 24s-24-10.7-24-24c0-110.5-89.5-200-200-200c-13.3 0-24-10.7-24-24zm0 96c0-13.3 10.7-24 24-24c83.9 0 152 68.1 152 152c0 13.3-10.7 24-24 24s-24-10.7-24-24c0-57.4-46.6-104-104-104c-13.3 0-24-10.7-24-24zm0 120a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"></path></svg></a><a href="https://github.com/imakira/cerulean"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" width="40" height="32">&lt;!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc. --&gt;<path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a href=""><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="40" height="32">&lt;!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc. --&gt;<path d="M64 32C28.7 32 0 60.7 0 96L0 416c0 35.3 28.7 64 64 64l320 0c35.3 0 64-28.7 64-64l0-320c0-35.3-28.7-64-64-64L64 32zM218 271.7L64.2 172.4C66 156.4 79.5 144 96 144l256 0c16.5 0 30 12.4 31.8 28.4L230 271.7c-1.8 1.2-3.9 1.8-6 1.8s-4.2-.6-6-1.8zm29.4 26.9L384 210.4 384 336c0 17.7-14.3 32-32 32L96 368c-17.7 0-32-14.3-32-32l0-125.6 136.6 88.2c7 4.5 15.1 6.9 23.4 6.9s16.4-2.4 23.4-6.9z"></path></svg></a></div></div></div></div></div></div><main class="pt-5 px-2 sm:px-4 xl:pt-7 xl:px-8"><div class="px-4 relative"><div><h1 class="font-medium text-neutral-700 leading-tight text-2xl sm:text-[2rem]">Build a ClojureScript Application Running on Node Using Nix</h1><hr class="border-t-1 border-slate-500 w-full my-3"/><div class="text-base grid items-center text-gray-700 pl-[1px] grid-cols-[7rem_1fr]"><div class="text-sky-700 border-l-2 pl-2 text-lg">Coding</div><span class="flex items-center gap-4"><span class="flex items-center gap-2"><span class="text-gray-600">Pub.</span><span class="text-base text-gray-700">Nov 03, 2025</span></span><span class="flex items-center gap-2"><span class="text-gray-600">Upd.</span><span class="text-base text-gray-700">Jan 17, 2026</span></span></span></div></div><div></div><input id="toc-mobile-control" class="hidden" type="checkbox"/><label class=" toc-header cursor-pointer select-none block text-sky-700 border-1 pl-2  flex justify-between items-center mt-3 bg-white sticky top-0 h-8 pr-1  md:hidden ml-[1px] relative " for="toc-mobile-control"><div class="relative h-full w-full overflow-hidden"><div class="text-lg toc-header-text relative  w-full transition-all "><div class="h-8 w-96">Table Of Content</div><div class="h-8 w-96 overflow-hidden">Prerequisites</div><div class="h-8 w-96 overflow-hidden">Prefetch and generate lock file for dependencies</div><div class="h-8 w-96 overflow-hidden">Build with shadow-cljs and  mkCljLib</div><div class="h-8 w-96 overflow-hidden">Package results as a npm package</div><div class="h-8 w-96 overflow-hidden">Tips</div></div></div><span class="material-symbols-outlined checked:rotate-180 transition-all dropdown-icon">keyboard_arrow_down</span></label><div class="toc-mobile-wrapper2 h-1 sticky top-8"><div class="grid toc-mobile-wrapper transition-all border-neutral-400 border-l-1 bg-white md:hidden ml-[1px] "><ul class="toc-mobile-content text-[1.05rem] 2xl:text-lg "><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#prerequisites"><span>Prerequisites</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#prefetch-and-generate-lock-file-for-dependencies"><span>Prefetch and generate lock file for dependencies</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#build-with-shadow-cljs-and-~mkcljlib~"><span>Build with shadow-cljs and  mkCljLib</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#package-results-as-a-npm-package"><span>Package results as a npm package</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#tips"><span>Tips</span></a></div></div></div></li></ul></div></div><div class="gap-8 w-full h-full md:grid md:grid-cols-[minmax(0px,7fr)_minmax(17rem,17rem)] 2xl:grid-cols-[minmax(0px,7fr)_minmax(20rem,20rem)]"><div class="cr-document md:mt-1"><p>
To build a ClojureScript application, we need to pull dependencies from two package managers. That is, JavaScript packages from <code>npm</code> and Clojure packages from <code>deps.edn</code>. After pulling the dependencies, we can then let <code>shadow-cljs</code> compiles the ClojureScript files into a single javascript and make the result a npm package. In this post, we rely on <code>nixpkgs</code>&#x27;s builtin <code>fetchNpmDeps</code> and <code>buildNpmPackage</code> for the npm side, and <a href="https://github.com/jlesquembre/clj-nix">clj-nix</a> for the nix side.
</p><div><blockquote class="not-italic bg-stone-50 pl-4 py-2 border-l-3  my-4 border-sky-500"><div class="not-italic font-semibold mb-1 text-gray-700">Note</div><div class="not-italic"><ul class="org-ul"><li><b>changelog</b>   Jan 17, 2026: use a new method to build the nix package, supports git repos, reduces output size.</li></ul></div></blockquote></div><div id="outline-container-prerequisites" class="outline-2"><a href="#prerequisites"><h2 id="prerequisites" class="cr-self-reference ">Prerequisites</h2></a><div id="text-prerequisites" class="outline-text-2"><p>
I will skip the details that are not unique to Nix. The following contents assume we already have a working shadow-cljs project that can produce a node.js target when running <code>npm run release</code>. Which is basically:
</p><ul class="org-ul"><li>a <code>:node-script</code> target in <code>shadow-cljs.edn</code>, with <code>:main</code> function specified</li><li>a <code>release</code> script in package.json, most probably <code>shadow-cljs release script</code></li><li>an entry script specified in <code>bin</code> in package.json.</li></ul></div></div><div id="outline-container-prefetch-and-generate-lock-file-for-dependencies" class="outline-2"><a href="#prefetch-and-generate-lock-file-for-dependencies"><h2 id="prefetch-and-generate-lock-file-for-dependencies" class="cr-self-reference ">Prefetch and generate lock file for dependencies</h2></a><div id="text-prefetch-and-generate-lock-file-for-dependencies" class="outline-text-2"><p>
During the <i>build</i> phase of nix package, the process cannot perform any network request, as that will defeat the whole point of <i>determinism</i>. The common practice is to use a <i>lock file</i>. Which is essentially a recipe of all the necessary resources (and their checksums) for the building process. We can then prefetch all the resources into the nix store and tell the building process where to find the necessary resources during the actual building.
</p><p>
On the npm side, we do it by running the following command. It will output a sha256 code, we save it for later.
</p><div class="org-src-container"><pre class="cr-highlighted"><code class="lang-bash">nix run nixpkgs#prefetch-npm-deps package-lock.json
</code></pre></div><p>
On the Clojure side, we execute the following command. It will generate a <code>deps-lock.json</code> file. We will refer it in the <code>flake.nix</code>.
</p><div class="org-src-container"><pre class="cr-highlighted"><code class="lang-bash">nix run github:jlesquembre/clj-nix#deps-lock
</code></pre></div></div></div><div id="outline-container-build-with-shadow-cljs-and-~mkcljlib~" class="outline-2"><a href="#build-with-shadow-cljs-and-~mkcljlib~"><h2 id="build-with-shadow-cljs-and-~mkcljlib~" class="cr-self-reference ">Build with shadow-cljs and <code>mkCljLib</code></h2></a><div id="text-build-with-shadow-cljs-and-~mkcljlib~" class="outline-text-2"><p>
We need to add <code>clj-nix</code>&#x27;s overlays to our flake.nix to be able to use <code>mkCljLib</code>.
</p><div class="org-src-container"><pre class="cr-highlighted"><code class="lang-nix">p<span class="hljs-attr">kgs</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">import</span> nixpkgs {
  <span class="hljs-keyword">inherit</span> system;
  <span class="hljs-attr">overlays</span> <span class="hljs-operator">=</span> [
    clj-nix.overlays.default
  ];
};
</code></pre></div><p>
First, we create a <code>node_modules</code> derivative which we will use later.
</p><div class="org-src-container"><pre class="cr-highlighted"><code class="lang-nix">d<span class="hljs-attr">eps-hash</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;deps-hash&quot;</span>;

<span class="hljs-attr">npm-deps</span> <span class="hljs-operator">=</span> pkgs.buildNpmPackage(<span class="hljs-params">finalAttrs:</span> {
  <span class="hljs-attr">src</span> <span class="hljs-operator">=</span> self;
  <span class="hljs-attr">pname</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;package-npm-deps&quot;</span>;
  <span class="hljs-attr">version</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;0.0&quot;</span>;
  <span class="hljs-attr">dontNpmBuild</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
  <span class="hljs-attr">npmDepsHash</span> <span class="hljs-operator">=</span> deps-hash;
  <span class="hljs-attr">installPhase</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;&#x27;
  mkdir $out
  cp -r ./node_modules $out/node_modules
  &#x27;&#x27;</span>;
});
</code></pre></div><p>
We will use <code>mkCljLib</code> to setup Clojure dependencies for us, while we copy JavaScript dependencies from the earlier step manually.
</p><div class="org-src-container"><pre class="cr-highlighted"><code class="lang-nix">b<span class="hljs-attr">uild</span> <span class="hljs-operator">=</span> pkgs.mkCljLib {
  <span class="hljs-attr">projectSrc</span> <span class="hljs-operator">=</span> self;
  <span class="hljs-attr">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;espoir&quot;</span>;
  <span class="hljs-attr">buildCommand</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;
  # copy node_modules from earlier step to build directory
  cp -r <span class="hljs-subst">${npm-deps}</span>/node_modules ./node_modules
  <span class="hljs-subst">${pkgs.nodejs}</span>/bin/npm run release
  &quot;</span>;
  <span class="hljs-attr">installPhase</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;&#x27;
  mkdir -p $out
  cp -R * $out/
  &#x27;&#x27;</span>;
};
</code></pre></div><p>
In the <code>buildCommand</code>, we setup the JavaScript dependencies, and call <code>npm run release</code> which in turn calls <code>shadow-cljs</code> to build the project.
</p><p>
In <code>installPhase</code>, we override the install process provided by <code>mkCljLib</code>. Instead, we simply use all the files in the build directory as output.
</p></div></div><div id="outline-container-package-results-as-a-npm-package" class="outline-2"><a href="#package-results-as-a-npm-package"><h2 id="package-results-as-a-npm-package" class="cr-self-reference ">Package results as a npm package</h2></a><div id="text-package-results-as-a-npm-package" class="outline-text-2"><p>
We can directly feed output from the earlier example to <code>builNpmPackage</code>. Since we already build the package, we will set <code>dontNpmBuild = true;</code>.
</p><p>
The install process provided by <code>buildNpmPackage</code> will package necessary dependencies and generate an executable calling the entry script. 
</p><div class="org-src-container"><pre class="cr-highlighted"><code class="lang-nix">p<span class="hljs-attr">ackages.default</span> <span class="hljs-operator">=</span> pkgs.buildNpmPackage {
  <span class="hljs-attr">pname</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;espoir&quot;</span>;
  <span class="hljs-attr">src</span> <span class="hljs-operator">=</span> build;
  <span class="hljs-attr">dontNpmBuild</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
  <span class="hljs-attr">version</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;0.0.1&quot;</span>;
  <span class="hljs-attr">npmDepsHash</span> <span class="hljs-operator">=</span> deps-hash;
};
</code></pre></div></div></div><div id="outline-container-tips" class="outline-2"><a href="#tips"><h2 id="tips" class="cr-self-reference ">Tips</h2></a><div id="text-tips" class="outline-text-2"><ul class="org-ul"><li>Check <a href="https://github.com/imakira/espoir/blob/main/flake.nix">imakira/espoir/blob/main/flake.nix</a> for a working example.</li></ul></div></div></div><div class="mt-4"><div class="border-neutral-400 border-l-2 text-[1.05rem] 2xl:text-lg w-78 fixed right-0 top-[13.5rem] z-200 max-h-[80vh] overflow-y-auto select-none hidden md:block xl:top-36  2xl:w-96"><ul><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#prerequisites"><span>Prerequisites</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#prefetch-and-generate-lock-file-for-dependencies"><span>Prefetch and generate lock file for dependencies</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#build-with-shadow-cljs-and-~mkcljlib~"><span>Build with shadow-cljs and  mkCljLib</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#package-results-as-a-npm-package"><span>Package results as a npm package</span></a></div></div></div></li><li class="my-1 list-inside text-neutral-600"><div class="relative group"><div class="absolute w-0 h-full group-hover:bg-sky-200 group-hover:bg-opacity-70 group-hover:w-full group-hover:h-full transition-all duration-300"></div><div class="relative w-full h-full"><div class="group w-full h-full"><a class="h-12 transition-all w-full h-full inline-block flex flex-col justify-center group-hover:text-[#0260B3] pl-4" href="#tips"><span>Tips</span></a></div></div></div></li></ul></div></div></div></div></main></div></div><script>window.__server_path = "/"</script><script>window.__cerulean_rehydrate = true;</script><script>globalThis["blog/build-a-clojurescript-application-running-on-node-using-nix"] = {"blog/orgx":true,"blog/tags":[],"blog/unlisted":false,"blog/title":"Build a ClojureScript Application Running on Node Using Nix","blog/show-toc?":true,"blog/file-path":"/home/void/Projects/imakira.github.io/blogs/build-a-clojurescript-application-running-on-node-using-nix.org","blog/author":null,"blog/email":null,"blog/description":"To build a ClojureScript application, we need to pull dependencies from two package managers. That is, JavaScript packages from  npm  and Clojure packages ...","blog/id":"build-a-clojurescript-application-running-on-node-using-nix","blog/category":"Coding","blog/language":"en_US","blog/published-date":"2025-11-03T17:25:27+08:00","blog/content":"<p>\nTo build a ClojureScript application, we need to pull dependencies from two package managers. That is, JavaScript packages from <code>npm</code> and Clojure packages from <code>deps.edn</code>. After pulling the dependencies, we can then let <code>shadow-cljs</code> compiles the ClojureScript files into a single javascript and make the result a npm package. In this post, we rely on <code>nixpkgs</code>'s builtin <code>fetchNpmDeps</code> and <code>buildNpmPackage</code> for the npm side, and <a href=\"https://github.com/jlesquembre/clj-nix\">clj-nix</a> for the nix side.\n</p>\n\n<pre class=\"orgx\" data-wrapper=\"use-comp\" data-wrapper-data=\"note\"><ul class=\"org-ul\">\n<li><b>changelog</b>   Jan 17, 2026: use a new method to build the nix package, supports git repos, reduces output size.</li>\n</ul>\n\n</pre>\n<div id=\"outline-container-prerequisites\" class=\"outline-2\">\n<a href=\"#prerequisites\"><h2 id=\"prerequisites\" class=\"cr-self-reference \">Prerequisites</h2></a>\n<div class=\"outline-text-2\" id=\"text-prerequisites\">\n<p>\nI will skip the details that are not unique to Nix. The following contents assume we already have a working shadow-cljs project that can produce a node.js target when running <code>npm run release</code>. Which is basically:\n</p>\n\n<ul class=\"org-ul\">\n<li>a <code>:node-script</code> target in <code>shadow-cljs.edn</code>, with <code>:main</code> function specified</li>\n<li>a <code>release</code> script in package.json, most probably <code>shadow-cljs release script</code></li>\n<li>an entry script specified in <code>bin</code> in package.json.</li>\n</ul>\n</div>\n</div>\n<div id=\"outline-container-prefetch-and-generate-lock-file-for-dependencies\" class=\"outline-2\">\n<a href=\"#prefetch-and-generate-lock-file-for-dependencies\"><h2 id=\"prefetch-and-generate-lock-file-for-dependencies\" class=\"cr-self-reference \">Prefetch and generate lock file for dependencies</h2></a>\n<div class=\"outline-text-2\" id=\"text-prefetch-and-generate-lock-file-for-dependencies\">\n<p>\nDuring the <i>build</i> phase of nix package, the process cannot perform any network request, as that will defeat the whole point of <i>determinism</i>. The common practice is to use a <i>lock file</i>. Which is essentially a recipe of all the necessary resources (and their checksums) for the building process. We can then prefetch all the resources into the nix store and tell the building process where to find the necessary resources during the actual building.\n</p>\n\n<p>\nOn the npm side, we do it by running the following command. It will output a sha256 code, we save it for later.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-bash\"><html><head></head><body>nix run nixpkgs#prefetch-npm-deps package-lock.json\n</body></html></code></pre>\n</div>\n\n<p>\nOn the Clojure side, we execute the following command. It will generate a <code>deps-lock.json</code> file. We will refer it in the <code>flake.nix</code>.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-bash\"><html><head></head><body>nix run github:jlesquembre/clj-nix#deps-lock\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-build-with-shadow-cljs-and-~mkcljlib~\" class=\"outline-2\">\n<a href=\"#build-with-shadow-cljs-and-~mkcljlib~\"><h2 id=\"build-with-shadow-cljs-and-~mkcljlib~\" class=\"cr-self-reference \">Build with shadow-cljs and <code>mkCljLib</code></h2></a>\n<div class=\"outline-text-2\" id=\"text-build-with-shadow-cljs-and-~mkcljlib~\">\n<p>\nWe need to add <code>clj-nix</code>'s overlays to our flake.nix to be able to use <code>mkCljLib</code>.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-nix\"><html><head></head><body>p<span class=\"hljs-attr\">kgs</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-built_in\">import</span> nixpkgs {\n  <span class=\"hljs-keyword\">inherit</span> system;\n  <span class=\"hljs-attr\">overlays</span> <span class=\"hljs-operator\">=</span> [\n    clj-nix.overlays.default\n  ];\n};\n</body></html></code></pre>\n</div>\n\n<p>\nFirst, we create a <code>node_modules</code> derivative which we will use later.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-nix\"><html><head></head><body>d<span class=\"hljs-attr\">eps-hash</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;deps-hash&quot;</span>;\n\n<span class=\"hljs-attr\">npm-deps</span> <span class=\"hljs-operator\">=</span> pkgs.buildNpmPackage(<span class=\"hljs-params\">finalAttrs:</span> {\n  <span class=\"hljs-attr\">src</span> <span class=\"hljs-operator\">=</span> self;\n  <span class=\"hljs-attr\">pname</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;package-npm-deps&quot;</span>;\n  <span class=\"hljs-attr\">version</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;0.0&quot;</span>;\n  <span class=\"hljs-attr\">dontNpmBuild</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-literal\">true</span>;\n  <span class=\"hljs-attr\">npmDepsHash</span> <span class=\"hljs-operator\">=</span> deps-hash;\n  <span class=\"hljs-attr\">installPhase</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">''\n  mkdir $out\n  cp -r ./node_modules $out/node_modules\n  ''</span>;\n});\n</body></html></code></pre>\n</div>\n\n<p>\nWe will use <code>mkCljLib</code> to setup Clojure dependencies for us, while we copy JavaScript dependencies from the earlier step manually.\n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-nix\"><html><head></head><body>b<span class=\"hljs-attr\">uild</span> <span class=\"hljs-operator\">=</span> pkgs.mkCljLib {\n  <span class=\"hljs-attr\">projectSrc</span> <span class=\"hljs-operator\">=</span> self;\n  <span class=\"hljs-attr\">name</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;espoir&quot;</span>;\n  <span class=\"hljs-attr\">buildCommand</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;\n  # copy node_modules from earlier step to build directory\n  cp -r <span class=\"hljs-subst\">${npm-deps}</span>/node_modules ./node_modules\n  <span class=\"hljs-subst\">${pkgs.nodejs}</span>/bin/npm run release\n  &quot;</span>;\n  <span class=\"hljs-attr\">installPhase</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">''\n  mkdir -p $out\n  cp -R * $out/\n  ''</span>;\n};\n</body></html></code></pre>\n</div>\n\n<p>\nIn the <code>buildCommand</code>, we setup the JavaScript dependencies, and call <code>npm run release</code> which in turn calls <code>shadow-cljs</code> to build the project.\n</p>\n\n<p>\nIn <code>installPhase</code>, we override the install process provided by <code>mkCljLib</code>. Instead, we simply use all the files in the build directory as output.\n</p>\n</div>\n</div>\n<div id=\"outline-container-package-results-as-a-npm-package\" class=\"outline-2\">\n<a href=\"#package-results-as-a-npm-package\"><h2 id=\"package-results-as-a-npm-package\" class=\"cr-self-reference \">Package results as a npm package</h2></a>\n<div class=\"outline-text-2\" id=\"text-package-results-as-a-npm-package\">\n<p>\nWe can directly feed output from the earlier example to <code>builNpmPackage</code>. Since we already build the package, we will set <code>dontNpmBuild = true;</code>.\n</p>\n\n<p>\nThe install process provided by <code>buildNpmPackage</code> will package necessary dependencies and generate an executable calling the entry script. \n</p>\n\n<div class=\"org-src-container\">\n<pre class=\"cr-highlighted\"><code class=\"lang-nix\"><html><head></head><body>p<span class=\"hljs-attr\">ackages.default</span> <span class=\"hljs-operator\">=</span> pkgs.buildNpmPackage {\n  <span class=\"hljs-attr\">pname</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;espoir&quot;</span>;\n  <span class=\"hljs-attr\">src</span> <span class=\"hljs-operator\">=</span> build;\n  <span class=\"hljs-attr\">dontNpmBuild</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-literal\">true</span>;\n  <span class=\"hljs-attr\">version</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;0.0.1&quot;</span>;\n  <span class=\"hljs-attr\">npmDepsHash</span> <span class=\"hljs-operator\">=</span> deps-hash;\n};\n</body></html></code></pre>\n</div>\n</div>\n</div>\n<div id=\"outline-container-tips\" class=\"outline-2\">\n<a href=\"#tips\"><h2 id=\"tips\" class=\"cr-self-reference \">Tips</h2></a>\n<div class=\"outline-text-2\" id=\"text-tips\">\n<ul class=\"org-ul\">\n<li>Check <a href=\"https://github.com/imakira/espoir/blob/main/flake.nix\">imakira/espoir/blob/main/flake.nix</a> for a working example.</li>\n</ul>\n</div>\n</div>\n","blog/orgx-require":null,"blog/modified-date":"2026-01-17T17:39:46+08:00"};</script><script src="/js/./orgx.build-a-clojurescript-application-running-on-node-using-nix.js" type="module"></script><script type="module">import * as exps  from '/js/./orgx.build-a-clojurescript-application-running-on-node-using-nix.js';
window['__orgx.build-a-clojurescript-application-running-on-node-using-nix'] = exps;</script><script defer="defer" src="/js/main.js" type="module"></script></body></html>